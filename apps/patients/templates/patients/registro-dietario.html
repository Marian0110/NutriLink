{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Registro Dietario 24 Horas{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'css/registro-dietario.css' %}">
{% endblock %}

{% block perfilcontent %}
<div class="registro-dietario-content patient-content">
  <h2>Registro de 24 horas</h2>

  <div class="registro-tabla-container">
    <table id="tabla-registro-comidas" class="registro-tabla">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Tiempo de Comida</th>
          <th>Alimento</th>
          <th>Medida Equiv. (1 porción)</th>
          <th>Porciones</th>
          <th>Gr (Masa Total)</th>
          <th>Kcal (Total)</th>
          <th>Proteínas (gr)</th>
          <th>Carbs (gr)</th>
          <th>Lípidos (gr)</th>
          <th>Omega 3 (gr)</th>
          <th>Vit. A (mcg)</th>
          <th>Vit. B12 (mcg)</th>
          <th>Ca (mg)</th>
          <th>Fe (mg)</th>
          <th>Se (mcg)</th>
          <th>Zn (mg)</th>
          <th>K (mg)</th>
          <th>Na (mg)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpo-tabla-registro">
        <!-- Fila inicial (se llenará dinámicamente) -->
        <tr>
          <td><input type="time" class="input-tabla input-hora" name="hora_0"></td>
          <td>
            <select name="tiempo_comida_0" class="select-tabla select-tiempo-comida">
              <option value="" selected disabled>Cargando...</option>
            </select>
          </td>
          <td>
            <select name="alimento_0" class="select-tabla select-alimento">
              <option value="" selected disabled>Cargando...</option>
            </select>
          </td>
          <td><input type="text" class="input-tabla input-medida-equiv" name="medida_equiv_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-porciones" name="porciones_0" min="0" step="0.1" value="1"></td>
          <td><input type="number" class="input-tabla input-numero input-gramos" name="gramos_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-kcal" name="kcal_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-proteinas" name="proteinas_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-carbohidratos" name="carbohidratos_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-lipidos" name="lipidos_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-n3" name="n3_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-vit_a" name="vit_a_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-vit_b12" name="vit_b12_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-calcio" name="calcio_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-hierro" name="hierro_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-selenio" name="selenio_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-zinc" name="zinc_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-potasio" name="potasio_0" readonly></td>
          <td><input type="number" class="input-tabla input-numero input-sodio" name="sodio_0" readonly></td>
          <td><button type="button" class="button-eliminar-fila">Eliminar</button></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="acciones-tabla">
    <button type="button" id="btn-anadir-fila" class="button-secondary">Añadir Registro de Comida</button>
  </div>

  <div class="notas-registro-container">
    <h3>Notas</h3>
    <textarea id="notas-adicionales" name="notas_adicionales" class="textarea-notas" rows="4" placeholder="Suplementos / agua consumida / etc."></textarea>
  </div>

  <div class="adecuacion-dieta-registro-container">
    <h3>Adecuación de la dieta</h3>
    <p style="font-style: italic; color: var(--light-text);">Los cálculos de adecuación aparecerán aquí una vez guardado el registro.</p>
  </div>

  <div class="acciones-pagina" style="margin-top: 30px; text-align: right;">
      <button type="button" id="btn-guardar-registro" class="button-primary">Guardar Registro de 24h</button>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const btnAnadirFila = document.getElementById('btn-anadir-fila');
    const cuerpoTabla = document.getElementById('cuerpo-tabla-registro');
    const btnGuardarRegistro = document.getElementById('btn-guardar-registro');
    let contadorFilas = 1;
    
    let listaTiemposComida = [];
    let listaAlimentosCompleta = []; // Almacenará todos los datos de los alimentos
    const datosAlimentoPorFila = new Map(); // Para asociar datos base del alimento a una fila

    // --- FUNCIÓN GENÉRICA PARA FETCH ---
    async function fetchAPI(url, nombreEntidad) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status} al obtener ${nombreEntidad}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Error al cargar ${nombreEntidad}:`, error);
            // Marcar selects como erróneos si es relevante
            const selects = document.querySelectorAll(nombreEntidad === 'tiempos de comida' ? '.select-tiempo-comida' : '.select-alimento');
            selects.forEach(select => {
                if (select.innerHTML.includes("Cargando...")) { // Solo si no ha sido poblado ya
                    select.innerHTML = `<option value="" disabled selected>Error al cargar ${nombreEntidad}</option>`;
                }
            });
            return [];
        }
    }

    // --- FUNCIÓN GENÉRICA PARA POBLAR SELECTS ---
    function populateSelect(selectElement, opciones, valorKey, textoKey, placeholderTexto = "Seleccionar...") {
        if (!selectElement || !opciones) {
            if(selectElement) selectElement.innerHTML = `<option value="" disabled selected>No hay opciones</option>`;
            return;
        }
        // Guardar el valor seleccionado si existe y el select ya tiene opciones (ej. al repoblar)
        const valorSeleccionadoActual = selectElement.options.length > 1 ? selectElement.value : null;

        selectElement.innerHTML = `<option value="" selected disabled>${placeholderTexto}</option>`;
        opciones.forEach(opcion => {
            const optionEl = document.createElement('option');
            optionEl.value = opcion[valorKey];
            optionEl.textContent = opcion[textoKey];
            selectElement.appendChild(optionEl);
        });
        // Restaurar selección si existía
        if (valorSeleccionadoActual && selectElement.querySelector(`option[value="${valorSeleccionadoActual}"]`)) {
            selectElement.value = valorSeleccionadoActual;
        }
    }

    // --- CARGA INICIAL DE DATOS ---
    listaTiemposComida = await fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id', 'tiempos de comida');
    listaAlimentosCompleta = await fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/alimentos', 'alimentos');

    // Poblar selects de la fila inicial
    const filaInicial = cuerpoTabla.querySelector('tr:first-child');
    if (filaInicial) {
        populateSelect(filaInicial.querySelector('.select-tiempo-comida'), listaTiemposComida, 'id_tiempo_comida', 'descripcion');
        populateSelect(filaInicial.querySelector('.select-alimento'), listaAlimentosCompleta, 'id_alimento', 'nombre_alimento', 'Seleccione alimento...');
    }

    // --- LÓGICA PARA ACTUALIZAR CAMPOS BASADA EN ALIMENTO Y PORCIONES ---
    function actualizarValoresNutricionalesFila(fila, alimentoData, porciones) {
        const numPorciones = parseFloat(porciones) || 0;

        if (alimentoData) {
            fila.querySelector('.input-medida-equiv').value = `${parseFloat(alimentoData.numero_medida).toFixed(2)} ${alimentoData.medida}`;
            
            const camposNutrientes = {
                '.input-gramos': alimentoData.masa,
                '.input-kcal': alimentoData.kcal,
                '.input-proteinas': alimentoData.proteinas_gr,
                '.input-carbohidratos': alimentoData.carbohidratos_gr,
                '.input-lipidos': alimentoData.lipidos_gr,
                '.input-n3': alimentoData.n3_gr,
                '.input-vit_a': alimentoData.vit_a_mcg,
                '.input-vit_b12': alimentoData.vit_b12_mcg,
                '.input-calcio': alimentoData.calcio_mg,
                '.input-hierro': alimentoData.hierro_mg,
                '.input-selenio': alimentoData.selenio_mcg,
                '.input-zinc': alimentoData.zinc_mg,
                '.input-potasio': alimentoData.potasio_mg,
                '.input-sodio': alimentoData.sodio_mg,
            };

            for (const selector in camposNutrientes) {
                const input = fila.querySelector(selector);
                const valorBase = parseFloat(camposNutrientes[selector]) || 0;
                input.value = (valorBase * numPorciones).toFixed(2); // Ajustar decimales según necesidad
                input.readOnly = true;
            }
             // Campos Gramos y Kcal también son readonly si hay alimento seleccionado
            fila.querySelector('.input-gramos').readOnly = true;
            fila.querySelector('.input-kcal').readOnly = true;

        } else { // No hay alimento seleccionado
            fila.querySelector('.input-medida-equiv').value = '';
            const camposLimpiar = [
                '.input-gramos', '.input-kcal', '.input-proteinas', '.input-carbohidratos', 
                '.input-lipidos', '.input-n3', '.input-vit_a', '.input-vit_b12', 
                '.input-calcio', '.input-hierro', '.input-selenio', '.input-zinc', 
                '.input-potasio', '.input-sodio'
            ];
            camposLimpiar.forEach(selector => {
                const input = fila.querySelector(selector);
                input.value = '';
                if (selector === '.input-gramos' || selector === '.input-kcal') {
                    input.readOnly = false; // Gramos y Kcal editables si no hay alimento
                } else {
                    input.readOnly = true; // Otros nutrientes siempre readonly y vacíos sin alimento
                }
            });
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    cuerpoTabla.addEventListener('change', (event) => {
        const target = event.target;
        const fila = target.closest('tr');
        if (!fila) return;

        if (target.classList.contains('select-alimento')) {
            const alimentoId = target.value;
            const porcionesInput = fila.querySelector('.input-porciones');
            const porciones = parseFloat(porcionesInput.value) || 1; // Default a 1 si no hay valor o es inválido

            if (alimentoId) {
                const alimentoSeleccionado = listaAlimentosCompleta.find(a => a.id_alimento.toString() === alimentoId);
                datosAlimentoPorFila.set(fila, alimentoSeleccionado); // Guardar datos base
                if (!porcionesInput.value) porcionesInput.value = "1"; // Poner 1 porción por defecto
                actualizarValoresNutricionalesFila(fila, alimentoSeleccionado, porcionesInput.value || "1");
            } else {
                datosAlimentoPorFila.delete(fila); // Eliminar datos base
                actualizarValoresNutricionalesFila(fila, null, 0); // Limpiar campos
            }
        }
    });

    cuerpoTabla.addEventListener('input', (event) => {
        const target = event.target;
        const fila = target.closest('tr');
        if (!fila) return;

        if (target.classList.contains('input-porciones')) {
            const alimentoData = datosAlimentoPorFila.get(fila);
            const porciones = parseFloat(target.value);
            if (alimentoData) { // Solo recalcular si hay un alimento base seleccionado
                 actualizarValoresNutricionalesFila(fila, alimentoData, isNaN(porciones) ? 0 : porciones);
            } else if (!isNaN(porciones) && porciones > 0) {
                // Si el usuario pone porciones pero no ha seleccionado alimento,
                // podría alertar o simplemente no hacer nada con los nutrientes.
                // Por ahora, los campos Gramos y Kcal son editables si no hay alimento.
            }
        }
    });


    if (btnAnadirFila) {
        btnAnadirFila.addEventListener('click', () => {
            const nuevaFila = document.createElement('tr');
            const suffix = contadorFilas;
            nuevaFila.innerHTML = `
                <td><input type="time" class="input-tabla input-hora" name="hora_${suffix}"></td>
                <td><select name="tiempo_comida_${suffix}" class="select-tabla select-tiempo-comida"><option value="" selected disabled>Seleccionar...</option></select></td>
                <td><select name="alimento_${suffix}" class="select-tabla select-alimento"><option value="" selected disabled>Seleccione alimento...</option></select></td>
                <td><input type="text" class="input-tabla input-medida-equiv" name="medida_equiv_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-porciones" name="porciones_${suffix}" min="0" step="0.1" value="1"></td>
                <td><input type="number" class="input-tabla input-numero input-gramos" name="gramos_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-kcal" name="kcal_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-proteinas" name="proteinas_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-carbohidratos" name="carbohidratos_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-lipidos" name="lipidos_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-n3" name="n3_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-vit_a" name="vit_a_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-vit_b12" name="vit_b12_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-calcio" name="calcio_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-hierro" name="hierro_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-selenio" name="selenio_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-zinc" name="zinc_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-potasio" name="potasio_${suffix}" readonly></td>
                <td><input type="number" class="input-tabla input-numero input-sodio" name="sodio_${suffix}" readonly></td>
                <td><button type="button" class="button-eliminar-fila">Eliminar</button></td>
            `;
            cuerpoTabla.appendChild(nuevaFila);
            populateSelect(nuevaFila.querySelector('.select-tiempo-comida'), listaTiemposComida, 'id_tiempo_comida', 'descripcion');
            populateSelect(nuevaFila.querySelector('.select-alimento'), listaAlimentosCompleta, 'id_alimento', 'nombre_alimento', 'Seleccione alimento...');
            
            // Asegurar que los campos de la nueva fila estén correctamente readonly/editable al inicio
            actualizarValoresNutricionalesFila(nuevaFila, null, 0);
            
            contadorFilas++;
        });
    }

    if (cuerpoTabla) {
        cuerpoTabla.addEventListener('click', (event) => {
            if (event.target.classList.contains('button-eliminar-fila')) {
                const filaAEliminar = event.target.closest('tr');
                if (cuerpoTabla.rows.length > 1) {
                    datosAlimentoPorFila.delete(filaAEliminar); // Limpiar datos asociados
                    filaAEliminar.remove();
                } else {
                    // Limpiar la última fila en lugar de eliminarla
                    filaAEliminar.querySelectorAll('input[type="time"], input[type="text"], input[type="number"]').forEach(input => input.value = '');
                    filaAEliminar.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
                    filaAEliminar.querySelector('.input-porciones').value = "1"; // Reset porciones
                    datosAlimentoPorFila.delete(filaAEliminar);
                    actualizarValoresNutricionalesFila(filaAEliminar, null, 0); // Resetear estado readonly/editable y valores
                }
            }
        });
    }

    if (btnGuardarRegistro) {
        btnGuardarRegistro.addEventListener('click', () => {
            console.log("Guardando registro...");
            const filasData = [];
            let esValidoGeneral = true;

            cuerpoTabla.querySelectorAll('tr').forEach(fila => {
                const horaInput = fila.querySelector('.input-hora');
                const tiempoComidaSelect = fila.querySelector('.select-tiempo-comida');
                const alimentoSelect = fila.querySelector('.select-alimento');
                // Solo procesar filas que tengan al menos hora y tiempo de comida.
                // Si se seleccionó un alimento, también debería estar presente.
                // O si se ingresaron gramos/kcal manualmente (en caso de no seleccionar alimento).
                
                let filaTieneDatosMinimos = false;
                if (horaInput.value && tiempoComidaSelect.value) {
                    if (alimentoSelect.value) { // Si hay alimento, es dato mínimo
                        filaTieneDatosMinimos = true;
                    } else { // Si no hay alimento, verificar si hay Gr o Kcal manuales
                        const grManual = fila.querySelector('.input-gramos').value;
                        const kcalManual = fila.querySelector('.input-kcal').value;
                        if (grManual || kcalManual) {
                            filaTieneDatosMinimos = true;
                        }
                    }
                }


                if (filaTieneDatosMinimos) {
                    let filaValidaLocal = true;
                    [horaInput, tiempoComidaSelect].forEach(el => {
                        if (!el.value) {
                            el.style.borderColor = 'red';
                            filaValidaLocal = false;
                            esValidoGeneral = false;
                        } else {
                            el.style.borderColor = '';
                        }
                    });
                     // Si no hay alimento seleccionado, pero sí hora y tiempo, es válido si hay Gr/Kcal.
                    if (!alimentoSelect.value && !(fila.querySelector('.input-gramos').value || fila.querySelector('.input-kcal').value)) {
                        // No es error si el usuario aún no ha completado, pero no se guarda esta parte
                        // Opcionalmente marcar alimentoSelect si se considera obligatorio siempre.
                        // Por ahora, lo permitimos si hay gr/kcal manuales.
                    }


                    if (filaValidaLocal) {
                        const filaData = {
                            hora: horaInput.value,
                            id_tiempo_comida: tiempoComidaSelect.value,
                            tiempo_comida_descripcion: tiempoComidaSelect.selectedOptions[0]?.text || '',
                            id_alimento: alimentoSelect.value,
                            alimento_descripcion: alimentoSelect.selectedOptions[0]?.text || '',
                            medida_equiv_api: fila.querySelector('.input-medida-equiv').value,
                            porciones: fila.querySelector('.input-porciones').value,
                            gramos_total: fila.querySelector('.input-gramos').value,
                            kcal_total: fila.querySelector('.input-kcal').value,
                            proteinas_total: fila.querySelector('.input-proteinas').value,
                            carbohidratos_total: fila.querySelector('.input-carbohidratos').value,
                            lipidos_total: fila.querySelector('.input-lipidos').value,
                            n3_total: fila.querySelector('.input-n3').value,
                            vit_a_total: fila.querySelector('.input-vit_a').value,
                            vit_b12_total: fila.querySelector('.input-vit_b12').value,
                            calcio_total: fila.querySelector('.input-calcio').value,
                            hierro_total: fila.querySelector('.input-hierro').value,
                            selenio_total: fila.querySelector('.input-selenio').value,
                            zinc_total: fila.querySelector('.input-zinc').value,
                            potasio_total: fila.querySelector('.input-potasio').value,
                            sodio_total: fila.querySelector('.input-sodio').value,
                        };
                        filasData.push(filaData);
                    }
                }
            });

            if (!esValidoGeneral) {
                alert("Por favor, complete los campos obligatorios (Hora, Tiempo de Comida) en todas las filas con datos.");
                return;
            }
            if (filasData.length === 0) {
                alert("No hay registros de comida completos para guardar.");
                return;
            }

            const notas = document.getElementById('notas-adicionales').value;
            const payload = {
                registros: filasData,
                notas: notas
                // paciente_id: TU_PACIENTE_ID // Si es necesario
            };
            console.log("Payload a enviar:", JSON.stringify(payload, null, 2));
            alert("Datos listos para enviar (ver consola). Implementar el fetch al backend aquí.");
            // Implementar fetch POST aquí
        });
    }
});
</script>
{% endblock %}