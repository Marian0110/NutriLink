{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Registro Dietario 24 Horas{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'css/registro-dietario.css' %}">
{% endblock %}

{% block perfilcontent %}
<div class="registro-dietario-content patient-content">
  <h2>Registro de 24 horas</h2>

  <div class="registro-tabla-container">
    <table id="tabla-registro-comidas" class="registro-tabla">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Tiempo de Comida</th>
          <th>Medida Equiv. (1 porción)</th>
          <th>Porciones</th>
          <th>Alimento</th>
          <th>Gr</th>
          <th>Kcal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpo-tabla-registro">
        <!-- Fila inicial (el select de tiempo de comida se llenará dinámicamente) -->
        <tr>
          <td><input type="time" class="input-tabla" name="hora_0"></td>
          <td>
            <select name="tiempo_comida_0" class="select-tabla select-tiempo-comida">
              <option value="" selected disabled>Cargando tiempos...</option>
              <!-- Opciones se cargarán desde JS -->
            </select>
          </td>
          <td><input type="text" class="input-tabla" name="medida_porcion_0" placeholder="Ej: 1 taza, 100g"></td>
          <td><input type="number" class="input-tabla input-numero" name="porciones_0" min="0" step="0.1" placeholder="0"></td>
          <td>
            <select name="alimento_0" class="select-tabla select-alimento">
              <option value="" selected disabled>Seleccionar...</option>
              <!-- Aquí idealmente se cargarían alimentos desde la BD o API -->
              <option value="manzana">Manzana</option>
              <option value="pollo_asado">Pollo Asado</option>
              <option value="arroz_blanco">Arroz Blanco</option>
              <option value="lentejas">Lentejas</option>
              <option value="yogurt_natural">Yogurt Natural</option>
            </select>
          </td>
          <td><input type="number" class="input-tabla input-numero" name="gramos_0" min="0" placeholder="0"></td>
          <td><input type="number" class="input-tabla input-numero" name="kcal_0" min="0" placeholder="0"></td>
          <td><button type="button" class="button-eliminar-fila">Eliminar</button></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="acciones-tabla">
    <button type="button" id="btn-anadir-fila" class="button-secondary">Añadir Registro de Comida</button>
  </div>

  <div class="notas-registro-container">
    <h3>Notas</h3>
    <textarea id="notas-adicionales" name="notas_adicionales" class="textarea-notas" rows="4" placeholder="Suplementos / agua consumida / etc."></textarea>
  </div>

  <div class="adecuacion-dieta-registro-container">
    <h3>Adecuación de la dieta</h3>
    <p style="font-style: italic; color: var(--light-text);">Los cálculos de adecuación aparecerán aquí una vez guardado el registro.</p>
  </div>

  <div class="acciones-pagina" style="margin-top: 30px; text-align: right;">
      <button type="button" id="btn-guardar-registro" class="button-primary">Guardar Registro de 24h</button>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', async () => { // Hacemos el callback async
    const btnAnadirFila = document.getElementById('btn-anadir-fila');
    const cuerpoTabla = document.getElementById('cuerpo-tabla-registro');
    const btnGuardarRegistro = document.getElementById('btn-guardar-registro');
    let contadorFilas = 1; // Inicia en 1 ya que la fila 0 es la de ejemplo
    let listaTiemposComida = []; // Para almacenar los tiempos de comida

    // --- FUNCIÓN PARA OBTENER TIEMPOS DE COMIDA ---
    async function fetchTiemposComida() {
        try {
            const response = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id');
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status} al obtener tiempos de comida`);
            }
            const data = await response.json();
            listaTiemposComida = data; // Guardar los datos
            return data;
        } catch (error) {
            console.error("Error al cargar tiempos de comida:", error);
            // Podrías mostrar un mensaje al usuario aquí
            const selectsTiempoComida = document.querySelectorAll('.select-tiempo-comida');
            selectsTiempoComida.forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Error al cargar</option>';
            });
            return []; // Retorna array vacío en caso de error
        }
    }

    // --- FUNCIÓN PARA POBLAR UN SELECT DE TIEMPO DE COMIDA ---
    function populateTiempoComidaSelect(selectElement, tiempos) {
        if (!selectElement || !tiempos || tiempos.length === 0) {
            if(selectElement) selectElement.innerHTML = '<option value="" disabled selected>No hay opciones</option>';
            return;
        }
        selectElement.innerHTML = '<option value="" selected disabled>Seleccionar...</option>'; // Limpiar y añadir placeholder
        tiempos.forEach(tiempo => {
            const option = document.createElement('option');
            option.value = tiempo.id_tiempo_comida; // Usamos el ID como valor
            option.textContent = tiempo.descripcion;
            selectElement.appendChild(option);
        });
    }

    // --- INICIALIZACIÓN ---
    // Cargar tiempos de comida al inicio y poblar el select inicial
    await fetchTiemposComida(); // Esperar a que se carguen los tiempos
    const selectInicial = cuerpoTabla.querySelector('tr:first-child .select-tiempo-comida');
    if (selectInicial) {
        populateTiempoComidaSelect(selectInicial, listaTiemposComida);
    }


    // --- EVENT LISTENERS ---
    if (btnAnadirFila && cuerpoTabla) {
        btnAnadirFila.addEventListener('click', () => {
            const nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td><input type="time" class="input-tabla" name="hora_${contadorFilas}"></td>
                <td>
                    <select name="tiempo_comida_${contadorFilas}" class="select-tabla select-tiempo-comida">
                        <!-- Opciones se cargarán desde JS -->
                    </select>
                </td>
                <td><input type="text" class="input-tabla" name="medida_porcion_${contadorFilas}" placeholder="Ej: 1 taza, 100g"></td>
                <td><input type="number" class="input-tabla input-numero" name="porciones_${contadorFilas}" min="0" step="0.1" placeholder="0"></td>
                <td>
                    <select name="alimento_${contadorFilas}" class="select-tabla select-alimento">
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="manzana">Manzana</option>
                        <option value="pollo_asado">Pollo Asado</option>
                        <option value="arroz_blanco">Arroz Blanco</option>
                        <option value="lentejas">Lentejas</option>
                        <option value="yogurt_natural">Yogurt Natural</option>
                    </select>
                </td>
                <td><input type="number" class="input-tabla input-numero" name="gramos_${contadorFilas}" min="0" placeholder="0"></td>
                <td><input type="number" class="input-tabla input-numero" name="kcal_${contadorFilas}" min="0" placeholder="0"></td>
                <td><button type="button" class="button-eliminar-fila">Eliminar</button></td>
            `;
            cuerpoTabla.appendChild(nuevaFila);

            // Poblar el nuevo select de tiempo de comida
            const nuevoSelectTiempoComida = nuevaFila.querySelector('.select-tiempo-comida');
            if (nuevoSelectTiempoComida) {
                populateTiempoComidaSelect(nuevoSelectTiempoComida, listaTiemposComida);
            }
            contadorFilas++;
        });

        cuerpoTabla.addEventListener('click', (event) => {
            if (event.target.classList.contains('button-eliminar-fila')) {
                if (cuerpoTabla.rows.length > 1) {
                    event.target.closest('tr').remove();
                } else {
                    const ultimaFila = cuerpoTabla.rows[0];
                    ultimaFila.querySelectorAll('input, select').forEach(input => {
                        if(input.tagName === 'SELECT') input.selectedIndex = 0; // Resetea a "Seleccionar..." o "Cargando..."
                        else input.value = '';
                    });
                    // Si el select es de tiempo de comida, repoblarlo por si se borró al resetear
                    const selectTiempo = ultimaFila.querySelector('.select-tiempo-comida');
                    if (selectTiempo) {
                        populateTiempoComidaSelect(selectTiempo, listaTiemposComida);
                    }
                }
            }
        });
    }

    if (btnGuardarRegistro) {
        btnGuardarRegistro.addEventListener('click', () => {
            console.log("Guardando registro...");
            
            const filasData = [];
            const filasInvalidas = [];
            let esValido = true;

            cuerpoTabla.querySelectorAll('tr').forEach((fila, index) => {
                const horaInput = fila.querySelector('input[name^="hora_"]');
                const tiempoComidaSelect = fila.querySelector('select[name^="tiempo_comida_"]');
                // Podrías añadir más validaciones aquí (ej. alimento seleccionado, alguna cantidad)

                let filaValida = true;
                if (!horaInput.value) {
                    horaInput.style.borderColor = 'red';
                    filaValida = false;
                } else {
                    horaInput.style.borderColor = '';
                }

                if (!tiempoComidaSelect.value) {
                    tiempoComidaSelect.style.borderColor = 'red';
                    filaValida = false;
                } else {
                    tiempoComidaSelect.style.borderColor = '';
                }

                // Si al menos un campo de cantidad (porciones, gr, kcal) tiene valor, considerar la fila para guardar.
                // Esto evita guardar filas completamente vacías accidentalmente.
                const porciones = fila.querySelector('input[name^="porciones_"]').value;
                const gramos = fila.querySelector('input[name^="gramos_"]').value;
                const kcal = fila.querySelector('input[name^="kcal_"]').value;

                if (horaInput.value || tiempoComidaSelect.value || porciones || gramos || kcal) { // Solo procesar si hay algún dato
                    if (!filaValida) {
                        esValido = false;
                        filasInvalidas.push(index + 1); // +1 para que sea human-readable
                    }

                    const filaData = {
                        hora: horaInput.value,
                        id_tiempo_comida: tiempoComidaSelect.value, // Guardamos el ID
                        tiempo_comida_descripcion: tiempoComidaSelect.selectedOptions.length > 0 ? tiempoComidaSelect.selectedOptions[0].text : '',
                        medida_porcion: fila.querySelector('input[name^="medida_porcion_"]').value,
                        porciones: porciones,
                        id_alimento: fila.querySelector('select[name^="alimento_"]').value,
                        alimento_descripcion: fila.querySelector('select[name^="alimento_"]').selectedOptions.length > 0 ? fila.querySelector('select[name^="alimento_"]').selectedOptions[0].text : '',
                        gramos: gramos,
                        kcal: kcal,
                    };
                    filasData.push(filaData);
                }
            });

            if (!esValido) {
                alert(`Por favor, complete los campos obligatorios (Hora, Tiempo de Comida) en la(s) fila(s): ${filasInvalidas.join(', ')}.`);
                return;
            }
            
            if (filasData.length === 0) {
                alert("No hay registros de comida para guardar. Por favor, añada al menos uno.");
                return;
            }

            const notas = document.getElementById('notas-adicionales').value;
            const payload = {
                registros: filasData,
                notas: notas
                // Aquí podrías añadir el ID del paciente si es necesario para el backend
                // paciente_id: TU_PACIENTE_ID
            };
            console.log("Payload a enviar:", JSON.stringify(payload, null, 2));
            alert("Datos listos para enviar (ver consola). Implementar el fetch al backend aquí.");

            // Aquí iría el fetch POST al backend
            // fetch('/api/guardar_registro_dietario', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': getCookie('csrftoken') // Si usas Django CSRF
            //     },
            //     body: JSON.stringify(payload)
            // })
            // .then(response => response.json())
            // .then(data => {
            //     console.log('Respuesta del servidor:', data);
            //     alert('Registro guardado exitosamente!');
            // })
            // .catch(error => {
            //     console.error('Error al guardar:', error);
            //     alert('Error al guardar el registro.');
            // });
        });
    }

    // Función para obtener cookies (si usas Django CSRF)
    // function getCookie(name) {
    //     let cookieValue = null;
    //     if (document.cookie && document.cookie !== '') {
    //         const cookies = document.cookie.split(';');
    //         for (let i = 0; i < cookies.length; i++) {
    //             const cookie = cookies[i].trim();
    //             if (cookie.substring(0, name.length + 1) === (name + '=')) {
    //                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
    //                 break;
    //             }
    //         }
    //     }
    //     return cookieValue;
    // }

});
</script>
{% endblock %}