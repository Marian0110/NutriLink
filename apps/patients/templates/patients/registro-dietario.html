{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Registro Dietario 24 Horas{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'css/registro-dietario.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
{% endblock %}

{% block perfilcontent %}
<div class="registro-dietario-content patient-content">
  <h2>Registro de 24 horas</h2>

  <input type="hidden" id="paciente-id" value="{{ paciente.id_paciente }}">
  {% csrf_token %}

  <div class="registro-selector-container" style="margin-bottom: 20px;">
    <label for="registro-date-selector">Seleccionar registros anteriores:</label>
    <select id="registro-date-selector" class="registro-date-selector">
      <option value="" selected disabled>Cargando fechas disponibles...</option>
    </select>
  </div>

  <div id="adecuacion-registro-section" style="margin-bottom: 25px;">
    <h3>Resumen Nutricional y Adecuación</h3>
    <div class="grafico-adecuacion-container">
        {% if grafico_adecuacion_html %}
            {{ grafico_adecuacion_html|safe }}
        {% else %}
            <p>Seleccione un registro o guarde uno nuevo para ver el gráfico de adecuación.</p>
        {% endif %}
    </div>
    <div id="adecuacion-status">Los cálculos de adecuación aparecerán aquí una vez guardado el registro o al cargar datos.</div>
  </div>

  <div id="tiempos-comida-container">
    <!-- Los bloques de tiempo de comida se añadirán aquí dinámicamente -->
  </div>

  <div class="acciones-pagina" style="margin-top: 20px; margin-bottom: 25px; display: flex; gap: 10px;">
    <button type="button" id="btn-anadir-tiempo-comida" class="button-secondary">Añadir Tiempo de Comida</button>
    <button type="button" id="btn-guardar-registro-completo" class="button-primary">Guardar y Calcular Adecuación</button>
  </div>

  <div class="notas-registro-container">
    <h3>Notas</h3>
    <textarea id="notas-generales-registro" name="notas_generales_registro" class="textarea-notas" rows="4" placeholder="Suplementos / agua consumida / etc."></textarea>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const pacienteId = document.getElementById('paciente-id').value;
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    const tiemposComidaContainer = document.getElementById('tiempos-comida-container');
    const btnAnadirTiempoComida = document.getElementById('btn-anadir-tiempo-comida');
    const btnGuardarRegistroCompleto = document.getElementById('btn-guardar-registro-completo');
    const notasGeneralesTextarea = document.getElementById('notas-generales-registro');
    const adecuacionStatusDiv = document.getElementById('adecuacion-status');
    const registroDateSelectorEl = document.getElementById('registro-date-selector');
    let graficoAdecuacionContainerEl = document.querySelector('.grafico-adecuacion-container');


    let ALL_TIEMPOS_COMIDA_DATA = [];
    let ALL_ALIMENTOS_DATA = [];
    const datosAlimentoPorFilaDOM = new Map();
    let mealTimeBlockCounter = 0;
    let isViewingHistoricalRegistro = false;

    async function fetchAPI(url, entityName, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                let errorDetail = `Error HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorDetail = errorData.mensaje || errorData.detail || JSON.stringify(errorData);
                } catch (e) { 
                    errorDetail = response.statusText || errorDetail;
                }
                throw new Error(errorDetail);
            }
            if (response.status === 204) return null; 
            return await response.json();
        } catch (error) {
            console.error(`Excepción en fetchAPI para ${entityName} (${url}):`, error);
            throw error;
        }
    }
    
    function populateSelect(selectElement, opciones, valorKey, textoKey, placeholderTexto = "Seleccionar...", currentValue = null, disabled = false) {
        const valorSeleccionadoAntes = currentValue !== null ? currentValue : selectElement.value;
        selectElement.innerHTML = `<option value="" ${!valorSeleccionadoAntes ? 'selected' : ''} disabled>${placeholderTexto}</option>`;
        
        if (!opciones || opciones.length === 0) {
             selectElement.innerHTML += `<option value="" disabled>No hay opciones</option>`;
             return;
        }
        opciones.forEach(opcion => {
            const optionEl = document.createElement('option');
            optionEl.value = opcion[valorKey];
            optionEl.textContent = opcion[textoKey];
            if (opcion.fecha_dieta) {
                optionEl.dataset.fechaDieta = opcion.fecha_dieta;
            }
            selectElement.appendChild(optionEl);
        });
        
        if (valorSeleccionadoAntes && selectElement.querySelector(`option[value="${valorSeleccionadoAntes}"]`)) {
            selectElement.value = valorSeleccionadoAntes;
        } else if (selectElement.options.length > 1 && !selectElement.value) {
             // selectElement.selectedIndex = 0; // No seleccionar por defecto si no hay valor previo
        }
        selectElement.disabled = disabled;
    }

    async function cargarDatosBase() { 
        try {
            [ALL_TIEMPOS_COMIDA_DATA, ALL_ALIMENTOS_DATA] = await Promise.all([
                fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id', 'tiempos de comida'),
                fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/alimentos', 'alimentos')
            ]);
            if (ALL_ALIMENTOS_DATA) {
                ALL_ALIMENTOS_DATA.sort((a, b) => a.nombre_alimento.localeCompare(b.nombre_alimento));
            }
        } catch (error) {
            if (btnAnadirTiempoComida) btnAnadirTiempoComida.disabled = true;
            if (btnGuardarRegistroCompleto) btnGuardarRegistroCompleto.disabled = true;
            Swal.fire('Error Crítico', `No se pudieron cargar los datos base (alimentos/tiempos): ${error.message}. La página no funcionará correctamente.`, 'error');
        }
    }
    
    function actualizarValoresNutricionalesFilaAlimento(filaAlimento, alimentoData, porciones) { 
        const numPorciones = parseFloat(porciones) || 0;
        const inputs = {
            medidaEquiv: filaAlimento.querySelector('.input-medida-equiv'),
            gramos: filaAlimento.querySelector('.input-gramos'),
            kcal: filaAlimento.querySelector('.input-kcal'),
            proteinas: filaAlimento.querySelector('.input-proteinas'),
            carbohidratos: filaAlimento.querySelector('.input-carbohidratos'),
            lipidos: filaAlimento.querySelector('.input-lipidos'),
            n3: filaAlimento.querySelector('.input-n3'),
            vitA: filaAlimento.querySelector('.input-vit_a'),
            vitB12: filaAlimento.querySelector('.input-vit_b12'),
            calcio: filaAlimento.querySelector('.input-calcio'),
            hierro: filaAlimento.querySelector('.input-hierro'),
            selenio: filaAlimento.querySelector('.input-selenio'),
            zinc: filaAlimento.querySelector('.input-zinc'),
            potasio: filaAlimento.querySelector('.input-potasio'),
            sodio: filaAlimento.querySelector('.input-sodio'),
        };

        if (alimentoData && inputs.medidaEquiv) { 
            inputs.medidaEquiv.value = `${parseFloat(alimentoData.numero_medida).toFixed(2)} ${alimentoData.medida}`;
            const camposBase = {
                gramos: alimentoData.masa, kcal: alimentoData.kcal, proteinas: alimentoData.proteinas_gr,
                carbohidratos: alimentoData.carbohidratos_gr, lipidos: alimentoData.lipidos_gr, n3: alimentoData.n3_gr,
                vitA: alimentoData.vit_a_mcg, vitB12: alimentoData.vit_b12_mcg, calcio: alimentoData.calcio_mg,
                hierro: alimentoData.hierro_mg, selenio: alimentoData.selenio_mcg, zinc: alimentoData.zinc_mg,
                potasio: alimentoData.potasio_mg, sodio: alimentoData.sodio_mg,
            };
            for (const key in camposBase) {
                if (inputs[key]) {
                    const valorBase = parseFloat(camposBase[key]) || 0;
                    inputs[key].value = (valorBase * numPorciones).toFixed(2);
                    inputs[key].readOnly = true;
                }
            }
            if(inputs.gramos) inputs.gramos.readOnly = true;
            if(inputs.kcal) inputs.kcal.readOnly = true;

        } else {
            if(inputs.medidaEquiv) inputs.medidaEquiv.value = '';
            Object.values(inputs).forEach(input => {
                if (input && input !== inputs.medidaEquiv) input.value = '';
            });
            if(inputs.gramos) inputs.gramos.readOnly = false;
            if(inputs.kcal) inputs.kcal.readOnly = false;
            Object.entries(inputs).forEach(([key, input]) => {
                if (input && key !== 'medidaEquiv' && key !== 'gramos' && key !== 'kcal') {
                    input.readOnly = true;
                }
            });
        }
    }

    function createMealTimeBlock(tiempoComidaIdPreselect = null, horaPreselect = "", alimentosPreselect = []) {
        const blockId = `mtb-${mealTimeBlockCounter++}`;
        const blockDiv = document.createElement('div');
        blockDiv.classList.add('tiempo-comida-block');
        blockDiv.dataset.blockId = blockId;
        blockDiv.dataset.tiempoId = tiempoComidaIdPreselect || '';
        blockDiv.dataset.hora = horaPreselect || '';

        const headerDiv = document.createElement('div');
        headerDiv.classList.add('tiempo-comida-header');

        const selectTiempoComida = document.createElement('select');
        selectTiempoComida.classList.add('select-tabla', 'select-tiempo-comida-block');
        selectTiempoComida.name = `tiempo_comida_block_${blockId}`;
        
        const inputHora = document.createElement('input');
        inputHora.type = 'time';
        inputHora.classList.add('input-tabla', 'input-hora-block');
        inputHora.name = `hora_block_${blockId}`;
        inputHora.value = horaPreselect;

        inputHora.addEventListener('change', () => {
            if (isViewingHistoricalRegistro) return;
            blockDiv.dataset.hora = inputHora.value;
            reorderMealTimeBlocksByTime();
        });

        selectTiempoComida.addEventListener('change', () => {
            if (isViewingHistoricalRegistro) return;
            blockDiv.dataset.tiempoId = selectTiempoComida.value;
            updateAllMealTimeSelects();
        });

        headerDiv.appendChild(document.createTextNode('Tiempo: '));
        headerDiv.appendChild(selectTiempoComida);
        headerDiv.appendChild(document.createTextNode(' Hora: '));
        headerDiv.appendChild(inputHora);
        blockDiv.appendChild(headerDiv);

        const tablaScrollContainer = document.createElement('div');
        tablaScrollContainer.style.overflowX = 'auto';

        const tablaAlimentos = document.createElement('table');
        tablaAlimentos.classList.add('alimentos-tabla-block', 'registro-tabla');
        tablaAlimentos.innerHTML = `
            <thead>
                <tr>
                    <th>Alimento</th><th>Acciones</th><th>Medida Equiv.</th><th>Porciones</th><th>Gr</th><th>Kcal</th>
                    <th>Prot.</th><th>Carbs</th><th>Lip.</th><th>N-3</th><th>Vit.A</th><th>Vit.B12</th>
                    <th>Ca</th><th>Fe</th><th>Se</th><th>Zn</th><th>K</th><th>Na</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        tablaScrollContainer.appendChild(tablaAlimentos);
        blockDiv.appendChild(tablaScrollContainer);
        const tbodyAlimentos = tablaAlimentos.querySelector('tbody');

        if (alimentosPreselect && alimentosPreselect.length > 0) {
            alimentosPreselect.forEach(alimento => {
                addFoodRowToMealTimeBlock(tbodyAlimentos, blockId, alimento.alimento_id_alimento, parseFloat(alimento.numero_porciones_dieta));
            });
        } else {
            addFoodRowToMealTimeBlock(tbodyAlimentos, blockId);
        }

        const accionesBloqueDiv = document.createElement('div');
        accionesBloqueDiv.classList.add('acciones-bloque');

        const btnAnadirAlimento = document.createElement('button');
        btnAnadirAlimento.type = 'button';
        btnAnadirAlimento.classList.add('button-secondary');
        btnAnadirAlimento.textContent = 'Añadir Alimento a este Tiempo';
        btnAnadirAlimento.addEventListener('click', () => {
            if (isViewingHistoricalRegistro) return;
            addFoodRowToMealTimeBlock(tbodyAlimentos, blockId)
        });

        const btnEliminarBloque = document.createElement('button');
        btnEliminarBloque.type = 'button';
        btnEliminarBloque.classList.add('button-eliminar-fila');
        btnEliminarBloque.textContent = 'Eliminar Tiempo';
        btnEliminarBloque.addEventListener('click', () => {
            if (isViewingHistoricalRegistro) return;
            handleDeleteMealTimeBlock(blockDiv)
        });
        
        accionesBloqueDiv.appendChild(btnAnadirAlimento);
        accionesBloqueDiv.appendChild(btnEliminarBloque);
        blockDiv.appendChild(accionesBloqueDiv);

        tiemposComidaContainer.appendChild(blockDiv);
        populateSelect(selectTiempoComida, ALL_TIEMPOS_COMIDA_DATA, 'id_tiempo_comida', 'descripcion', 'Seleccionar Tiempo...', tiempoComidaIdPreselect, isViewingHistoricalRegistro);
        
        // Aplicar estado editable después de crear el bloque
        toggleEditableStateRegistro(!isViewingHistoricalRegistro);

        return blockDiv;
    }

    function addFoodRowToMealTimeBlock(tbodyAlimentos, blockId, alimentoIdPreselect = null, porcionesPreselect = 1) {
        const foodRowId = `food-${blockId}-${tbodyAlimentos.rows.length}`;
        const nuevaFilaAlimento = tbodyAlimentos.insertRow();
        nuevaFilaAlimento.dataset.foodRowId = foodRowId;

        const cellAlimento = nuevaFilaAlimento.insertCell();
        cellAlimento.classList.add('cell-alimento-dropdown-container');

        const dropdownContainer = document.createElement('div');
        dropdownContainer.classList.add('alimento-searchable-dropdown');

        const dropdownButton = document.createElement('button');
        dropdownButton.type = 'button';
        dropdownButton.classList.add('alimento-dropdown-button');
        dropdownButton.textContent = 'Seleccione alimento...';

        const dropdownPanel = document.createElement('div');
        dropdownPanel.classList.add('alimento-dropdown-panel');

        const inputFiltroPanel = document.createElement('input');
        inputFiltroPanel.type = 'text';
        inputFiltroPanel.classList.add('input-tabla', 'input-filtro-alimento-panel');
        inputFiltroPanel.placeholder = 'Buscar...';

        const optionsList = document.createElement('ul');
        optionsList.classList.add('alimento-options-list');

        dropdownPanel.appendChild(inputFiltroPanel);
        dropdownPanel.appendChild(optionsList);

        const hiddenSelect = document.createElement('select');
        hiddenSelect.name = `alimento_${foodRowId}`;
        hiddenSelect.style.display = 'none';
        hiddenSelect.classList.add('select-alimento-hidden');

        dropdownContainer.appendChild(dropdownButton);
        dropdownContainer.appendChild(dropdownPanel);
        dropdownContainer.appendChild(hiddenSelect);
        cellAlimento.appendChild(dropdownContainer);

        function populateOptionsList(alimentosToShow, selectedValue) {
            optionsList.innerHTML = '';
            if (alimentosToShow.length === 0) {
                const noResultsLi = document.createElement('li');
                noResultsLi.classList.add('no-results');
                noResultsLi.textContent = 'No se encontraron alimentos.';
                optionsList.appendChild(noResultsLi);
                return;
            }
            alimentosToShow.forEach(alimento => {
                const li = document.createElement('li');
                li.classList.add('alimento-option-item');
                li.textContent = alimento.nombre_alimento;
                li.dataset.value = alimento.id_alimento;
                if (alimento.id_alimento.toString() === selectedValue) {
                    li.classList.add('selected-item');
                }
                li.addEventListener('click', () => {
                    if (isViewingHistoricalRegistro) return;
                    hiddenSelect.value = alimento.id_alimento;
                    dropdownButton.textContent = alimento.nombre_alimento;
                    inputFiltroPanel.value = alimento.nombre_alimento;
                    dropdownPanel.classList.remove('visible');
                    hiddenSelect.dispatchEvent(new Event('change', { bubbles: true }));
                });
                optionsList.appendChild(li);
            });
        }

        inputFiltroPanel.addEventListener('input', () => {
            if (isViewingHistoricalRegistro) return;
            const filtro = inputFiltroPanel.value.toLowerCase().trim();
            const alimentosFiltrados = ALL_ALIMENTOS_DATA.filter(alimento =>
                alimento.nombre_alimento.toLowerCase().includes(filtro)
            );
            populateOptionsList(alimentosFiltrados, hiddenSelect.value);
        });

        dropdownButton.addEventListener('click', (e) => {
            if (isViewingHistoricalRegistro) return;
            e.stopPropagation();
            document.querySelectorAll('.alimento-dropdown-panel.visible').forEach(panel => {
                if (panel !== dropdownPanel) panel.classList.remove('visible');
            });
            dropdownPanel.classList.toggle('visible');
            if (dropdownPanel.classList.contains('visible')) {
                inputFiltroPanel.focus();
                const filtroActual = inputFiltroPanel.value.toLowerCase().trim();
                const alimentosAMostrar = filtroActual ?
                    ALL_ALIMENTOS_DATA.filter(a => a.nombre_alimento.toLowerCase().includes(filtroActual)) :
                    ALL_ALIMENTOS_DATA;
                populateOptionsList(alimentosAMostrar, hiddenSelect.value);
            }
        });

        const cellAcciones = nuevaFilaAlimento.insertCell();
        const btnEliminarAlimentoRow = document.createElement('button');
        btnEliminarAlimentoRow.type = 'button';
        btnEliminarAlimentoRow.classList.add('button-eliminar-fila', 'button-eliminar-alimento');
        btnEliminarAlimentoRow.textContent = 'Eliminar';
        cellAcciones.appendChild(btnEliminarAlimentoRow);

        const otherCellsHTML = `
            <td><input type="text" class="input-tabla input-medida-equiv" name="medida_equiv_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-porciones" name="porciones_${foodRowId}" min="0" step="0.1" value="${porcionesPreselect}"></td>
            <td><input type="number" class="input-tabla input-numero input-gramos" name="gramos_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-kcal" name="kcal_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-proteinas" name="proteinas_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-carbohidratos" name="carbohidratos_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-lipidos" name="lipidos_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-n3" name="n3_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-vit_a" name="vit_a_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-vit_b12" name="vit_b12_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-calcio" name="calcio_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-hierro" name="hierro_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-selenio" name="selenio_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-zinc" name="zinc_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-potasio" name="potasio_${foodRowId}" readonly></td>
            <td><input type="number" class="input-tabla input-numero input-sodio" name="sodio_${foodRowId}" readonly></td>
        `;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = `<table><tr>${otherCellsHTML}</tr></table>`;
        Array.from(tempDiv.querySelector('tr').cells).forEach(cell => {
            nuevaFilaAlimento.appendChild(cell);
        });

        populateSelect(hiddenSelect, ALL_ALIMENTOS_DATA, 'id_alimento', 'nombre_alimento', 'Seleccione alimento...', alimentoIdPreselect, isViewingHistoricalRegistro);

        if (alimentoIdPreselect) {
            const alimentoData = ALL_ALIMENTOS_DATA.find(a => a.id_alimento.toString() === alimentoIdPreselect.toString());
            if (alimentoData) {
                dropdownButton.textContent = alimentoData.nombre_alimento;
                inputFiltroPanel.value = alimentoData.nombre_alimento;
                hiddenSelect.value = alimentoIdPreselect;
                datosAlimentoPorFilaDOM.set(nuevaFilaAlimento, alimentoData);
                actualizarValoresNutricionalesFilaAlimento(nuevaFilaAlimento, alimentoData, porcionesPreselect);
            } else {
                actualizarValoresNutricionalesFilaAlimento(nuevaFilaAlimento, null, porcionesPreselect);
            }
        } else {
            actualizarValoresNutricionalesFilaAlimento(nuevaFilaAlimento, null, porcionesPreselect);
        }
        
        // Aplicar estado editable después de crear la fila
        toggleEditableStateRegistro(!isViewingHistoricalRegistro);
    }

    document.addEventListener('click', (e) => {
        const openPanels = document.querySelectorAll('.alimento-dropdown-panel.visible');
        openPanels.forEach(panel => {
            const dropdownContainer = panel.closest('.alimento-searchable-dropdown');
            if (dropdownContainer && !dropdownContainer.contains(e.target)) {
                panel.classList.remove('visible');
            }
        });
    });

    function getSelectedMealTimeIdsDOM() {
        const selected = [];
        tiemposComidaContainer.querySelectorAll('.select-tiempo-comida-block').forEach(select => {
            if (select.value && select.value !== "") selected.push(parseInt(select.value));
        });
        return selected;
    }

    function updateAllMealTimeSelects() {
        const allBlockSelects = tiemposComidaContainer.querySelectorAll('.select-tiempo-comida-block');
        const overallSelectedIds = getSelectedMealTimeIdsDOM();

        allBlockSelects.forEach(currentSelect => {
            const blockDiv = currentSelect.closest('.tiempo-comida-block');
            const currentValueForThisSelect = blockDiv.dataset.tiempoId ? parseInt(blockDiv.dataset.tiempoId) : null;

            const availableForThisSelect = ALL_TIEMPOS_COMIDA_DATA.filter(time => {
                return time.id_tiempo_comida === currentValueForThisSelect ||
                       !overallSelectedIds.some(id => id === time.id_tiempo_comida && id !== currentValueForThisSelect);
            });

            const currentlySelectedValueInDOM = currentSelect.value;
            populateSelect(currentSelect, availableForThisSelect, 'id_tiempo_comida', 'descripcion', 'Seleccionar Tiempo...', currentValueForThisSelect, isViewingHistoricalRegistro);

            if (currentValueForThisSelect && currentSelect.value != currentValueForThisSelect) {
                 if (availableForThisSelect.some(opt => opt.id_tiempo_comida == currentValueForThisSelect)) {
                    currentSelect.value = currentValueForThisSelect;
                 } else if (currentlySelectedValueInDOM && availableForThisSelect.some(opt => opt.id_tiempo_comida.toString() === currentlySelectedValueInDOM)) {
                    currentSelect.value = currentlySelectedValueInDOM;
                    blockDiv.dataset.tiempoId = currentlySelectedValueInDOM;
                 } else {
                    blockDiv.dataset.tiempoId = "";
                    if (currentSelect.options.length > 0) currentSelect.selectedIndex = 0; // Default a placeholder
                 }
            } else if (!currentValueForThisSelect && currentSelect.value !== "") {
                blockDiv.dataset.tiempoId = currentSelect.value;
            }
        });
        updateAddMealButtonState();
    }

    function updateAddMealButtonState() {
        if (!btnAnadirTiempoComida || !ALL_TIEMPOS_COMIDA_DATA) return;
        
        if (isViewingHistoricalRegistro) {
            btnAnadirTiempoComida.style.display = 'none';
            // btnAnadirTiempoComida.disabled = true; // Redundante si está oculto
            return;
        }

        const numBloquesActuales = tiemposComidaContainer.querySelectorAll('.tiempo-comida-block').length;
        const numTotalTiemposComida = ALL_TIEMPOS_COMIDA_DATA.length;

        if (ALL_TIEMPOS_COMIDA_DATA.length > 0 && numBloquesActuales < numTotalTiemposComida) {
            btnAnadirTiempoComida.style.display = 'inline-block';
            btnAnadirTiempoComida.disabled = false;
        } else {
            btnAnadirTiempoComida.style.display = 'none';
            // btnAnadirTiempoComida.disabled = true; // Redundante si está oculto
        }
    }

    async function handleDeleteMealTimeBlock(blockDiv) {
        if (isViewingHistoricalRegistro) {
            Swal.fire('Acción no permitida', 'No se pueden eliminar tiempos de comida de un registro histórico.', 'warning');
            return;
        }
        const tiempoComidaId = blockDiv.dataset.tiempoId;
        const nombreTiempoComida = ALL_TIEMPOS_COMIDA_DATA.find(tc => tc.id_tiempo_comida.toString() === tiempoComidaId)?.descripcion || `ID ${tiempoComidaId}`;

        if (!tiempoComidaId) { // Bloque no guardado aún
            blockDiv.remove();
            updateAllMealTimeSelects();
            reorderMealTimeBlocksByTime();
            Swal.fire('Eliminado localmente', 'El tiempo de comida (aún no guardado) se ha quitado de la vista.', 'info');
            return;
        }

        const result = await Swal.fire({
            title: `¿Eliminar "${nombreTiempoComida}"?`,
            text: "Se eliminarán todos los alimentos registrados para este tiempo de comida en la base de datos. Esta acción no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminarlo',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            Swal.fire({
                title: 'Eliminando...',
                text: `Eliminando todos los registros para ${nombreTiempoComida}.`,
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const url = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/borrar_detalle_tiempo_comida?pacienteId=${pacienteId}&tiempoComidaId=${tiempoComidaId}`;
                const response = await fetchAPI(url, `registros de ${nombreTiempoComida}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken }
                });

                if (response && response.status === 'success') {
                    Swal.fire('¡Eliminado!', response.mensaje || `${nombreTiempoComida} y sus alimentos han sido eliminados.`, 'success');
                    blockDiv.querySelectorAll('tr[data-food-row-id]').forEach(foodRow => datosAlimentoPorFilaDOM.delete(foodRow));
                    blockDiv.remove();
                    updateAllMealTimeSelects();
                    reorderMealTimeBlocksByTime();
                    await cargarYMostrarResumenNutricionalYDetalles(registroDateSelectorEl.value === "current" ? null : registroDateSelectorEl.value, 
                                                                  registroDateSelectorEl.value === "current" ? null : registroDateSelectorEl.options[registroDateSelectorEl.selectedIndex].dataset.fechaDieta);
                } else {
                    throw new Error(response.mensaje || `No se pudo eliminar ${nombreTiempoComida}.`);
                }
            } catch (error) {
                Swal.fire('Error', `Error al eliminar ${nombreTiempoComida}: ${error.message}`, 'error');
            }
        }
    }

    async function handleDeleteFoodRow(foodRowElement) {
        if (isViewingHistoricalRegistro) {
            Swal.fire('Acción no permitida', 'No se pueden eliminar alimentos de un registro histórico.', 'warning');
            return;
        }
        const hiddenAlimentoSelect = foodRowElement.querySelector('.select-alimento-hidden');
        const alimentoId = hiddenAlimentoSelect ? hiddenAlimentoSelect.value : null;
        const alimentoData = alimentoId ? ALL_ALIMENTOS_DATA.find(a => a.id_alimento.toString() === alimentoId) : null;
        const nombreAlimento = alimentoData ? alimentoData.nombre_alimento : 'este alimento';

        const mealTimeBlock = foodRowElement.closest('.tiempo-comida-block');
        const tiempoComidaId = mealTimeBlock ? mealTimeBlock.dataset.tiempoId : null;

        if (!alimentoId || !tiempoComidaId) { // Alimento no guardado o bloque no guardado
            const tbody = foodRowElement.closest('tbody');
            if (tbody && tbody.rows.length > 1) {
                datosAlimentoPorFilaDOM.delete(foodRowElement);
                foodRowElement.remove();
            } else { // Última fila, resetéala
                const dropdownContainer = foodRowElement.querySelector('.alimento-searchable-dropdown');
                if (dropdownContainer) {
                    dropdownContainer.querySelector('.alimento-dropdown-button').textContent = 'Seleccione alimento...';
                    dropdownContainer.querySelector('.input-filtro-alimento-panel').value = "";
                    const hiddenSelect = dropdownContainer.querySelector('.select-alimento-hidden');
                    if(hiddenSelect) hiddenSelect.value = "";
                }
                foodRowElement.querySelector('.input-porciones').value = "1";
                actualizarValoresNutricionalesFilaAlimento(foodRowElement, null, 1);
                datosAlimentoPorFilaDOM.delete(foodRowElement);
            }
            return;
        }

        const result = await Swal.fire({
            title: `¿Eliminar "${nombreAlimento}"?`,
            text: `Se eliminará ${nombreAlimento} de este tiempo de comida en la base de datos.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
             Swal.fire({
                title: 'Eliminando...',
                text: `Eliminando ${nombreAlimento}.`,
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const url = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/borrar_alimento_detalle_dieta?pacienteId=${pacienteId}&alimentoId=${alimentoId}&tiempoComidaId=${tiempoComidaId}`;
                const response = await fetchAPI(url, `alimento ${nombreAlimento}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken }
                });

                if (response && response.status === 'success') {
                    Swal.fire('¡Eliminado!', response.mensaje || `${nombreAlimento} ha sido eliminado.`, 'success');
                    const tbody = foodRowElement.closest('tbody');
                    if (tbody && tbody.rows.length > 1) {
                        datosAlimentoPorFilaDOM.delete(foodRowElement);
                        foodRowElement.remove();
                    } else {
                        const dropdownContainer = foodRowElement.querySelector('.alimento-searchable-dropdown');
                        if (dropdownContainer) {
                            dropdownContainer.querySelector('.alimento-dropdown-button').textContent = 'Seleccione alimento...';
                            dropdownContainer.querySelector('.input-filtro-alimento-panel').value = "";
                            const hiddenSelect = dropdownContainer.querySelector('.select-alimento-hidden');
                            if(hiddenSelect) hiddenSelect.value = "";
                        }
                        foodRowElement.querySelector('.input-porciones').value = "1";
                        actualizarValoresNutricionalesFilaAlimento(foodRowElement, null, 1);
                        datosAlimentoPorFilaDOM.delete(foodRowElement);
                    }
                    await cargarYMostrarResumenNutricionalYDetalles(registroDateSelectorEl.value === "current" ? null : registroDateSelectorEl.value, 
                                                                  registroDateSelectorEl.value === "current" ? null : registroDateSelectorEl.options[registroDateSelectorEl.selectedIndex].dataset.fechaDieta);
                } else {
                    throw new Error(response.mensaje || `No se pudo eliminar ${nombreAlimento}.`);
                }
            } catch (error) {
                 Swal.fire('Error', `Error al eliminar ${nombreAlimento}: ${error.message}`, 'error');
            }
        }
    }

    function reorderMealTimeBlocksByTime() {
        const blocks = Array.from(tiemposComidaContainer.querySelectorAll('.tiempo-comida-block'));
        if (blocks.length <= 1) return;

        blocks.sort((a, b) => {
            const timeA = a.dataset.hora;
            const timeB = b.dataset.hora;
            if (!timeA && !timeB) return 0;
            if (!timeA) return 1; // Los sin hora al final
            if (!timeB) return -1;
            return timeA.localeCompare(timeB);
        });

        blocks.forEach(block => tiemposComidaContainer.appendChild(block));
    }

    tiemposComidaContainer.addEventListener('change', (event) => {
        if (isViewingHistoricalRegistro) return;
        const target = event.target;
        const foodRow = target.closest('tr[data-food-row-id]');
        const blockDiv = target.closest('.tiempo-comida-block');

        if (target.classList.contains('select-tiempo-comida-block') && blockDiv) {
            blockDiv.dataset.tiempoId = target.value;
            updateAllMealTimeSelects();
        } else if (target.classList.contains('input-hora-block') && blockDiv) {
            blockDiv.dataset.hora = target.value;
            reorderMealTimeBlocksByTime();
        } else if (target.classList.contains('select-alimento-hidden') && foodRow) {
            const alimentoId = target.value;
            const porcionesInput = foodRow.querySelector('.input-porciones');

            if (alimentoId && ALL_ALIMENTOS_DATA) {
                const alimentoSeleccionado = ALL_ALIMENTOS_DATA.find(a => a.id_alimento.toString() === alimentoId);
                datosAlimentoPorFilaDOM.set(foodRow, alimentoSeleccionado);
                if (!porcionesInput.value) porcionesInput.value = "1";
                actualizarValoresNutricionalesFilaAlimento(foodRow, alimentoSeleccionado, porcionesInput.value || "1");
            } else {
                datosAlimentoPorFilaDOM.delete(foodRow);
                actualizarValoresNutricionalesFilaAlimento(foodRow, null, 0);
                const dropdownButton = foodRow.querySelector('.alimento-dropdown-button');
                if(dropdownButton) dropdownButton.textContent = 'Seleccione alimento...';
            }
        }
    });

    tiemposComidaContainer.addEventListener('input', (event) => {
        if (isViewingHistoricalRegistro) return;
        const target = event.target;
        const foodRow = target.closest('tr[data-food-row-id]');
        if (target.classList.contains('input-porciones') && foodRow) {
            const alimentoData = datosAlimentoPorFilaDOM.get(foodRow);
            const porciones = parseFloat(target.value);
            if (alimentoData) {
                actualizarValoresNutricionalesFilaAlimento(foodRow, alimentoData, isNaN(porciones) ? 0 : porciones);
            }
        }
    });

    tiemposComidaContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('button-eliminar-alimento')) { // Se permite click incluso si isViewingHistoricalRegistro para mostrar el Swal de advertencia
            const foodRow = event.target.closest('tr[data-food-row-id]');
            if (foodRow) {
                handleDeleteFoodRow(foodRow);
            }
        }
    });

    if (btnAnadirTiempoComida) {
        btnAnadirTiempoComida.addEventListener('click', () => {
            if (isViewingHistoricalRegistro) return; // Doble check
            createMealTimeBlock(); // Esta función ya llama a toggleEditableState y updateAllMealTimeSelects
            reorderMealTimeBlocksByTime();
        });
    }

    if (btnGuardarRegistroCompleto) {
        btnGuardarRegistroCompleto.addEventListener('click', async () => {
            if (isViewingHistoricalRegistro) {
                Swal.fire('Acción no permitida', 'No se puede guardar un registro histórico. Seleccione "Registro Actual" para editar.', 'warning');
                return;
            }
            const notasAGuardar = notasGeneralesTextarea.value;
            const detallesAGuardar = [];
            let esValidoGeneral = true;

            tiemposComidaContainer.querySelectorAll('.tiempo-comida-block').forEach(blockDiv => {
                const tiempoComidaSelect = blockDiv.querySelector('.select-tiempo-comida-block');
                const horaInput = blockDiv.querySelector('.input-hora-block');
                const tiempoComidaId = tiempoComidaSelect.value;
                const horaTiempoComida = horaInput.value;

                let tieneAlimentosValidosEsteBloque = false;
                blockDiv.querySelectorAll('tbody tr[data-food-row-id]').forEach(foodRow => {
                    const hiddenAlimentoSelect = foodRow.querySelector('.select-alimento-hidden');
                    const porcionesInput = foodRow.querySelector('.input-porciones');
                    const alimentoId = hiddenAlimentoSelect.value;
                    const porciones = parseFloat(porcionesInput.value);
                    if (alimentoId && !isNaN(porciones) && porciones > 0) {
                        tieneAlimentosValidosEsteBloque = true;
                    }
                });

                if (!tiempoComidaId || !horaTiempoComida) {
                    if (tieneAlimentosValidosEsteBloque || // Si tiene alimentos válidos pero falta tiempo/hora
                        (blockDiv.querySelectorAll('tbody tr[data-food-row-id]').length > 0 && 
                         blockDiv.querySelector('tbody tr[data-food-row-id] .select-alimento-hidden').value)) { // Si hay alguna fila con alimento seleccionado, aunque las porciones sean 0
                         esValidoGeneral = false;
                         tiempoComidaSelect.style.borderColor = !tiempoComidaId ? 'red' : '';
                         horaInput.style.borderColor = !horaTiempoComida ? 'red' : '';
                         return; // Sale del forEach de bloques
                    } else { // Bloque sin alimentos y sin tiempo/hora, se ignora
                        tiempoComidaSelect.style.borderColor = '';
                        horaInput.style.borderColor = '';
                    }
                } else {
                    tiempoComidaSelect.style.borderColor = '';
                    horaInput.style.borderColor = '';
                }


                blockDiv.querySelectorAll('tbody tr[data-food-row-id]').forEach(foodRow => {
                    const hiddenAlimentoSelect = foodRow.querySelector('.select-alimento-hidden');
                    const dropdownButton = foodRow.querySelector('.alimento-dropdown-button');
                    const porcionesInput = foodRow.querySelector('.input-porciones');
                    const alimentoId = hiddenAlimentoSelect.value;
                    const porciones = parseFloat(porcionesInput.value);

                    if (alimentoId && !isNaN(porciones) && porciones > 0) {
                        if(dropdownButton) dropdownButton.style.borderColor = '';
                        porcionesInput.style.borderColor = '';
                        detallesAGuardar.push({
                            pacienteId: parseInt(pacienteId),
                            horaTiempoComida: horaTiempoComida,
                            tiempoComidaId: parseInt(tiempoComidaId),
                            numeroPorciones: porciones,
                            alimentoId: parseInt(alimentoId),
                            notas: notasAGuardar // Se envía en cada detalle
                        });
                    } else if (alimentoId && (isNaN(porciones) || porciones <= 0)) { // Alimento seleccionado pero porciones inválidas
                        esValidoGeneral = false;
                        if(dropdownButton) dropdownButton.style.borderColor = '';
                        porcionesInput.style.borderColor = 'red';
                    } else if (!alimentoId && porcionesInput.value && porcionesInput.value !== "1" && parseFloat(porcionesInput.value) > 0) { // Porciones ingresadas pero sin alimento
                        esValidoGeneral = false;
                        if(dropdownButton) dropdownButton.style.borderColor = 'red';
                        porcionesInput.style.borderColor = '';
                    } else {
                        // Fila vacía o con alimento y porciones 0/NaN (ya manejado arriba) o sin alimento y porciones default
                        if(dropdownButton) dropdownButton.style.borderColor = '';
                        porcionesInput.style.borderColor = '';
                    }
                });
            });

            if (!esValidoGeneral) {
                Swal.fire('Campos incompletos', 'Por favor, complete todos los campos obligatorios (Tiempo, Hora, Alimento, Porciones > 0) en cada registro con alimentos. Los bloques vacíos se ignorarán.', 'warning');
                return;
            }

            if (detallesAGuardar.length === 0 && !notasAGuardar.trim()) {
                 Swal.fire('Sin datos', 'No hay registros de comida válidos ni notas para guardar.', 'info');
                 return;
            }


            Swal.fire({
                title: 'Guardando Registro',
                text: 'Por favor, espere...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            let promesasGuardado = [];
            if (detallesAGuardar.length > 0) {
                // Si hay detalles de alimentos, la nota general se envía con cada uno.
                // El backend debería manejar esto y tomar la nota del primer detalle o la más reciente.
                promesasGuardado = detallesAGuardar.map(detalle =>
                    fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/guardar_detalle_dieta', 'detalle de dieta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(detalle)
                    }).catch(error => ({ error: true, message: error.message, detalle }))
                );
            } else if (notasAGuardar.trim()) { // Solo notas si no hay detalles de alimentos
                // Aquí se envía un payload especial solo con notas.
                // Es importante que el backend pueda manejar un registro sin alimentos pero con notas.
                const payloadSoloNotas = {
                    pacienteId: parseInt(pacienteId),
                    notas: notasAGuardar,
                    // No se envían tiempoComidaId, alimentoId, etc.
                    // El backend debe identificar que es solo una actualización/creación de notas.
                };
                promesasGuardado.push(
                     fetchAPI('https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/guardar_detalle_dieta', 'notas de dieta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payloadSoloNotas)
                    }).catch(error => ({ error: true, message: error.message, detalle: { notas: notasAGuardar } }))
                );
            }


            try {
                const resultados = await Promise.all(promesasGuardado);
                const errores = resultados.filter(r => r.error);

                if (errores.length > 0) {
                    const mensajesError = errores.map(e => {
                        const tipo = e.detalle.alimentoId ? `Alimento ID ${e.detalle.alimentoId}` : (e.detalle.notas ? "Notas generales" : "Registro");
                        return `${tipo}: ${e.message}`;
                    }).join('<br>');
                    Swal.fire('Error al Guardar', `Algunos datos no se pudieron guardar:<br>${mensajesError}`, 'error');
                } else {
                    Swal.fire('¡Guardado!', 'El registro dietario ha sido guardado exitosamente.', 'success');
                    // Después de guardar, recargar los datos del registro actual
                    await cargarYMostrarResumenNutricionalYDetalles(null, null); 
                    await loadRegistroDates(); // Recargar las fechas por si se creó un nuevo registro de un día diferente
                    registroDateSelectorEl.value = "current"; // Asegurar que el selector vuelve a "Registro Actual"
                }
            } catch (errorGeneral) {
                Swal.fire('Error Crítico', `Ocurrió un error inesperado al procesar los guardados: ${errorGeneral.message}`, 'error');
            }
        });
    }
    
    async function loadRegistroDates() {
        if (!registroDateSelectorEl) {
            console.warn("El elemento registroDateSelectorEl no fue encontrado. No se pueden cargar fechas.");
            return;
        }
        registroDateSelectorEl.innerHTML = '<option value="" selected disabled>Cargando fechas...</option>';
        try {
            const response = await fetchAPI(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/registros_dieta_por_fecha?pacienteId=${pacienteId}`, 'fechas de registros');
            if (response.status === 'success' && response.data) {
                registroDateSelectorEl.innerHTML = '<option value="current" selected>Registro Actual (Editable)</option>';
                const sortedDates = response.data.sort((a, b) => new Date(b.fecha_dieta) - new Date(a.fecha_dieta));
                sortedDates.forEach(registro => {
                    const option = document.createElement('option');
                    option.value = registro.id_dieta;
                    option.dataset.fechaDieta = registro.fecha_dieta;
                    const fecha = new Date(registro.fecha_dieta + 'T00:00:00'); // Interpretar como local
                    option.textContent = `Registro del ${fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`;
                    registroDateSelectorEl.appendChild(option);
                });
                if (response.data.length === 0) {
                     registroDateSelectorEl.innerHTML += '<option value="" disabled>No hay registros anteriores</option>';
                }
            } else {
                registroDateSelectorEl.innerHTML = '<option value="current" selected>Registro Actual (Editable)</option>';
                registroDateSelectorEl.innerHTML += '<option value="" disabled>No hay registros anteriores o error</option>';
                console.warn('No se encontraron fechas de registros o hubo un error al cargar fechas:', response.mensaje);
            }
        } catch (error) {
            console.error("Error en loadRegistroDates:", error);
            if (registroDateSelectorEl) {
                registroDateSelectorEl.innerHTML = '<option value="current" selected>Registro Actual (Editable)</option>';
                registroDateSelectorEl.innerHTML += '<option value="" disabled>Error al cargar fechas</option>';
            }
        }
    }

    async function cargarYMostrarResumenNutricionalYDetalles(idDietaParaCargar = null, fechaDietaParaCargar = null) {
        if (!pacienteId) {
            if (adecuacionStatusDiv) {
                adecuacionStatusDiv.textContent = "ID de paciente no disponible.";
                adecuacionStatusDiv.className = 'info';
            }
            return;
        }
        graficoAdecuacionContainerEl = document.querySelector('.grafico-adecuacion-container');

        try {
            const urlActividadFisica = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/paciente/obtener_actividad_fisica/${pacienteId}`;
            const actividadFisicaResponse = await fetchAPI(urlActividadFisica, 'factor de actividad física');
            if (!actividadFisicaResponse || actividadFisicaResponse.id_actividad_fisica === null || actividadFisicaResponse.valor_naf === null) {
                let mensaje = "El factor de actividad física no ha sido asignado o no se pudo obtener.";
                if (actividadFisicaResponse && actividadFisicaResponse.mensaje) mensaje = actividadFisicaResponse.mensaje;
                else if (actividadFisicaResponse && actividadFisicaResponse.id_actividad_fisica === null) mensaje = "El factor de actividad física no ha sido asignado.";
                throw { type: 'falta_dato_historial', message: `Falta el factor de actividad física. ${mensaje}` };
            }
            const urlFactorPatologico = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/paciente/obtener_factor_patologico/${pacienteId}`;
            const factorPatologicoResponse = await fetchAPI(urlFactorPatologico, 'factor patológico');
            if (!factorPatologicoResponse || factorPatologicoResponse.descripcion === null || factorPatologicoResponse.valor_factor === null) {
                let mensaje = "El factor patológico no ha sido asignado o no se pudo obtener.";
                if (factorPatologicoResponse && factorPatologicoResponse.mensaje) mensaje = factorPatologicoResponse.mensaje;
                else if (factorPatologicoResponse && factorPatologicoResponse.descripcion === null) mensaje = "El factor patológico no ha sido asignado.";
                throw { type: 'falta_dato_historial', message: `Falta el factor patológico. ${mensaje}` };
            }
        } catch (error) {
            console.error("Error durante la verificación de datos del historial clínico:", error);
            let redirectUrlBase = "";
            let urlModule = "";
            if (error.type === 'falta_dato_historial') {
                redirectUrlBase = "{% url 'patients:historial-clinico' id_paciente=0 %}";
                urlModule = "historial-clinico";
                Swal.fire({ title: 'Faltan Datos del Historial', text: `${error.message} No es posible continuar. Por favor, completa el historial clínico.`, icon: 'warning', confirmButtonText: 'Ir a Historial Clínico', allowOutsideClick: false, allowEscapeKey: false })
                .then((result) => { if (result.isConfirmed) { const pId = document.getElementById('paciente-id').value; if (!pId) { Swal.fire("Error Interno", "No se pudo obtener ID del paciente.", "error"); return; } let url = redirectUrlBase.replace('0', pId); if (redirectUrlBase.startsWith("{%") || url.includes("/0/")) { url = `/patients/${pId}/${urlModule}/`; } window.location.href = url; }});
            } else {
                Swal.fire('Error Crítico', `No se pudieron verificar los datos del historial clínico: ${error.message}.`, 'error');
            }
            if(adecuacionStatusDiv) { adecuacionStatusDiv.textContent = `Error: ${error.message || "Problema al verificar historial."}`; adecuacionStatusDiv.className = 'error'; }
            toggleEditableStateRegistro(false); if (btnAnadirTiempoComida) btnAnadirTiempoComida.disabled = true; if (btnGuardarRegistroCompleto) btnGuardarRegistroCompleto.disabled = true; return;
        }

        try {
            const urlRequerimientos = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/requerimientos/obtener_requerimientos?pacienteId=${pacienteId}`;
            const requerimientosResponse = await fetchAPI(urlRequerimientos, 'requerimientos del paciente');
            if (!requerimientosResponse || requerimientosResponse.status !== "success" || !requerimientosResponse.data || requerimientosResponse.data.id_requerimientos === null) {
                throw new Error(requerimientosResponse?.mensaje || "No se encontraron requerimientos válidos.");
            }
        } catch (error) {
            console.error("Error durante la verificación de requerimientos:", error.message);
            const mensajeErrorApiNoRequerimientos = "No se encontraron requerimientos guardados";
             if (error.message && error.message.toLowerCase().includes(mensajeErrorApiNoRequerimientos.toLowerCase())) {
                Swal.fire({ title: 'Faltan Requerimientos Nutricionales', text: 'No es posible realizar el registro de dieta sin antes guardar los requerimientos. Vuelve a la sección "Antropometría y Requerimientos".', icon: 'warning', confirmButtonText: 'Ir a Antropometría', allowOutsideClick: false, allowEscapeKey: false })
                .then((result) => { if (result.isConfirmed) { const pId = document.getElementById('paciente-id').value; if (!pId) { Swal.fire("Error Interno", "No se pudo obtener ID del paciente.", "error"); return; } let urlMetricas = "{% url 'patients:metricas' id_paciente=0 %}".replace('0', pId); if ("{% url 'patients:metricas' id_paciente=0 %}".startsWith("{%") || urlMetricas.includes("/0/")) { urlMetricas = `/patients/${pId}/metricas/`; } window.location.href = urlMetricas; }});
                if(adecuacionStatusDiv) {adecuacionStatusDiv.textContent = "Atención: No hay requerimientos nutricionales guardados."; adecuacionStatusDiv.className = 'warning';}
            } else { Swal.fire('Error Crítico', `No se pudieron verificar los requerimientos: ${error.message}.`, 'error'); if(adecuacionStatusDiv) {adecuacionStatusDiv.textContent = `Error al verificar requerimientos: ${error.message}`; adecuacionStatusDiv.className = 'error';} }
            toggleEditableStateRegistro(false); if (btnAnadirTiempoComida) btnAnadirTiempoComida.disabled = true; if (btnGuardarRegistroCompleto) btnGuardarRegistroCompleto.disabled = true; return;
        }

        const esRegistroHistorico = !!idDietaParaCargar;
        isViewingHistoricalRegistro = esRegistroHistorico; // Actualizar estado global

        const tituloFecha = esRegistroHistorico && fechaDietaParaCargar 
            ? `del ${new Date(fechaDietaParaCargar + 'T00:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`
            : 'actual';
        if (adecuacionStatusDiv) {
            adecuacionStatusDiv.textContent = `Cargando datos del registro ${tituloFecha}...`;
            adecuacionStatusDiv.className = 'loading';
        }
        
        if (tiemposComidaContainer) tiemposComidaContainer.innerHTML = '';
        mealTimeBlockCounter = 0;
        datosAlimentoPorFilaDOM.clear();
        if (notasGeneralesTextarea) notasGeneralesTextarea.value = '';
        
        if (graficoAdecuacionContainerEl) {
            graficoAdecuacionContainerEl.innerHTML = '<p>Cargando gráfico...</p>';
        } else {
            const adecuacionSection = document.getElementById('adecuacion-registro-section');
            if (adecuacionSection) {
                graficoAdecuacionContainerEl = document.createElement('div');
                graficoAdecuacionContainerEl.classList.add('grafico-adecuacion-container');
                graficoAdecuacionContainerEl.innerHTML = '<p>Cargando gráfico...</p>';
                const statusDivSibling = adecuacionSection.querySelector('#adecuacion-status');
                if (statusDivSibling) {
                    adecuacionSection.insertBefore(graficoAdecuacionContainerEl, statusDivSibling);
                } else {
                    const h3Adecuacion = adecuacionSection.querySelector('h3');
                    if (h3Adecuacion && h3Adecuacion.nextSibling) adecuacionSection.insertBefore(graficoAdecuacionContainerEl, h3Adecuacion.nextSibling);
                    else if (h3Adecuacion) adecuacionSection.appendChild(graficoAdecuacionContainerEl);
                }
            }
        }

        try {
            let urlResumen, urlDetalles;
            let idDietaParamQuery = '';

            if (esRegistroHistorico) {
                urlResumen = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/obtener_resumen_nutricional_por_id_dieta?pacienteId=${pacienteId}&idDieta=${idDietaParaCargar}`;
                const fechaParaDetalles = fechaDietaParaCargar;
                if (!fechaParaDetalles) throw new Error("Fecha no disponible para cargar detalles del registro histórico.");
                urlDetalles = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/detalles_dieta?pacienteId=${pacienteId}&fecha=${fechaParaDetalles}`;
                idDietaParamQuery = `&id_dieta=${idDietaParaCargar}`;
            } else {
                urlResumen = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/obtener_resumen_nutricional?pacienteId=${pacienteId}`;
                urlDetalles = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/dieta/detalles_dieta?pacienteId=${pacienteId}`;
            }
            
            // Cargar gráfico HTML
            const urlGraficoHtml = `/patients/${pacienteId}/grafico_adecuacion_dieta/?${idDietaParamQuery.startsWith('&') ? idDietaParamQuery.substring(1) : idDietaParamQuery}`;
            try {
                const responseHtmlGrafico = await fetch(urlGraficoHtml, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/html' } });
                if (!responseHtmlGrafico.ok) throw new Error(`Error HTTP ${responseHtmlGrafico.status} al cargar gráfico.`);
                const htmlGrafico = await responseHtmlGrafico.text();
                if (graficoAdecuacionContainerEl) {
                    graficoAdecuacionContainerEl.innerHTML = htmlGrafico;
                    const scripts = graficoAdecuacionContainerEl.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.textContent = oldScript.textContent; // Para scripts inline
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                }
            } catch (errGrafico) {
                console.error("Error al cargar HTML del gráfico de adecuación:", errGrafico);
                if (graficoAdecuacionContainerEl) {
                    const retryButtonId = idDietaParaCargar ? `'${idDietaParaCargar}'` : 'null';
                    const retryButtonFecha = fechaDietaParaCargar ? `'${fechaDietaParaCargar}'` : 'null';
                    graficoAdecuacionContainerEl.innerHTML = `<div class="plotly-graph-error"><p>Error al cargar gráfico</p><button onclick="cargarYMostrarResumenNutricionalYDetalles(${retryButtonId}, ${retryButtonFecha})">Reintentar</button></div>`;
                }
            }

            // Cargar Resumen (notas y mensaje de status)
            const resumenResponse = await fetchAPI(urlResumen, `resumen nutricional ${tituloFecha}`);
            if (resumenResponse.status === "success" && resumenResponse.data) {
                const resumenData = resumenResponse.data;
                if (resumenData.totales_consumidos && resumenData.totales_consumidos.notas && !esRegistroHistorico) {
                    notasGeneralesTextarea.value = resumenData.totales_consumidos.notas;
                } else if (esRegistroHistorico && resumenData.notas_generales_dieta) {
                     notasGeneralesTextarea.value = resumenData.notas_generales_dieta;
                }
                 if (adecuacionStatusDiv) {
                    adecuacionStatusDiv.textContent = `Resumen y adecuación del registro ${tituloFecha} cargados.`;
                    adecuacionStatusDiv.className = 'success';
                }
            } else {
                 if (adecuacionStatusDiv) {
                    adecuacionStatusDiv.textContent = `No se pudieron cargar datos de resumen para ${tituloFecha}. ${resumenResponse.mensaje || ''}`;
                    adecuacionStatusDiv.className = 'info';
                 }
            }

            // Cargar Detalles de la Dieta (Alimentos)
            const detallesResponse = await fetchAPI(urlDetalles, `detalles de dieta ${tituloFecha}`);
            if (detallesResponse.status === "success" && detallesResponse.data) {
                const datosDieta = detallesResponse.data;
                // Priorizar notas del resumen, pero si no hay, tomar de detalles
                if (datosDieta.notas && !notasGeneralesTextarea.value) { 
                    notasGeneralesTextarea.value = datosDieta.notas;
                }

                if (datosDieta.detalles && datosDieta.detalles.length > 0) {
                    const detallesAgrupados = datosDieta.detalles.reduce((acc, detalle) => {const key = `${detalle.id_tiempo_comida}-${detalle.hora_tiempo_comida}`; if (!acc[key]) { acc[key] = { id_tiempo_comida: detalle.id_tiempo_comida, hora_tiempo_comida: detalle.hora_tiempo_comida, alimentos: [] }; } acc[key].alimentos.push({ alimento_id_alimento: detalle.alimento_id_alimento, numero_porciones_dieta: detalle.numero_porciones_dieta }); return acc;}, {});
                    Object.values(detallesAgrupados).forEach(grupo => { createMealTimeBlock(grupo.id_tiempo_comida, grupo.hora_tiempo_comida, grupo.alimentos); });
                } else {
                    if (tiemposComidaContainer && esRegistroHistorico) tiemposComidaContainer.innerHTML = `<p>No se encontraron alimentos registrados para ${tituloFecha}.</p>`;
                }
            } else if (detallesResponse.status === "not_found") {
                 if (tiemposComidaContainer) tiemposComidaContainer.innerHTML = `<p>No se encontraron detalles de alimentos para el registro ${tituloFecha}.</p>`;
            } else {
                throw new Error(detallesResponse.mensaje || `No se pudieron cargar los detalles de alimentos para ${tituloFecha}.`);
            }

            if (tiemposComidaContainer && tiemposComidaContainer.children.length === 0 && ALL_TIEMPOS_COMIDA_DATA && ALL_TIEMPOS_COMIDA_DATA.length > 0 && !isViewingHistoricalRegistro) {
                createMealTimeBlock();
            }

        } catch (error) {
            console.error(`Error al cargar datos del registro ${tituloFecha}:`, error);
            if (adecuacionStatusDiv) {
                adecuacionStatusDiv.textContent = `Error al cargar datos del registro ${tituloFecha}: ${error.message}`;
                adecuacionStatusDiv.className = 'error';
            }
            if (graficoAdecuacionContainerEl) graficoAdecuacionContainerEl.innerHTML = `<p style="color:red;">Error al cargar datos: ${error.message}</p>`;
            if (tiemposComidaContainer && tiemposComidaContainer.children.length === 0 && ALL_TIEMPOS_COMIDA_DATA && ALL_TIEMPOS_COMIDA_DATA.length > 0 && !isViewingHistoricalRegistro) {
                createMealTimeBlock();
            }
        } finally {
            toggleEditableStateRegistro(!isViewingHistoricalRegistro);
        }
    }

    function toggleEditableStateRegistro(isEditable) {
        isViewingHistoricalRegistro = !isEditable; // Actualizar el estado global

        // Botones principales de la página
        if (btnAnadirTiempoComida) {
            btnAnadirTiempoComida.style.display = isEditable ? 'inline-block' : 'none';
            // btnAnadirTiempoComida.disabled = !isEditable; // Gestionado por updateAddMealButtonState
        }
        if (btnGuardarRegistroCompleto) {
            btnGuardarRegistroCompleto.style.display = isEditable ? 'inline-block' : 'none';
            btnGuardarRegistroCompleto.disabled = !isEditable;
        }
        if (notasGeneralesTextarea) {
            notasGeneralesTextarea.readOnly = !isEditable;
        }

        // Elementos dentro de cada bloque de tiempo de comida
        tiemposComidaContainer.querySelectorAll('.tiempo-comida-block').forEach(block => {
            const selectTiempo = block.querySelector('.select-tiempo-comida-block');
            const inputHora = block.querySelector('.input-hora-block');
            
            if (selectTiempo) selectTiempo.disabled = !isEditable;
            if (inputHora) inputHora.readOnly = !isEditable;

            const btnAddAlimento = block.querySelector('.acciones-bloque .button-secondary');
            const btnDeleteTiempo = block.querySelector('.acciones-bloque .button-eliminar-fila'); // Asumo que este es el de eliminar tiempo
            
            if (btnAddAlimento) {
                btnAddAlimento.style.display = isEditable ? 'inline-block' : 'none';
                btnAddAlimento.disabled = !isEditable;
            }
            if (btnDeleteTiempo) {
                btnDeleteTiempo.style.display = isEditable ? 'inline-block' : 'none';
                btnDeleteTiempo.disabled = !isEditable;
            }

            block.querySelectorAll('tbody tr[data-food-row-id]').forEach(foodRow => {
                const alimentoDropdownButton = foodRow.querySelector('.alimento-dropdown-button');
                const inputFiltroAlimento = foodRow.querySelector('.input-filtro-alimento-panel');
                const hiddenAlimentoSelect = foodRow.querySelector('.select-alimento-hidden');
                const inputPorciones = foodRow.querySelector('.input-porciones');
                const btnDeleteAlimento = foodRow.querySelector('.button-eliminar-alimento');

                if (alimentoDropdownButton) alimentoDropdownButton.disabled = !isEditable;
                if (inputFiltroAlimento) inputFiltroAlimento.readOnly = !isEditable;
                if (hiddenAlimentoSelect) hiddenAlimentoSelect.disabled = !isEditable;
                if (inputPorciones) inputPorciones.readOnly = !isEditable;
                
                if (btnDeleteAlimento) {
                     btnDeleteAlimento.style.display = isEditable ? 'inline-block' : 'none';
                     btnDeleteAlimento.disabled = !isEditable;
                }
            });
        });
        updateAllMealTimeSelects(); // Actualiza los selects de tiempo y el botón general de añadir tiempo
        reorderMealTimeBlocksByTime(); // Reordena si es necesario
    }

    async function initializePage() {
        if (adecuacionStatusDiv) {
            adecuacionStatusDiv.textContent = "Cargando datos base...";
            adecuacionStatusDiv.className = 'loading';
        }
        try {
            await cargarDatosBase();
            await loadRegistroDates();
            // Por defecto, se carga el registro actual (editable)
            // cargarYMostrarResumenNutricionalYDetalles ya se encarga de llamar a toggleEditableStateRegistro
            await cargarYMostrarResumenNutricionalYDetalles(null, null); 
        } catch (error) {
            console.error("Error crítico durante la inicialización:", error);
            if (adecuacionStatusDiv) {
                adecuacionStatusDiv.textContent = `Error al inicializar la página: ${error.message}. Verifique la consola.`;
                adecuacionStatusDiv.className = 'error';
            }
            // Los botones ya son deshabilitados por `cargarDatosBase` o por `cargarYMostrar...` si fallan.
        }
    }

    if (registroDateSelectorEl) {
        registroDateSelectorEl.addEventListener('change', async (event) => {
            const selectedValue = event.target.value;
            const selectedOption = event.target.options[event.target.selectedIndex];
            const fechaDieta = selectedOption ? selectedOption.dataset.fechaDieta : null;

            if (graficoAdecuacionContainerEl) graficoAdecuacionContainerEl.innerHTML = '<p>Cargando nuevo registro...</p>';
            if (tiemposComidaContainer) tiemposComidaContainer.innerHTML = ''; // Limpiar bloques
            if (notasGeneralesTextarea) notasGeneralesTextarea.value = '';


            if (selectedValue === "current") {
                // cargarYMostrarResumenNutricionalYDetalles(null, null) se encarga de poner isViewingHistoricalRegistro = false y llamar a toggleEditableStateRegistro(true)
                await cargarYMostrarResumenNutricionalYDetalles(null, null);
            } else if (selectedValue && fechaDieta) {
                // cargarYMostrarResumenNutricionalYDetalles(id, fecha) se encarga de poner isViewingHistoricalRegistro = true y llamar a toggleEditableStateRegistro(false)
                await cargarYMostrarResumenNutricionalYDetalles(selectedValue, fechaDieta);
            }
        });
    }

    initializePage();
});
</script>
{% endblock %}