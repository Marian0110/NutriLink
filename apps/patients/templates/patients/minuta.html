{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Minuta{% endblock %}

{% block perfilcontent %}
<!-- Incluir html2pdf.js desde un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- CDN Flaticon (icons)-->
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css">


<div class="minuta-creation-content patient-content"> 
<div class="minuta-selector-container" style="margin-bottom: 20px;">
    <label for="minuta-date-selector" style="color: #173b4c; font-weight: bold;">Seleccionar minutas anteriores:</label>
    <select id="minuta-date-selector" class="minuta-date-selector" style="padding: 8px; border: 1px solid #173b4c; border-radius: 4px;">
      <option value="" selected disabled>Cargando fechas disponibles...</option>
    </select>
</div>

  <div id="adecuacion-minuta-section" style="margin-bottom: 25px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
    <h3 style="color: #173b4c; text-align: center; margin-bottom: 15px; border-bottom: 2px solid #62f485; padding-bottom: 8px;">Resumen de Adecuación de Minuta Actual</h3>
    <table id="tabla-adecuacion" class="adecuacion-table" style="width: 100%; border-collapse: collapse; margin: 0 auto;">
        <thead>
            <tr style="background-color: #173b4c; color: white;">
                <th style="padding: 10px; text-align: left;">Componente</th>
                <th style="padding: 10px; text-align: center;">Porcentaje de Adecuación</th>
            </tr>
        </thead>
        <tbody>
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 10px; font-weight: bold;">Calórico</td>
                <td id="adecuacion-calorico" style="padding: 10px; text-align: center;">- %</td>
            </tr>
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 10px; font-weight: bold;">Proteínas</td>
                <td id="adecuacion-proteinas" style="padding: 10px; text-align: center;">- %</td>
            </tr>
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 10px; font-weight: bold;">Carbohidratos</td>
                <td id="adecuacion-carbohidratos" style="padding: 10px; text-align: center;">- %</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">Lípidos</td>
                <td id="adecuacion-lipidos" style="padding: 10px; text-align: center;">- %</td>
            </tr>
        </tbody>
    </table>
    <div id="adecuacion-status" style="font-style: italic; margin-top: 15px; font-size: 0.9em; text-align: center; color: #173b4c;">Cargando datos de adecuación...</div>
</div>

    <h2 style="color: #173b4c; text-align: center; margin: 25px 0; border-bottom: 2px solid #62f485; padding-bottom: 10px;">Porciones por tiempo de comida</h2>

    <script type="text/javascript">
      const PACIENTE_ID_FROM_DJANGO = JSON.parse('{{ paciente.id_paciente|escapejs }}');
      const PACIENTE_EMAIL_FROM_DJANGO = JSON.parse('{% if paciente_email %}"{{ paciente_email|escapejs }}"{% else %}null{% endif %}');
      const PACIENTE_NOMBRE_COMPLETO_FROM_DJANGO = JSON.parse('{% if paciente.nombre_completo %}"{{ paciente.nombre_completo|escapejs }}"{% else %}null{% endif %}');
      const minutaDateSelector = document.getElementById('minuta-date-selector');
    </script>    

    <div id="meal-times-container" style="margin: 20px 0;">
        <!-- Las entradas de tiempo de comida se agregarán aquí dinámicamente -->
    </div>

    <div style="margin-top: 25px; margin-bottom: 15px; text-align: center;">
      <button id="add-meal-time-btn" class="button-secondary" style="display: none; background-color: #173b4c; color: #ffffff; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;">Agregar Tiempo de Comida</button>
      <button id="generate-minuta-btn" class="button-primary" style="margin-left: 10px; background-color: #62f485; color: rgb(0, 0, 0); border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;">Generar Minuta</button>
    </div>
    
    <div id="general-status" style="min-height: 20px; font-weight: bold; text-align: center; margin: 15px 0;"></div>
    
    <div id="minuta-modal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            <span class="btn-close" style="color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer;"></span>
            
            <h1 style="color: #173b4c; text-align: center; margin-bottom: 15px; border-bottom: 2px solid #62f485; padding-bottom: 10px;">Minuta Generada</h1>
            
            <h5 style="margin: 0 0 20px 0; text-align: center; color: #173b4c;">Escoja 1 de las opciones por cada grupo de alimentos</h5>
            
            <div id="minuta-modal-body" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                <!-- El contenido de la minuta se insertará aquí -->
            </div>
            
            <div class="modal-footer" style="display: flex; justify-content: space-between; margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                <button id="save-minuta-pdf-btn" class="button-primary" style="background-color: #173b4c; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;"> <i class="fi fi-rr-download" style="margin-right: 10px;"></i><span>Guardar en PDF</span></button>
                <button id="send-minuta-email-btn" class="button-secondary" style="background-color: #62f485; color: #000000; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;"><i class="fi fi-rr-envelope" style="margin-right: 10px;"></i><span>Enviar por Correo</span></button>
            </div>
            
            <div id="minuta-modal-status" style="margin-top:15px; font-weight:bold; text-align:center;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PACIENTE_ID = typeof PACIENTE_ID_FROM_DJANGO !== 'undefined' ? PACIENTE_ID_FROM_DJANGO : null;

    const mealTimesContainer = document.getElementById('meal-times-container');
    const addMealTimeBtn = document.getElementById('add-meal-time-btn');
    const generalStatusDiv = document.getElementById('general-status'); 
    const generateMinutaBtn = document.getElementById('generate-minuta-btn');
    const minutaModal = document.getElementById('minuta-modal');
    const closeModalBtn = document.querySelector('.btn-close');
    const minutaModalBody = document.getElementById('minuta-modal-body');
    const minutaModalStatus = document.getElementById('minuta-modal-status'); 
    const saveMinutaPdfBtn = document.getElementById('save-minuta-pdf-btn');
    const sendMinutaEmailBtn = document.getElementById('send-minuta-email-btn');
    const adecuacionCaloricoEl = document.getElementById('adecuacion-calorico');
    const adecuacionProteinasEl = document.getElementById('adecuacion-proteinas');
    const adecuacionCarbohidratosEl = document.getElementById('adecuacion-carbohidratos');
    const adecuacionLipidosEl = document.getElementById('adecuacion-lipidos');
    const adecuacionStatusEl = document.getElementById('adecuacion-status');
    const minutaDateSelectorEl = document.getElementById('minuta-date-selector');

    let ALL_MEAL_TIMES_DATA = []; 
    let foodGroupsData = [];      
    let mealTimeEntryCounter = 0; 
    let currentGeneratedMinutaData = null;
    let isViewingHistoricalMinuta = false;

    if (PACIENTE_ID === null) {
        console.error("PACIENTE_ID no está definido o es null.");
        if(generalStatusDiv) generalStatusDiv.textContent = "Error crítico: No se pudo identificar al paciente.";
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "No se puede cargar la adecuación sin ID de paciente.";
            adecuacionStatusEl.className = 'error';
        }
        if(addMealTimeBtn) addMealTimeBtn.disabled = true;
        if(generateMinutaBtn) generateMinutaBtn.disabled = true; 
        return; 
    }
    
    async function loadMinutaDates() {
        minutaDateSelectorEl.innerHTML = '<option value="" selected disabled>Cargando fechas...</option>';
        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/minutas_por_fecha/?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (response.ok && result.status === 'success' && result.data) {
                minutaDateSelectorEl.innerHTML = '<option value="current" selected>Minuta Actual (Editable)</option>';
                
                // Ordenar fechas de más reciente a más antigua usando el string
                const sortedDates = result.data.sort((a, b) => b.fecha_minuta.localeCompare(a.fecha_minuta));

                sortedDates.forEach(minuta => {
                    const option = document.createElement('option');
                    option.value = minuta.id_minuta;
                    // Formatear fecha manualmente a "16 de mayo de 2025"
                    const [year, month, day] = minuta.fecha_minuta.split('-');
                    const meses = [
                        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
                    ];
                    option.textContent = `Minuta del ${parseInt(day)} de ${meses[parseInt(month) - 1]} de ${year}`;
                    minutaDateSelectorEl.appendChild(option);
                });
            } else {
                minutaDateSelectorEl.innerHTML = '<option value="current" selected>Minuta Actual (Editable)</option>';
                minutaDateSelectorEl.innerHTML += '<option value="" disabled>Error al cargar fechas históricas</option>';
                console.error('Error al cargar fechas de minutas:', result.mensaje);
            }
        } catch (error) {
            console.error('Error en fetch al cargar fechas de minutas:', error);
            minutaDateSelectorEl.innerHTML = '<option value="current" selected>Minuta Actual (Editable)</option>';
            minutaDateSelectorEl.innerHTML += '<option value="" disabled>Error al cargar fechas históricas</option>';
        }
    }
    
    // --- FUNCIONES PARA MODAL DE MINUTA GENERADA ---
    // --- FUNCIÓN PARA CARGAR DETALLES DE MINUTA HISTÓRICA ---
    async function loadHistoricalMinutaDetails(idMinuta) {
        if (!PACIENTE_ID || !idMinuta) return;

        if(generalStatusDiv) {
            generalStatusDiv.textContent = `Cargando detalles de la minuta seleccionada...`;
            generalStatusDiv.className = 'info';
            generalStatusDiv.style.display = 'block';
        }
        mealTimesContainer.innerHTML = '<p style="text-align:center; padding:20px;">Cargando datos de la minuta...</p>';
        mealTimeEntryCounter = 0;
        isViewingHistoricalMinuta = true;
        toggleEditableState(false); // Deshabilitar edición

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/detalle_minuta_por_id_minuta?pacienteId=${PACIENTE_ID}&idMinuta=${idMinuta}`);
            const result = await response.json();

            if (response.ok && result.status === 'success' && result.data && result.data.detalles_minuta) {
                processAndDisplaySavedDetails(result.data.detalles_minuta, true); // true indica que es histórica

                if(generalStatusDiv) {
                    generalStatusDiv.textContent = `Mostrando minuta del ${minutaDateSelectorEl.options[minutaDateSelectorEl.selectedIndex].text.replace("Minuta del ","")}. Los datos no son editables.`;
                    generalStatusDiv.className = 'info';
                     setTimeout(() => {
                        if (generalStatusDiv.textContent.startsWith("Mostrando minuta")) generalStatusDiv.style.display = 'none';
                    }, 5000);
                }
            } else {
                throw new Error(result.mensaje || 'No se pudieron cargar los detalles de la minuta histórica.');
            }
        } catch (error) {
            console.error("Error al cargar minuta histórica:", error);
            mealTimesContainer.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Error al cargar datos: ${error.message}</p>`;
            if(generalStatusDiv) {
                generalStatusDiv.textContent = `Error al cargar minuta: ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            isViewingHistoricalMinuta = false; // Volver a estado no histórico en error
            toggleEditableState(true); // Habilitar edición
        }
    }

    // --- MODIFICACIÓN PARA ALTERNAR ESTADO EDITABLE ---
    function toggleEditableState(isEditable) {
        if (addMealTimeBtn) {
            if (isEditable) {
                updateAddMealButtonState(); 
            } else {
                // Si no es editable (es histórica), siempre ocultar y deshabilitar
                addMealTimeBtn.style.display = 'none';
                addMealTimeBtn.disabled = true;
            }
        }
        // Habilitar/deshabilitar botones de guardar/eliminar en cada entrada
        mealTimesContainer.querySelectorAll('.meal-time-entry').forEach(entry => {
            const saveBtn = entry.querySelector('.save-single-meal-btn');
            const deleteBtn = entry.querySelector('.delete-single-meal-btn');
                        entry.querySelectorAll('.meal-time-select, .meal-hour-input, .food-portions-table input[type="number"]')
                 .forEach(input => {
                     if (input.tagName === 'SELECT') {
                         input.disabled = !isEditable;
                     } else {
                         input.readOnly = !isEditable;
                     }
                 });

            if (isEditable) { // Solo mostrar botones si la entrada en sí los tiene (no todas las entradas históricas los tendrán)
                if (saveBtn) saveBtn.style.display = 'block'; 
                if (deleteBtn) deleteBtn.style.display = 'block'; 
            } else {
                if (saveBtn) saveBtn.style.display = 'none';
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
        });

        // El botón "Generar Minuta" (modal) podría cambiar su texto o comportamiento
        if (generateMinutaBtn) {
            if (isEditable) {
                generateMinutaBtn.textContent = 'Generar Minuta';
                
            } else {
            }
        }

        if (adecuacionStatusEl) {
            if(isEditable) {
                // Carga la adecuación actual normal
                loadAndDisplayAdecuacion();
            } else {
               
            }
        }
    }
    async function openGenerateMinutaModal() {
        if (isViewingHistoricalMinuta) {
            
        }
        if (!PACIENTE_ID) {
            alert("No se puede generar la minuta sin un ID de paciente.");
            return;
        }
        minutaModalBody.innerHTML = '<p style="text-align:center;">Cargando minuta...</p>';
        if (minutaModalStatus) minutaModalStatus.textContent = '';
        minutaModal.style.display = 'block';

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.mensaje || `Error HTTP ${response.status}`);
            }

            if (result.status === 'success' && result.data) {
                currentGeneratedMinutaData = result.data; 
                renderGeneratedMinuta(result.data);
            } else {
                throw new Error(result.mensaje || "No se pudo obtener la minuta generada.");
            }
        } catch (error) {
            console.error("Error al obtener minuta generada:", error);
            minutaModalBody.innerHTML = `<p style="color:red; text-align:center;">Error al cargar la minuta: ${error.message}</p>`;
        }
    }

    function renderGeneratedMinuta(data) {
    // Ordenar los tiempos de comida por hora antes de renderizar
    if (data.tiempos_de_comida && data.tiempos_de_comida.length > 0) {
        data.tiempos_de_comida.sort((a, b) => {
            const timeToMinutes = timeStr => {
                const [hours, minutes] = (timeStr || '00:00').split(':').map(Number);
                return hours * 60 + minutes;
            };
            return timeToMinutes(a.hora_sugerida) - timeToMinutes(b.hora_sugerida);
        });
    }
    
    minutaModalBody.innerHTML = ''; 
    if (!data.tiempos_de_comida || data.tiempos_de_comida.length === 0) {
        minutaModalBody.innerHTML = '<p style="text-align:center;">No hay tiempos de comida definidos en la minuta generada.</p>';
        return;
    }
    
    const minutaTitle = document.createElement('h3');
    minutaTitle.style.textAlign = 'center';
    minutaTitle.style.marginBottom = '20px';
    minutaTitle.style.color = '#173b4c';
    minutaTitle.textContent = `Plan de Alimentación para ${PACIENTE_NOMBRE_COMPLETO_FROM_DJANGO || 'Paciente'}`;
    minutaModalBody.appendChild(minutaTitle);

    data.tiempos_de_comida.forEach(tiempo => {
        const tiempoDiv = document.createElement('div');
        tiempoDiv.classList.add('minuta-tiempo-comida');
        tiempoDiv.style.marginBottom = '25px'; 
        tiempoDiv.style.paddingBottom = '15px';
        tiempoDiv.style.borderBottom = '1px solid #e0e0e0';
        
        // Contenedor para el título y la hora en la misma línea
        const tiempoHeaderContainer = document.createElement('div');
        tiempoHeaderContainer.style.display = 'flex';
        tiempoHeaderContainer.style.justifyContent = 'space-between';
        tiempoHeaderContainer.style.alignItems = 'center';
        tiempoHeaderContainer.style.marginBottom = '10px';
        
        const tiempoHeader = document.createElement('h4');
        tiempoHeader.textContent = `${tiempo.tiempo_comida}`;
        tiempoHeader.style.margin = '0';
        tiempoHeader.style.color = '#173b4c';
        
        if (tiempo.hora_sugerida) {
            const horaP = document.createElement('span');
            horaP.classList.add('hora-sugerida');
            horaP.style.fontStyle = 'normal'; 
            horaP.style.fontSize = '0.9em'; 
            horaP.style.color = '#173b4c';
            horaP.textContent = `Hora Sugerida: ${tiempo.hora_sugerida}`;
            tiempoHeaderContainer.appendChild(tiempoHeader);
            tiempoHeaderContainer.appendChild(horaP);
        } else {
            tiempoHeaderContainer.appendChild(tiempoHeader);
        }
        
        tiempoDiv.appendChild(tiempoHeaderContainer);

        if (tiempo.grupos && tiempo.grupos.length > 0) {
            tiempo.grupos.forEach(grupo => {
                const grupoDiv = document.createElement('div');
                grupoDiv.classList.add('minuta-grupo-alimento');
                grupoDiv.style.margin = '15px 0';

                const grupoHeader = document.createElement('h5');
                grupoHeader.textContent = grupo.grupo_descripcion;
                grupoHeader.style.color = '#173b4c';
                grupoHeader.style.marginBottom = '8px';
                grupoHeader.style.borderBottom = '1px solid #62f485';
                grupoHeader.style.paddingBottom = '5px';
                grupoDiv.appendChild(grupoHeader);

                // Crear un textarea para las opciones del grupo
                const opcionesTextarea = document.createElement('textarea');
                opcionesTextarea.rows = Math.max(4, grupo.opciones.length + 1);
                opcionesTextarea.readOnly = false; 
                opcionesTextarea.style.width = "95%";
                opcionesTextarea.style.padding = "8px";
                opcionesTextarea.style.border = "2px solid #62f485";
                opcionesTextarea.style.borderRadius = "4px";
                opcionesTextarea.style.fontFamily = "inherit";
                opcionesTextarea.style.fontSize = "14px";
                opcionesTextarea.style.backgroundColor = "#f9fff9";
                opcionesTextarea.style.color = "#173b4c";
                opcionesTextarea.dataset.tiempoId = tiempo.id_tiempo_comida;
                opcionesTextarea.dataset.grupoDesc = grupo.grupo_descripcion;

                // Construir el texto de las opciones
                let opcionesTexto = '';
                grupo.opciones.forEach(opcion => {
                    opcionesTexto += `• ${opcion.cantidad} ${opcion.medida} de ${opcion.alimento}\n`;
                });
                opcionesTextarea.value = opcionesTexto.trim();

                grupoDiv.appendChild(opcionesTextarea);
                tiempoDiv.appendChild(grupoDiv);
            });
        }
        minutaModalBody.appendChild(tiempoDiv);
    });
    
    // Div de indicaciones generales
    const indicacionesGeneralesDiv = document.createElement('div');
    indicacionesGeneralesDiv.id = 'minuta-indicaciones-generales-container'; 
    indicacionesGeneralesDiv.style.marginTop = '25px'; 
    indicacionesGeneralesDiv.style.paddingTop = '15px';
    indicacionesGeneralesDiv.style.borderTop = '1px solid #e0e0e0';

    const indicacionesLabel = document.createElement('h4');
    indicacionesLabel.textContent = 'Indicaciones Adicionales:';
    indicacionesLabel.style.marginBottom = '8px';
    indicacionesLabel.style.color = '#173b4c';

    const indicacionesTextarea = document.createElement('textarea');
    indicacionesTextarea.id = 'minuta-indicaciones-generales-textarea'; 
    indicacionesTextarea.rows = 4;
    indicacionesTextarea.placeholder = 'Ej: Mantener una buena hidratación, realizar actividad física regularmente...';
    indicacionesTextarea.style.width = '100%';
    indicacionesTextarea.style.minHeight = '80px';
    indicacionesTextarea.style.padding = '8px';
    indicacionesTextarea.style.border = '2px solid #62f485';
    indicacionesTextarea.style.borderRadius = '4px';
    indicacionesTextarea.style.boxSizing = 'border-box';
    indicacionesTextarea.style.backgroundColor = "#f9fff9";

    // PRE-POBLAR SI YA EXISTEN INDICACIONES GENERALES GUARDADAS
    if (data.indicaciones_generales_minuta) { 
        indicacionesTextarea.value = data.indicaciones_generales_minuta;
    }

    indicacionesGeneralesDiv.appendChild(indicacionesLabel);
    indicacionesGeneralesDiv.appendChild(indicacionesTextarea);
    minutaModalBody.appendChild(indicacionesGeneralesDiv);
}

    function closeMinutaModal() {
        minutaModal.style.display = 'none';
        minutaModalBody.innerHTML = '';
        currentGeneratedMinutaData = null;
        if (minutaModalStatus) minutaModalStatus.textContent = '';
    }

    // --- NUEVAS FUNCIONES PARA LOS BOTONES DEL MODAL ---

    function getMinutaHtmlForExport() {
        // Clonamos el nodo para no afectar el original con manipulaciones de estilo
        const contentToExport = minutaModalBody.cloneNode(true);

        // Sincronizar el valor actual del textarea antes de exportar ---
        const originalTextarea = document.getElementById('minuta-indicaciones-generales-textarea');
        const clonedTextarea = contentToExport.querySelector('#minuta-indicaciones-generales-textarea');
        if (originalTextarea && clonedTextarea) {
            clonedTextarea.value = originalTextarea.value;
        }
        

        // AGREGAR FECHA
        const titleElement = contentToExport.querySelector('h3');
        if (titleElement) {
            // Crear elemento de fecha
            const dateP = document.createElement('p');
            dateP.style.textAlign = 'left';
            dateP.style.color = '#173b4c';
            dateP.style.fontSize = '12px';
            dateP.style.marginBottom = '10px';
            dateP.style.fontWeight = 'normal';
            
            // Obtener fecha de la minuta actual
            let fechaFormateada;
            
            // Si es una minuta histórica obtener la fecha del selector
            if (isViewingHistoricalMinuta && minutaDateSelectorEl.value !== "current") {
                const selectedOptionText = minutaDateSelectorEl.options[minutaDateSelectorEl.selectedIndex].text;
                // Extraer la fecha del texto "Minuta del etc"
                fechaFormateada = selectedOptionText.replace("Minuta del ", "");
            }
            // Si tenemos datos de la minuta actual editable
            else if (currentGeneratedMinutaData && currentGeneratedMinutaData.fecha_minuta) {
                const fecha = new Date(currentGeneratedMinutaData.fecha_minuta);
                fechaFormateada = fecha.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            //fallback a fecha actual
            else {
                const today = new Date();
                fechaFormateada = today.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            dateP.textContent = `Fecha: ${fechaFormateada}`;
            
            // Insertar antes del título
            titleElement.parentNode.insertBefore(dateP, titleElement);
            
            // AGREGAR INSTRUCCIONES
            const instructionP = document.createElement('p');
            instructionP.style.textAlign = 'center';
            instructionP.style.fontStyle = 'normal';
            instructionP.style.color = '#173b4c';
            instructionP.style.marginBottom = '20px';
            instructionP.style.fontSize = '14px';
            instructionP.textContent = 'Escoja 1 de las opciones por cada grupo de alimentos';
            
            // Insertar después del título
            titleElement.parentNode.insertBefore(instructionP, titleElement.nextSibling);
        }
        
        // Convertir textareas a divs con <pre> para preservar saltos de línea
        // y hacerlos no editables para la exportación.
        const textareas = contentToExport.querySelectorAll('textarea');
        textareas.forEach(ta => {
            const pre = document.createElement('pre');
            pre.textContent = ta.value;
            pre.style.fontFamily = 'inherit'; 
            pre.style.whiteSpace = 'pre-wrap'; 
            pre.style.margin = '0';
            pre.style.padding = '5px';
            pre.style.border = '1px solid #ddd'; 
            pre.style.backgroundColor = '#f9f9f9';
            ta.parentNode.replaceChild(pre, ta);
        });
        const indicacionesGeneralesContainerCloned = contentToExport.querySelector('#minuta-indicaciones-generales-container');
        if (indicacionesGeneralesContainerCloned) {
            const textareaIndicaciones = indicacionesGeneralesContainerCloned.querySelector('pre');
            if (textareaIndicaciones && textareaIndicaciones.textContent.trim() !== "") {
            } else if (textareaIndicaciones) {
                indicacionesGeneralesContainerCloned.parentNode.removeChild(indicacionesGeneralesContainerCloned);
            } else {
                 const originalIndicacionesTextareaCheck = document.getElementById('minuta-indicaciones-generales-textarea');
                 if (!originalIndicacionesTextareaCheck || originalIndicacionesTextareaCheck.value.trim() === "") {
                    if(indicacionesGeneralesContainerCloned.parentNode) { 
                        indicacionesGeneralesContainerCloned.parentNode.removeChild(indicacionesGeneralesContainerCloned);
                    }
                 }
            }
        }
        return contentToExport.innerHTML;
    }

    async function handleSaveMinutaPdf() {
        if (!minutaModalBody || !minutaModalBody.innerHTML.trim()) {
            showMinutaPopup("No hay contenido en la minuta para generar el PDF.", false);
            return;
        }
        
        if (minutaModalStatus) {
            minutaModalStatus.textContent = 'Generando PDF...';
            minutaModalStatus.className = 'single-save-status info';
        }
        
        saveMinutaPdfBtn.disabled = true;
        sendMinutaEmailBtn.disabled = true;

        try {
            const element = document.createElement('div');
            element.style.width = '100%';
            element.style.padding = '20px';
            element.style.fontFamily = 'Arial, sans-serif';
            element.style.color = '#173b4c';
            
            const contentClone = minutaModalBody.cloneNode(true);
            
            const textareas = contentClone.querySelectorAll('textarea');
            textareas.forEach(ta => {
                const div = document.createElement('div');
                div.style.whiteSpace = 'pre-wrap';
                div.style.border = '1px solid #e0e0e0';
                div.style.padding = '5px';
                div.style.marginBottom = '10px';
                div.style.backgroundColor = '#f9f9f9';
                div.style.borderRadius = '4px';
                div.textContent = ta.value;
                ta.parentNode.replaceChild(div, ta);
            });

            const styles = `
                <style>
                    body { 
                        font-family: Arial, sans-serif;
                        color: #173b4c;
                        font-size: 14px;
                        line-height: 1.4;
                    }
                    h2, h3, h4 { 
                        color: #173b4c;
                        margin-bottom: 0.5em;
                    }
                    h2 { font-size: 1.3rem; }
                    h3 { font-size: 1.2rem; }
                    h4 { font-size: 1.1rem; }
                    .minuta-tiempo-comida { 
                        margin-bottom: 20px; 
                        page-break-inside: avoid;
                        border-bottom: 1px solid #e0e0e0;
                        padding-bottom: 15px;
                    }
                    .minuta-grupo-alimento { 
                        margin-bottom: 15px;
                        margin-left: 10px;
                    }
                    .hora-sugerida {
                        font-style: italic;
                        color: #62f485;
                        margin-bottom: 10px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                    }
                    th, td {
                        border: 1px solid #e0e0e0;
                        padding: 8px 12px;
                        text-align: left;
                    }
                    th {
                        background-color: #f8f9fa;
                        color: #173b4c;
                        font-weight: 600;
                    }
                    #minuta-indicaciones-generales-container {
                        margin-top: 25px;
                        padding-top: 15px;
                        border-top: 1px solid #e0e0e0;
                    }
                    pre { /* Si getMinutaHtmlForExport ya convierte a <pre> */
                        white-space: pre-wrap;
                        font-family: inherit;
                        margin: 0;
                        padding: 8px;
                        border: 1px dashed #eee;
                        background-color: #fdfdfd;
                    }
                    @page {
                        size: A4;
                        margin: 15mm 10mm;
                    }
                </style>
            `;
            
            
            element.innerHTML += styles + getMinutaHtmlForExport();


            const opt = {
                margin: [15, 10, 15, 10],
                filename: `minuta_${(PACIENTE_NOMBRE_COMPLETO_FROM_DJANGO || PACIENTE_ID)}.pdf`.replace(/\s+/g, '_'),
                image: { 
                    type: 'jpeg', 
                    quality: 0.98 
                },
                html2canvas: { 
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    letterRendering: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                },
            };

            await new Promise(resolve => setTimeout(resolve, 300));
            
            await html2pdf().set(opt).from(element).save();
            
            if (minutaModalStatus) {
                minutaModalStatus.textContent = 'PDF generado exitosamente';
                minutaModalStatus.className = 'single-save-status success';
            }
        } catch (error) {
            console.error("Error al generar PDF:", error);
            if (minutaModalStatus) {
                minutaModalStatus.textContent = 'Error al generar PDF';
                minutaModalStatus.className = 'single-save-status error';
            }
            showMinutaPopup('Error al generar el PDF: ' + error.message, false);
        } finally {
            saveMinutaPdfBtn.disabled = false;
            sendMinutaEmailBtn.disabled = false;
        }
    }

    async function handleSendMinutaEmail() {
        if (!minutaModalBody || !minutaModalBody.innerHTML.trim()) {
            alert("No hay contenido en la minuta para enviar por correo.");
            return;
        }
        saveMinutaPdfBtn.disabled = true;
        sendMinutaEmailBtn.disabled = true;

        const minutaHtmlContent = getMinutaHtmlForExport();

        try {
            const csrfToken = getCookie('csrftoken');
            const response = await fetch(`/patients/${PACIENTE_ID}/enviar_minuta_por_correo/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ minuta_html: minutaHtmlContent })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showMinutaPopup(result.message || 'Correo enviado exitosamente.', true);
            } else {
                throw new Error(result.message || 'Error al enviar el correo.');
            }
        } catch (error) {
            console.error("Error enviando correo:", error);
            showMinutaPopup(`Error: ${error.message}`, false);
        } finally {
            saveMinutaPdfBtn.disabled = false;
            sendMinutaEmailBtn.disabled = false;
        }
    }

    // --- FUNCIONES PARA ADECUACIÓN ---
    async function fetchAdecuacionData() {
        if (!PACIENTE_ID) {
            return { data: null, status: 'error', message: "ID de paciente no disponible." };
        }
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "Actualizando datos de adecuación...";
            adecuacionStatusEl.className = 'loading';
            adecuacionStatusEl.style.display = 'block';
        }

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_adecuacion_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                if (result && result.status === "not_found") {
                    return { data: null, status: 'not_found', message: result.mensaje };
                }
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            
            if (result.status === "success" && result.data) {
                return { data: result.data, status: 'success' };
            } else if (result.status === "not_found") { 
                return { data: null, status: 'not_found', message: result.mensaje };
            } else {
                throw new Error(result.mensaje || "Formato de respuesta inesperado para adecuación.");
            }
        } catch (error) {
            console.error("Error al obtener datos de adecuación:", error);
            return { data: null, status: 'error', message: error.message };
        }
    }
    function displayAdecuacionData(apiResponse) {  
        if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = '- %';
        if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = '- %';
        if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = '- %';
        if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = '- %';

        if (!adecuacionStatusEl) return;

        if (apiResponse.status === 'success' && apiResponse.data) {
            const data = apiResponse.data;
            if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = `${parseFloat(data.porc_adecuacion_calorico).toFixed(2)} %`;
            if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = `${parseFloat(data.porc_adec_proteinas).toFixed(2)} %`;
            if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = `${parseFloat(data.porc_adec_carbohidratos).toFixed(2)} %`;
            if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = `${parseFloat(data.porc_adec_lipidos).toFixed(2)} %`;
            
            adecuacionStatusEl.textContent = "Datos de adecuación actualizados."; 
            adecuacionStatusEl.className = 'success';
            adecuacionStatusEl.style.display = 'none'; 
        } else if (apiResponse.status === 'not_found') {
            adecuacionStatusEl.textContent = apiResponse.message || "Aún no hay porcentajes de adecuación. ¡Aparecerán una vez que agregues el primer tiempo de comida!";
            adecuacionStatusEl.className = 'info'; 
            adecuacionStatusEl.style.display = 'block';
        } else { 
            adecuacionStatusEl.textContent = `Error al cargar adecuación: ${apiResponse.message || 'Desconocido.'}`;
            adecuacionStatusEl.className = 'error';
            adecuacionStatusEl.style.display = 'block';
        }
    }
    async function loadAndDisplayAdecuacion() {  
        const adecuacionApiResponse = await fetchAdecuacionData();
        displayAdecuacionData(adecuacionApiResponse);
    }

    // --- FUNCIONES PARA DATOS BASE Y DETALLES GUARDADOS ---
    async function fetchApiData(url, type) {  
        try {
            const response = await fetch(url);
            if (!response.ok) {
                 const errorData = await response.text();
                throw new Error(`Error HTTP ${response.status} al obtener ${type}: ${errorData}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Error en fetchApiData para ${type}:`, error);
            if(generalStatusDiv) {
                generalStatusDiv.textContent = `Error al cargar ${type}. ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            throw error; 
        }
    }
    async function fetchSavedMinutaDetails() {  
         if (!PACIENTE_ID) {
             return null;
        }
        try {
            // Este endpoint obtiene la minuta "actual" o la "última editable"
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_detalle_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();
            if (!response.ok) {
                if (response.status === 404 || (result && result.status === 'not_found')) return []; 
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            if (result.status === 'success' && result.data && Array.isArray(result.data.detalles_minuta)) return result.data.detalles_minuta; 
            else if (result.status === 'not_found') return [];
            else { console.warn("fetchSavedMinutaDetails: Formato inesperado", result); return []; }
        } catch (error) {
            console.error("Error en fetchSavedMinutaDetails:", error);
            if(generalStatusDiv && generalStatusDiv.textContent.indexOf('Error al cargar detalles guardados') === -1) {
                generalStatusDiv.textContent += ` | Error al cargar detalles guardados: ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            return null; 
        }
    }

    // --- FUNCIONES DE MANEJO DEL DOM Y ESTADO ---
    function updateAddMealButtonState() {  
        if (!addMealTimeBtn) return;
        // Solo mostrar si no estamos viendo una minuta histórica Y hay tiempos disponibles
        const availableTimes = getAvailableMealTimes();
        if (!isViewingHistoricalMinuta && availableTimes.length > 0) {
            addMealTimeBtn.style.display = 'block';
            addMealTimeBtn.disabled = false;
        } else {
            addMealTimeBtn.style.display = 'none';
            addMealTimeBtn.disabled = true;
        }
    }

    function getSelectedMealTimeIds() {  
        const selected = [];
        if(mealTimesContainer) {
            mealTimesContainer.querySelectorAll('.meal-time-select').forEach(select => {
                if (select.value) selected.push(parseInt(select.value));
            });
        }
        return selected;
    }
    function getAvailableMealTimes() {  
        const selectedIds = getSelectedMealTimeIds();
        return ALL_MEAL_TIMES_DATA.filter(time => !selectedIds.includes(time.id_tiempo_comida));
    }
    function populateSelectWithOptions(selectElement, availableTimes, currentValue) {  
        selectElement.innerHTML = ''; 
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "-- Seleccione Tiempo --";
        selectElement.appendChild(placeholder);

        if (currentValue) {
            const currentOptionData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === currentValue);
            if (currentOptionData) {
                const opt = document.createElement('option');
                opt.value = currentOptionData.id_tiempo_comida;
                opt.textContent = currentOptionData.descripcion;
                selectElement.appendChild(opt);
                opt.selected = true; 
            } else { 
                 placeholder.selected = true;
            }
        } else {
            placeholder.selected = true;
        }
        availableTimes.forEach(time => {
            if (time.id_tiempo_comida !== currentValue) {
                const option = document.createElement('option');
                option.value = time.id_tiempo_comida;
                option.textContent = time.descripcion;
                selectElement.appendChild(option);
            }
        });
        if (!selectElement.value && selectElement.options.length > 0) {
            placeholder.selected = true;
        }
    }
    function updateAllSelects() {  
        if(!mealTimesContainer) return;
        const allSelects = mealTimesContainer.querySelectorAll('.meal-time-select');
        const selectedIdsOverall = getSelectedMealTimeIds();
        allSelects.forEach(currentSelect => {
            const currentValueForThisSelect = currentSelect.value ? parseInt(currentSelect.value) : null;
            const availableForThisSelect = ALL_MEAL_TIMES_DATA.filter(time => {
                return time.id_tiempo_comida === currentValueForThisSelect || !selectedIdsOverall.includes(time.id_tiempo_comida);
            });
            populateSelectWithOptions(currentSelect, availableForThisSelect, currentValueForThisSelect);
        });
        updateAddMealButtonState(); 
    }
    function convertTo24HourFormat(timeString) {  
        if (!timeString || typeof timeString !== 'string') return '';
        const timeStringLower = timeString.toLowerCase().trim();
        const match = timeStringLower.match(/^(\d{1,2}):(\d{2})\s*(am|pm)?$/);
        if (!match) {
            // Si ya está en formato HH:MM (24h)
            if (/^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString.trim())) return timeString.trim();
            return ''; // Formato no reconocido
        }
        let hours = parseInt(match[1], 10);
        const minutes = parseInt(match[2], 10);
        const period = match[3];
        if (period === 'am' && hours === 12) hours = 0; // 12 AM es 00:00
        else if (period === 'pm' && hours !== 12) hours += 12; // 1 PM a 11 PM
        
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return ''; // Hora inválida
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    function createAndPopulateMealTimeEntry(tiempoComidaId, hora, portionsMap, isHistorical = false) {
        if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0 || !mealTimesContainer) return;
        const entryIdSuffix = mealTimeEntryCounter;
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('meal-time-entry');
        entryDiv.id = `meal-entry-${entryIdSuffix}`;
        entryDiv.dataset.entryId = entryIdSuffix;
        entryDiv.style.background = '#f8f9fa';
        entryDiv.style.padding = '15px';
        entryDiv.style.marginBottom = '15px';
        entryDiv.style.borderRadius = '8px';
        entryDiv.style.border = '1px solid #e0e0e0';

        const mainContentDiv = document.createElement('div');
        mainContentDiv.classList.add('meal-entry-main-content');

        const selectorDiv = document.createElement('div');
        selectorDiv.classList.add('meal-time-selector');
        selectorDiv.style.display = 'flex';
        selectorDiv.style.gap = '15px';
        selectorDiv.style.marginBottom = '15px';
        selectorDiv.style.alignItems = 'center';
        
        const selectLabel = document.createElement('label');
        selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
        selectLabel.textContent = `Tiempo de Comida:`;
        selectLabel.style.fontWeight = 'bold';
        selectLabel.style.color = '#173b4c';
        
        const selectElement = document.createElement('select');
        selectElement.id = `meal-time-select-${entryIdSuffix}`;
        selectElement.classList.add('meal-time-select');
        selectElement.required = true;
        selectElement.style.padding = '8px';
        selectElement.style.border = '1px solid #173b4c';
        selectElement.style.borderRadius = '4px';
        selectElement.style.flex = '1';
        selectElement.disabled = isHistorical; // Deshabilitar select si es histórico

        const availableNow = getAvailableMealTimes();
        const allOptionsForThis = [...availableNow];
        const currentTimeData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === tiempoComidaId);
        if (currentTimeData && !allOptionsForThis.some(t => t.id_tiempo_comida === tiempoComidaId)) {
            allOptionsForThis.push(currentTimeData);
            allOptionsForThis.sort((a, b) => a.id_tiempo_comida - b.id_tiempo_comida);
        }
        populateSelectWithOptions(selectElement, allOptionsForThis, tiempoComidaId);

        selectorDiv.appendChild(selectLabel);
        selectorDiv.appendChild(selectElement);

        const timeInputDiv = document.createElement('div');
        timeInputDiv.classList.add('time-input-container');
        timeInputDiv.style.display = 'flex';
        timeInputDiv.style.alignItems = 'center';
        timeInputDiv.style.gap = '10px';
        
        const timeLabel = document.createElement('label');
        timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
        timeLabel.textContent = 'Hora:';
        timeLabel.style.fontWeight = 'bold';
        timeLabel.style.color = '#173b4c';
        
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.id = `meal-hour-input-${entryIdSuffix}`;
        timeInput.classList.add('meal-hour-input');
        timeInput.required = true;
        timeInput.value = convertTo24HourFormat(hora);
        timeInput.readOnly = isHistorical; // Hacerlo readonly si es histórico
        timeInput.style.padding = '8px';
        timeInput.style.border = '1px solid #173b4c';
        timeInput.style.borderRadius = '4px';
        
        timeInputDiv.appendChild(timeLabel);
        timeInputDiv.appendChild(timeInput);
        selectorDiv.appendChild(timeInputDiv);

        mainContentDiv.appendChild(selectorDiv);

        const tableDiv = document.createElement('div');
        tableDiv.classList.add('food-portions-table');
        tableDiv.style.overflowX = 'auto';
        
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '10px';
        
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#173b4c';
        headerRow.style.color = 'white';
        
        foodGroupsData.forEach(group => {
            const th = document.createElement('th');
            th.textContent = group.descripcion;
            th.dataset.grupoId = group.id_grupo_alimenticio;
            th.style.padding = '10px';
            th.style.textAlign = 'center';
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        const tbody = document.createElement('tbody');
        const inputRow = document.createElement('tr');
        
        foodGroupsData.forEach(group => {
            const td = document.createElement('td');
            td.style.padding = '10px';
            td.style.textAlign = 'center';
            td.style.borderBottom = '1px solid #e0e0e0';
            
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '0.1';
            input.placeholder = '0';
            input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
            input.dataset.grupoId = group.id_grupo_alimenticio;
            input.readOnly = isHistorical; // Hacerlo readonly si es histórico
            input.style.width = '80%';
            input.style.padding = '8px';
            input.style.border = '1px solid #173b4c';
            input.style.borderRadius = '4px';
            input.style.textAlign = 'center';
            
            const savedPortion = portionsMap[group.id_grupo_alimenticio];
            if (savedPortion !== undefined && savedPortion !== null) input.value = savedPortion;
            
            td.appendChild(input);
            inputRow.appendChild(td);
        });
        
        tbody.appendChild(inputRow);
        table.appendChild(tbody);
        tableDiv.appendChild(table);

        mainContentDiv.appendChild(tableDiv);
        entryDiv.appendChild(mainContentDiv);

        // No agregar botones de Guardar/Eliminar si es histórico
        if (!isHistorical) {
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('meal-entry-actions');
            actionsDiv.style.display = 'flex';
            actionsDiv.style.justifyContent = 'flex-end';
            actionsDiv.style.gap = '10px';
            actionsDiv.style.marginTop = '15px';

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Guardar';
            saveButton.classList.add('save-single-meal-btn');
            saveButton.type = 'button';
            saveButton.style.backgroundColor = '#173b4c';
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.padding = '8px 16px';
            saveButton.style.borderRadius = '4px';
            saveButton.style.cursor = 'pointer';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Eliminar';
            deleteButton.classList.add('delete-single-meal-btn');
            deleteButton.type = 'button';
            deleteButton.style.backgroundColor = '#dc3545';
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.padding = '8px 16px';
            deleteButton.style.borderRadius = '4px';
            deleteButton.style.cursor = 'pointer';

            const statusDiv = document.createElement('div');
            statusDiv.classList.add('single-save-status');
            statusDiv.style.flex = '1';
            statusDiv.style.textAlign = 'right';
            statusDiv.style.padding = '8px';

            saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
            deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));

            actionsDiv.appendChild(saveButton);
            actionsDiv.appendChild(deleteButton);
            actionsDiv.appendChild(statusDiv);

            entryDiv.appendChild(actionsDiv);
        }

        mealTimesContainer.appendChild(entryDiv);
        if (!isHistorical) {
            selectElement.addEventListener('change', updateAllSelects);
        }
        mealTimeEntryCounter++;
    }

    function processAndDisplaySavedDetails(savedDetailsArray, isHistorical = false) {
        if (!Array.isArray(savedDetailsArray) || savedDetailsArray.length === 0) {
            if(generalStatusDiv && generalStatusDiv.className === 'info' && !isHistorical) generalStatusDiv.textContent = "No hay tiempos de comida guardados para la minuta actual.";
            else if (isHistorical) mealTimesContainer.innerHTML = "<p style='text-align:center; padding:20px;'>No se encontraron detalles para esta minuta histórica.</p>";
            return;
        }
        mealTimesContainer.innerHTML = ''; // Limpiar siempre antes de poblar
        mealTimeEntryCounter = 0; // Resetear contador


        const groupedDetails = savedDetailsArray.reduce((acc, detail) => {
            const tiempoId = detail.id_tiempo_comida;
            if (!acc[tiempoId]) {
                acc[tiempoId] = {
                    hora: detail.hora_tiempo_comida,
                    tiempoData: ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === tiempoId),
                    portions: {}
                };
            }
            // Asegurarse de que tiempoData exista para evitar errores
            if (acc[tiempoId].tiempoData) {
                acc[tiempoId].portions[detail.id_grupo_alimenticio] = detail.numero_porciones_grupo;
            } else {
                console.warn(`Tiempo de comida ID ${tiempoId} de detalle no encontrado en datos base. Omitiendo.`);
            }
            return acc;
        }, {});

        const sortedDetails = Object.values(groupedDetails)
            .filter(detail => detail.tiempoData) // Filtrar los que no tienen tiempoData (p.ej. un tiempo de comida eliminado de la DB)
            .sort((a, b) => {
                const timeToMinutes = timeStr => {
                    // `convertTo24HourFormat` espera "HH:MM AM/PM" o "HH:MM"
                    // La API devuelve "08:00 AM", lo cual `convertTo24HourFormat` debe manejar
                    const formattedTime = convertTo24HourFormat(timeStr);
                    if (!formattedTime) return 0; // Manejar horas inválidas o no convertibles
                    const [hours, minutes] = formattedTime.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                return timeToMinutes(a.hora) - timeToMinutes(b.hora);
            });

        sortedDetails.forEach(detail => {
            createAndPopulateMealTimeEntry(
                detail.tiempoData.id_tiempo_comida,
                detail.hora, // Usar la hora tal como viene de la API
                detail.portions,
                isHistorical // Pasar el flag
            );
        });

        if (!isHistorical) {
            updateAllSelects(); // Solo actualizar selects si no es histórico (para mantenerlos deshabilitados)
        }
    }

    function addMealTimeEntry() {  
         if (isViewingHistoricalMinuta) {
            showMinutaPopup("No se pueden agregar tiempos de comida a una minuta histórica.", false);
            return;
        }
         if (!mealTimesContainer || !addMealTimeBtn) return; 
         if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0) {
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Datos base no cargados.";
                 generalStatusDiv.className = 'warning';
             }
             return;
         }
         const entryIdSuffix = mealTimeEntryCounter;
         const entryDiv = document.createElement('div');
         entryDiv.classList.add('meal-time-entry');
         entryDiv.id = `meal-entry-${entryIdSuffix}`;
         entryDiv.dataset.entryId = entryIdSuffix;
         entryDiv.style.background = '#f8f9fa';
         entryDiv.style.padding = '15px';
         entryDiv.style.marginBottom = '15px';
         entryDiv.style.borderRadius = '8px';
         entryDiv.style.border = '1px solid #e0e0e0';

         const contentAboveActionsDiv = document.createElement('div');
         contentAboveActionsDiv.classList.add('meal-entry-content-above-actions');

         const selectorDiv = document.createElement('div');
         selectorDiv.classList.add('meal-time-selector');
         selectorDiv.style.display = 'flex';
         selectorDiv.style.gap = '15px';
         selectorDiv.style.marginBottom = '15px';
         selectorDiv.style.alignItems = 'center';
         
         const selectLabel = document.createElement('label');
         selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
         selectLabel.textContent = `Nuevo Tiempo de Comida:`;
         selectLabel.style.fontWeight = 'bold';
         selectLabel.style.color = '#173b4c';
         
         const selectElement = document.createElement('select');
         selectElement.id = `meal-time-select-${entryIdSuffix}`;
         selectElement.classList.add('meal-time-select');
         selectElement.required = true;
         selectElement.style.padding = '8px';
         selectElement.style.border = '1px solid #173b4c';
         selectElement.style.borderRadius = '4px';
         selectElement.style.flex = '1';
         
         const availableTimes = getAvailableMealTimes();
         populateSelectWithOptions(selectElement, availableTimes, null); 
         
         selectorDiv.appendChild(selectLabel);
         selectorDiv.appendChild(selectElement);

         const timeInputDiv = document.createElement('div');
         timeInputDiv.classList.add('time-input-container');
         timeInputDiv.style.display = 'flex';
         timeInputDiv.style.alignItems = 'center';
         timeInputDiv.style.gap = '10px';
         
         const timeLabel = document.createElement('label');
         timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
         timeLabel.textContent = 'Hora:';
         timeLabel.style.fontWeight = 'bold';
         timeLabel.style.color = '#173b4c';
         
         const timeInput = document.createElement('input');
         timeInput.type = 'time';
         timeInput.id = `meal-hour-input-${entryIdSuffix}`;
         timeInput.classList.add('meal-hour-input');
         timeInput.required = true;
         timeInput.style.padding = '8px';
         timeInput.style.border = '1px solid #173b4c';
         timeInput.style.borderRadius = '4px';
         
         timeInputDiv.appendChild(timeLabel);
         timeInputDiv.appendChild(timeInput);
         selectorDiv.appendChild(timeInputDiv);
         contentAboveActionsDiv.appendChild(selectorDiv);

         const tableDiv = document.createElement('div');
         tableDiv.classList.add('food-portions-table');
         tableDiv.style.overflowX = 'auto';
         
         const table = document.createElement('table');
         table.style.width = '100%';
         table.style.borderCollapse = 'collapse';
         table.style.marginTop = '10px';
         
         const thead = document.createElement('thead');
         const headerRow = document.createElement('tr');
         headerRow.style.backgroundColor = '#173b4c';
         headerRow.style.color = 'white';
         
         foodGroupsData.forEach(group => {
             const th = document.createElement('th');
             th.textContent = group.descripcion;
             th.dataset.grupoId = group.id_grupo_alimenticio;
             th.style.padding = '10px';
             th.style.textAlign = 'center';
             headerRow.appendChild(th);
         });
         thead.appendChild(headerRow);
         table.appendChild(thead);
         
         const tbody = document.createElement('tbody');
         const inputRow = document.createElement('tr');
         
         foodGroupsData.forEach(group => {
             const td = document.createElement('td');
             td.style.padding = '10px';
             td.style.textAlign = 'center';
             td.style.borderBottom = '1px solid #e0e0e0';
             
             const input = document.createElement('input');
             input.type = 'number';
             input.min = '0';
             input.step = '0.1';
             input.placeholder = '0';
             input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
             input.dataset.grupoId = group.id_grupo_alimenticio;
             input.style.width = '80%';
             input.style.padding = '8px';
             input.style.border = '1px solid #173b4c';
             input.style.borderRadius = '4px';
             input.style.textAlign = 'center';
             
             td.appendChild(input);
             inputRow.appendChild(td);
         });
         
         tbody.appendChild(inputRow);
         table.appendChild(tbody);
         tableDiv.appendChild(table);
         contentAboveActionsDiv.appendChild(tableDiv);
         entryDiv.appendChild(contentAboveActionsDiv);

         const actionsDiv = document.createElement('div');
         actionsDiv.classList.add('meal-entry-actions');
         actionsDiv.style.display = 'flex';
         actionsDiv.style.justifyContent = 'flex-end';
         actionsDiv.style.gap = '10px';
         actionsDiv.style.marginTop = '15px';
         
         const saveButton = document.createElement('button');
         saveButton.textContent = 'Guardar';
         saveButton.classList.add('save-single-meal-btn');
         saveButton.type = 'button';
         saveButton.style.backgroundColor = '#173b4c';
         saveButton.style.color = 'white';
         saveButton.style.border = 'none';
         saveButton.style.padding = '8px 16px';
         saveButton.style.borderRadius = '4px';
         saveButton.style.cursor = 'pointer';
         
         const deleteButton = document.createElement('button'); 
         deleteButton.textContent = 'Eliminar';
         deleteButton.classList.add('delete-single-meal-btn');
         deleteButton.type = 'button';
         deleteButton.style.backgroundColor = '#dc3545';
         deleteButton.style.color = 'white';
         deleteButton.style.border = 'none';
         deleteButton.style.padding = '8px 16px';
         deleteButton.style.borderRadius = '4px';
         deleteButton.style.cursor = 'pointer';
         
         const statusDiv = document.createElement('div');
         statusDiv.classList.add('single-save-status');
         statusDiv.style.flex = '1';
         statusDiv.style.textAlign = 'right';
         statusDiv.style.padding = '8px';
         
         saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         
         actionsDiv.appendChild(saveButton);
         actionsDiv.appendChild(deleteButton);
         actionsDiv.appendChild(statusDiv);
         entryDiv.appendChild(actionsDiv);

         mealTimesContainer.appendChild(entryDiv);
         selectElement.addEventListener('change', updateAllSelects);
         mealTimeEntryCounter++;
         updateAllSelects(); 
         reorderMealTimesByTime();
    }
    function reorderMealTimesByTime() {  
        const entries = Array.from(mealTimesContainer.querySelectorAll('.meal-time-entry'));
        
        if (entries.length <= 1) return; 
        
        const entriesData = entries.map(entry => {
            const select = entry.querySelector('.meal-time-select');
            const timeInput = entry.querySelector('.meal-hour-input');
            return {
                element: entry,
                tiempoId: select.value,
                hora: timeInput.value, // HH:MM
                tiempoText: select.options[select.selectedIndex].text
            };
        });
        
        entriesData.sort((a, b) => {
            const timeToMinutes = timeStr => {
                if (!timeStr) return -1; // Manejar hora vacía poniéndola al inicio o final
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + (minutes || 0) ; // Si minutes es NaN, tratar como 0
            };
            return timeToMinutes(a.hora) - timeToMinutes(b.hora);
        });
        
        mealTimesContainer.innerHTML = '';
        entriesData.forEach(data => {
            mealTimesContainer.appendChild(data.element);
        });
    }

    // --- FUNCIÓN DE GUARDADO INDIVIDUAL ---
    async function handleSaveSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) { 
        saveBtn.disabled = true;
        if (deleteBtn) deleteBtn.disabled = true;
        statusEl.textContent = 'Guardando...';
        statusEl.className = 'single-save-status info';

        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const horaTiempoComidaInput = entryElement.querySelector('.meal-hour-input');
        const tiempoComidaId = tiempoComidaSelect.value;
        const horaTiempoComida = horaTiempoComidaInput.value; 
        let hasValidationError = false;

        if (!tiempoComidaId) { tiempoComidaSelect.style.borderColor = 'red'; hasValidationError = true; } 
        else { tiempoComidaSelect.style.borderColor = ''; }
        if (!horaTiempoComida) { horaTiempoComidaInput.style.borderColor = 'red'; hasValidationError = true; } 
        else { horaTiempoComidaInput.style.borderColor = ''; }

        if (hasValidationError) {
            statusEl.textContent = 'Complete tiempo y hora.';
            statusEl.className = 'single-save-status error';
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
            return;
        }

        const detallePromises = [];
        const porcionesInputs = entryElement.querySelectorAll('.food-portions-table input[type="number"]');
        porcionesInputs.forEach(input => {
            const numeroPorciones = parseFloat(input.value);
            if (!isNaN(numeroPorciones) && numeroPorciones >= 0) { 
                const grupoAlimenticioId = input.dataset.grupoId;
                const payload = {
                    pacienteId: PACIENTE_ID,
                    numeroPorcionesGrupo: numeroPorciones, 
                    grupoAlimenticioId: parseInt(grupoAlimenticioId),
                    tiempoComidaId: parseInt(tiempoComidaId),
                    horaTiempoComida: horaTiempoComida
                };
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
                detallePromises.push(
                    fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_detalle_minuta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payload)
                    }).then(response => {
                        if (!response.ok) {
                             return response.json().then(err => { throw new Error(`Error detalle ${response.status}: ${err.detail || JSON.stringify(err)}`); });
                        }
                        return response.json();
                    })
                );
            } else if (input.value.trim() !== '') { 
                 input.style.borderColor = 'orange'; 
            } else {
                input.style.borderColor = ''; 
            }
        });

        try {
            if (detallePromises.length > 0) {
                await Promise.all(detallePromises);
                statusEl.textContent = 'Porciones guardadas. Actualizando adecuación...';
            } else {
                 statusEl.textContent = 'No hay porciones (>=0) especificadas. Actualizando adecuación...';
            }
            statusEl.className = 'single-save-status info';

            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
            const adecuacionPayload = { pacienteId: PACIENTE_ID };
            const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(adecuacionPayload)
            });

            if (!adecuacionResponse.ok) {
                const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación."}));
                throw new Error(`Error al guardar adecuación ${adecuacionResponse.status}: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
            }

            await loadAndDisplayAdecuacion(); 
            
            statusEl.textContent = 'Guardado exitosamente.';
            statusEl.className = 'single-save-status success';
            setTimeout(() => { 
                 if (statusEl.className === 'single-save-status success') statusEl.textContent = '';
            }, 3000);

        } catch (error) {
            console.error("Error en guardado individual:", error);
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'single-save-status error';
        } finally {
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false; 
            updateAddMealButtonState(); 
        }
    }

    // --- FUNCIÓN PARA ELIMINAR ---
    async function handleDeleteSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) {  
        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const tiempoComidaId = tiempoComidaSelect.value;

        if (!tiempoComidaId) {
            // Si no hay tiempo de comida seleccionado, simplemente eliminar el elemento
            entryElement.remove();
            updateAllSelects();
            return;
        }

const { value: confirmDelete } = await Swal.fire({
    icon: 'warning',
    title: 'Confirmar eliminación',
    html: `¿Está seguro de que desea eliminar todos los datos para el tiempo de comida 
        <strong>"${tiempoComidaSelect.options[tiempoComidaSelect.selectedIndex].text}"</strong>?<br><br>
        <span style="color: #dc3545;">Esta acción no se puede deshacer.</span>`,
    showCancelButton: true,
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    reverseButtons: true,
    focusCancel: true,
    customClass: {
        confirmButton: 'button-primary',
        cancelButton: 'button-secondary'
    }
});

if (!confirmDelete) {
    return;
}

saveBtn.disabled = true;
deleteBtn.disabled = true;
statusEl.textContent = 'Eliminando...';
statusEl.className = 'single-save-status info';

const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
try {
    const url = new URL('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/eliminar_detalle_ultima_minuta');
    url.searchParams.append('pacienteId', PACIENTE_ID);
    url.searchParams.append('tiempoComidaId', tiempoComidaId);

    const deleteResponse = await fetch(url.toString(), {
        method: 'DELETE',
        headers: { 'X-CSRFToken': csrfToken }
    });

    const result = await deleteResponse.json();

    if (!deleteResponse.ok) {
        statusEl.textContent = result.mensaje || `Error al eliminar ${deleteResponse.status}`;
        statusEl.className = 'single-save-status error';
    } else {
        statusEl.textContent = result.mensaje || 'Eliminado exitosamente.';
        statusEl.className = 'single-save-status success';
    }

} catch (error) {
    console.error("Error al eliminar tiempo de comida:", error);
    statusEl.textContent = `Error: ${error.message}`;
    statusEl.className = 'single-save-status error';
} finally {
    // Independientemente del resultado de la API, eliminar el elemento del DOM
    entryElement.remove();
    updateAllSelects();
    saveBtn.disabled = false;
    deleteBtn.disabled = false;

    statusEl.textContent = 'Actualizando adecuación...';
    statusEl.className = 'single-save-status info';

    const adecuacionPayload = { pacienteId: PACIENTE_ID };
    const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(adecuacionPayload)
    });
    if (!adecuacionResponse.ok) {
        const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación post-eliminación."}));
        console.warn(`Advertencia al guardar adecuación post-eliminación: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
    }
    await loadAndDisplayAdecuacion();
}
}
    function getCookie(name) {  
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- INICIALIZACIÓN DE LA PÁGINA ---
    async function initializePage() {
        if(addMealTimeBtn) {
            addMealTimeBtn.style.display = 'none'; 
            addMealTimeBtn.disabled = true;
        }
        if(generateMinutaBtn && PACIENTE_ID === null) { 
             generateMinutaBtn.disabled = true;
        }

        if(mealTimesContainer) mealTimesContainer.innerHTML = ''; 
        mealTimeEntryCounter = 0; 

        const [adecuacionResponse, mealTimes, foodGroups, savedDetails] = await Promise.all([
            fetchAdecuacionData(),
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id', 'tiempos de comida').catch(e => {console.error("Error cargando tiempos de comida:", e); return null;}), 
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id', 'grupos alimenticios').catch(e => {console.error("Error cargando grupos alimenticios:", e); return null;}),
            fetchSavedMinutaDetails().catch(e => {console.error("Error cargando detalles guardados:", e); return null;}) // Carga la minuta actual/editable por defecto
        ]).catch(error => {
             console.error("Error en Promise.all de initializePage:", error);
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Error crítico al cargar datos iniciales.";
                 generalStatusDiv.className = 'error';
             }
             return [null, null, null, null]; 
        });

        displayAdecuacionData(adecuacionResponse || { status: 'error', message: 'Fallo carga adecuación.' });

        if (!mealTimes || !foodGroups) {
             if(generalStatusDiv && generalStatusDiv.className !== 'error') { 
                 generalStatusDiv.textContent = "Error: No se pudieron cargar los datos base (tiempos/grupos).";
                 generalStatusDiv.className = 'error';
             }
             updateAddMealButtonState(); 
             return; 
        }

        ALL_MEAL_TIMES_DATA = mealTimes; 
        foodGroupsData = foodGroups;     

        if (savedDetails && savedDetails.length > 0) {
            processAndDisplaySavedDetails(savedDetails, false); // false porque es la minuta actual editable
            isViewingHistoricalMinuta = false;
            toggleEditableState(true);
        } else if (savedDetails === null && generalStatusDiv && generalStatusDiv.className !== 'error') {
            // generalStatusDiv.textContent = ""; // No mostrar nada si no hay error
        } else if (generalStatusDiv && generalStatusDiv.className === 'info' && (!savedDetails || savedDetails.length === 0)) {
            generalStatusDiv.textContent = "No hay tiempos de comida guardados para la minuta actual. Puede agregar nuevos.";
            isViewingHistoricalMinuta = false;
            toggleEditableState(true);
        }

        updateAllSelects(); 
        updateAddMealButtonState();
        

        if(generalStatusDiv && generalStatusDiv.className !== 'error' && (!adecuacionStatusEl || adecuacionStatusEl.className === 'success' || adecuacionStatusEl.className === 'info')) {
             setTimeout(() => { 
                if(generalStatusDiv && generalStatusDiv.className !== 'error' && generalStatusDiv.className !== 'loading' && !generalStatusDiv.textContent.startsWith("Mostrando minuta")) {
                    generalStatusDiv.style.display = 'none'; 
                }
            }, 2000);
        } else if (generalStatusDiv && generalStatusDiv.className === 'info' && !generalStatusDiv.textContent.startsWith("No hay tiempos")) {
            // generalStatusDiv.textContent = ""; // No limpiar si es "No hay tiempos de comida..."
        }
    }

    // --- Event Listeners ---
    if(addMealTimeBtn) addMealTimeBtn.addEventListener('click', addMealTimeEntry);
    if(generateMinutaBtn) generateMinutaBtn.addEventListener('click', openGenerateMinutaModal);
    if(closeModalBtn) closeModalBtn.addEventListener('click', closeMinutaModal);

    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('meal-hour-input') && !isViewingHistoricalMinuta) {
            reorderMealTimesByTime();
        }
    });

    if (PACIENTE_ID_FROM_DJANGO) {
      loadMinutaDates(); // Cargar fechas disponibles para el selector
    }

    // --- NUEVO LISTENER PARA EL SELECTOR DE FECHAS ---
    if (minutaDateSelectorEl) {
        minutaDateSelectorEl.addEventListener('change', async (event) => {
            const selectedValue = event.target.value;
            if (selectedValue === "current") {
                // Cargar la minuta actual/editable
                if(generalStatusDiv) {
                    generalStatusDiv.textContent = "Cargando minuta actual editable...";
                    generalStatusDiv.className = 'info';
                    generalStatusDiv.style.display = 'block';
                }
                const savedDetails = await fetchSavedMinutaDetails();
                mealTimesContainer.innerHTML = ''; 
                mealTimeEntryCounter = 0;
                if (savedDetails && savedDetails.length > 0) {
                    processAndDisplaySavedDetails(savedDetails, false);
                } else {
                    mealTimesContainer.innerHTML = '<p style="text-align:center; padding:20px;">No hay tiempos de comida guardados para la minuta actual.</p>';
                    if(generalStatusDiv) generalStatusDiv.textContent = "No hay tiempos de comida guardados para la minuta actual. Puede agregar nuevos.";
                }
                isViewingHistoricalMinuta = false;
                toggleEditableState(true); // Habilitar edición
                 if(generalStatusDiv && generalStatusDiv.textContent.startsWith("Cargando minuta actual")) {
                     setTimeout(() => { generalStatusDiv.style.display = 'none'; }, 2000);
                 }


            } else if (selectedValue) {
                // Cargar minuta histórica
                await loadHistoricalMinutaDetails(selectedValue);
            }
        });
    }

    if(saveMinutaPdfBtn) saveMinutaPdfBtn.addEventListener('click', handleSaveMinutaPdf);
    if(sendMinutaEmailBtn) sendMinutaEmailBtn.addEventListener('click', handleSendMinutaEmail);

    window.addEventListener('click', (event) => {
        if (event.target == minutaModal) {
            closeMinutaModal();
        }
    });
    function showMinutaPopup(message, isSuccess = true) {  
        Swal.fire({
            icon: isSuccess ? 'success' : 'error',
            title: isSuccess ? '¡Éxito!' : 'Error',
            text: message,
            confirmButtonText: 'Aceptar'
        });
    }
    initializePage();
});
</script>
{% endblock %}