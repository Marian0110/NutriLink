{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Minuta{% endblock %}

{% block perfilcontent %}
<div class="minuta-creation-content patient-content"> 
  <div id="adecuacion-minuta-section" style="margin-bottom: 25px;">
    <h3>Resumen de Adecuación de Minuta Actual</h3>
    <table id="tabla-adecuacion" class="adecuacion-table">
        <thead>
            <tr>
                <th>Componente</th>
                <th>Porcentaje de Adecuación</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Calórico</td>
                <td id="adecuacion-calorico">- %</td>
            </tr>
            <tr>
                <td>Proteínas</td>
                <td id="adecuacion-proteinas">- %</td>
            </tr>
            <tr>
                <td>Carbohidratos</td>
                <td id="adecuacion-carbohidratos">- %</td>
            </tr>
            <tr>
                <td>Lípidos</td>
                <td id="adecuacion-lipidos">- %</td>
            </tr>
        </tbody>
    </table>
    <div id="adecuacion-status" style="font-style: italic; margin-top: 8px; font-size: 0.9em;">Cargando datos de adecuación...</div>
</div>
    <h2>Porciones por tiempo de comida</h2>

    <script type="text/javascript">
      const PACIENTE_ID_FROM_DJANGO = JSON.parse('{{ paciente.id_paciente|escapejs }}');
    </script>    

    <div id="meal-times-container">
        <!-- Las entradas de tiempo de comida se agregarán aquí dinámicamente -->
    </div>

    <div style="margin-top: 25px; margin-bottom: 15px;">
      <button id="add-meal-time-btn" class="button-secondary" style="display: none;">Agregar Tiempo de Comida</button>
      <button id="generate-minuta-btn" class="button-primary" style="margin-left: 10px;">Generar Minuta</button>
    </div>
    <div id="general-status" style="min-height: 20px; font-weight: bold;"></div>
    <div id="minuta-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-modal-btn">×</span>
            <h2>Minuta Generada</h2>
            <h2>Escoja 1 de las opciones por cada grupo de alimentos</h2>
            <div id="minuta-modal-body">
                <!-- El contenido de la minuta se insertará aquí -->
            </div>
            <div class="modal-footer">
                <button id="save-generated-minuta-btn" class="button-primary">Guardar Cambios de Minuta</button>
                 <button id="copy-minuta-btn" class="button-secondary">Copiar Minuta</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PACIENTE_ID = typeof PACIENTE_ID_FROM_DJANGO !== 'undefined' ? PACIENTE_ID_FROM_DJANGO : null;

    const mealTimesContainer = document.getElementById('meal-times-container');
    const addMealTimeBtn = document.getElementById('add-meal-time-btn');
    const generalStatusDiv = document.getElementById('general-status'); 
    const generateMinutaBtn = document.getElementById('generate-minuta-btn');
    const minutaModal = document.getElementById('minuta-modal');
    const closeModalBtn = document.querySelector('.close-modal-btn');
    const minutaModalBody = document.getElementById('minuta-modal-body');
    const saveGeneratedMinutaBtn = document.getElementById('save-generated-minuta-btn');
    const copyMinutaBtn = document.getElementById('copy-minuta-btn');

    const adecuacionCaloricoEl = document.getElementById('adecuacion-calorico');
    const adecuacionProteinasEl = document.getElementById('adecuacion-proteinas');
    const adecuacionCarbohidratosEl = document.getElementById('adecuacion-carbohidratos');
    const adecuacionLipidosEl = document.getElementById('adecuacion-lipidos');
    const adecuacionStatusEl = document.getElementById('adecuacion-status');

    let ALL_MEAL_TIMES_DATA = []; 
    let foodGroupsData = [];      
    let mealTimeEntryCounter = 0; 
    let currentGeneratedMinutaData = null;

    if (PACIENTE_ID === null) {
        console.error("PACIENTE_ID no está definido o es null.");
        if(generalStatusDiv) generalStatusDiv.textContent = "Error crítico: No se pudo identificar al paciente.";
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "No se puede cargar la adecuación sin ID de paciente.";
            adecuacionStatusEl.className = 'error';
        }
        if(addMealTimeBtn) addMealTimeBtn.disabled = true;
        if(generateMinutaBtn) generateMinutaBtn.disabled = true; 
        return; 
    }
    // --- FUNCIONES PARA MODAL DE MINUTA GENERADA ---
    async function openGenerateMinutaModal() {
        if (!PACIENTE_ID) {
            alert("No se puede generar la minuta sin un ID de paciente.");
            return;
        }
        minutaModalBody.innerHTML = '<p>Cargando minuta...</p>';
        minutaModal.style.display = 'block';

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.mensaje || `Error HTTP ${response.status}`);
            }

            if (result.status === 'success' && result.data) {
                currentGeneratedMinutaData = result.data; // Guardar los datos
                renderGeneratedMinuta(result.data);
            } else {
                throw new Error(result.mensaje || "No se pudo obtener la minuta generada.");
            }
        } catch (error) {
            console.error("Error al obtener minuta generada:", error);
            minutaModalBody.innerHTML = `<p style="color:red;">Error al cargar la minuta: ${error.message}</p>`;
        }
    }

    function renderGeneratedMinuta(data) {
        minutaModalBody.innerHTML = ''; // Limpiar contenido anterior

        if (!data.tiempos_de_comida || data.tiempos_de_comida.length === 0) {
            minutaModalBody.innerHTML = '<p>No hay tiempos de comida definidos en la minuta generada.</p>';
            return;
        }

        data.tiempos_de_comida.forEach(tiempo => {
            const tiempoDiv = document.createElement('div');
            tiempoDiv.classList.add('minuta-tiempo-comida');
            
            const tiempoHeader = document.createElement('h4');
            tiempoHeader.textContent = `${tiempo.tiempo_comida}`;
            tiempoDiv.appendChild(tiempoHeader);

            if (tiempo.hora_sugerida) {
                const horaP = document.createElement('p');
                horaP.classList.add('hora-sugerida');
                horaP.textContent = `Hora Sugerida: ${tiempo.hora_sugerida}`;
                tiempoDiv.appendChild(horaP);
            }

            if (tiempo.grupos && tiempo.grupos.length > 0) {
                tiempo.grupos.forEach(grupo => {
                    const grupoDiv = document.createElement('div');
                    grupoDiv.classList.add('minuta-grupo-alimento');
                    
                    const grupoHeader = document.createElement('h5');
                    grupoHeader.textContent = grupo.grupo_descripcion;
                    grupoDiv.appendChild(grupoHeader);

                    const opcionesTextarea = document.createElement('textarea');
                    opcionesTextarea.rows = grupo.opciones.length + 1 > 3 ? grupo.opciones.length + 1 : 4; // Ajustar altura
                    opcionesTextarea.dataset.tiempoId = tiempo.id_tiempo_comida; // Podría ser útil
                    opcionesTextarea.dataset.grupoDesc = grupo.grupo_descripcion; // Útil para guardar

                    let opcionesTexto = '';
                    grupo.opciones.forEach(opcion => {
                        // Formatear como " - cantidad medida de alimento"
                        opcionesTexto += `- ${opcion.cantidad} ${opcion.medida} de ${opcion.alimento}\n`;
                    });
                    opcionesTextarea.value = opcionesTexto.trim();
                    
                    grupoDiv.appendChild(opcionesTextarea);
                    tiempoDiv.appendChild(grupoDiv);
                });
            }
            minutaModalBody.appendChild(tiempoDiv);
        });
    }

    function closeMinutaModal() {
        minutaModal.style.display = 'none';
        minutaModalBody.innerHTML = ''; // Limpiar al cerrar
        currentGeneratedMinutaData = null; // Limpiar datos guardados
    }

    async function handleSaveChangesGeneratedMinuta() {
        if (!currentGeneratedMinutaData) {
            alert("No hay datos de minuta para guardar.");
            return;
        }
        saveGeneratedMinutaBtn.disabled = true;
        saveGeneratedMinutaBtn.textContent = 'Guardando...';

        const textareas = minutaModalBody.querySelectorAll('textarea');
        // Aquí necesitas decidir cómo vas a enviar estos datos editados.
        // El formato de tu API `obtener_minuta` es para mostrar.
        // Para guardar, probablemente necesites enviar datos estructurados similares
        // a como guardas las porciones, o un nuevo endpoint que acepte este formato de "minuta textual".

        // EJEMPLO MUY SIMPLIFICADO: Solo loguear los cambios.
        // DEBERÁS ADAPTAR ESTO PARA LLAMAR A TU API DE GUARDADO.
        let minutaModificada = {
            pacienteId: PACIENTE_ID,
            id_minuta: currentGeneratedMinutaData.id_minuta, // Si se mantiene el ID de minuta
            tiempos_de_comida: []
        };

        const tiemposOriginales = currentGeneratedMinutaData.tiempos_de_comida;
        
        tiemposOriginales.forEach(tiempoOriginal => {
            let tiempoModificado = {
                tiempo_comida: tiempoOriginal.tiempo_comida,
                hora_sugerida: tiempoOriginal.hora_sugerida, // Asumimos que la hora no se edita en este modal
                grupos: []
            };
            
            tiempoOriginal.grupos.forEach(grupoOriginal => {
                // Encontrar el textarea correspondiente (esto es un poco frágil, mejor usar IDs si es posible)
                const textarea = Array.from(textareas).find(ta => 
                    ta.dataset.grupoDesc === grupoOriginal.grupo_descripcion && 
                    ta.parentElement.parentElement.querySelector('h4').textContent === tiempoOriginal.tiempo_comida
                );

                if (textarea) {
                    // Aquí necesitarías parsear el textarea de nuevo a una estructura de "opciones"
                    // Esto es la parte más compleja si permites edición libre.
                    // Por ahora, solo guardamos el texto como un bloque.
                    // Para un guardado real, necesitarías un parser o enviar el texto crudo.
                    tiempoModificado.grupos.push({
                        id_tiempo_comida: grupoOriginal.id_tiempo_comida, // Es el id del tiempo, no del grupo
                        grupo_descripcion: grupoOriginal.grupo_descripcion,
                        opciones_texto_editado: textarea.value // Solo como ejemplo
                    });
                }
            });
            minutaModificada.tiempos_de_comida.push(tiempoModificado);
        });

        console.log("Datos de minuta modificados (para enviar a API):", minutaModificada);
        alert("La funcionalidad de guardar los cambios de la minuta generada aún no está implementada.\nRevisa la consola para ver los datos que se enviarían.");

        // Simular un guardado
        // try {
        //     // const response = await fetch('URL_PARA_GUARDAR_MINUTA_EDITADA', {
        //     //     method: 'POST',
        //     //     headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        //     //     body: JSON.stringify(minutaModificada)
        //     // });
        //     // if (!response.ok) throw new Error("Error al guardar minuta editada");
        //     // alert("Minuta guardada exitosamente (simulado)");
        //     // closeMinutaModal();
        // } catch (error) {
        //     console.error("Error guardando minuta editada:", error);
        //     alert("Error al guardar la minuta editada: " + error.message);
        // } finally {
            saveGeneratedMinutaBtn.disabled = false;
            saveGeneratedMinutaBtn.textContent = 'Guardar Cambios de Minuta';
        // }
    }

    function copyMinutaToClipboard() {
        if (!minutaModalBody) return;
        let textToCopy = "";
        const tiempoComidaDivs = minutaModalBody.querySelectorAll('.minuta-tiempo-comida');
        
        tiempoComidaDivs.forEach(tiempoDiv => {
            const header = tiempoDiv.querySelector('h4');
            const hora = tiempoDiv.querySelector('.hora-sugerida');
            if (header) textToCopy += header.textContent + "\n";
            if (hora) textToCopy += hora.textContent + "\n";

            const grupoDivs = tiempoDiv.querySelectorAll('.minuta-grupo-alimento');
            grupoDivs.forEach(grupoDiv => {
                const grupoHeader = grupoDiv.querySelector('h5');
                const textarea = grupoDiv.querySelector('textarea');
                if (grupoHeader) textToCopy += "  " + grupoHeader.textContent + ":\n";
                if (textarea) {
                    // Añadir cada línea del textarea con un poco más de indentación
                    textarea.value.split('\n').forEach(line => {
                        textToCopy += "    " + line + "\n";
                    });
                }
            });
            textToCopy += "\n"; // Espacio entre tiempos de comida
        });

        if (textToCopy) {
            navigator.clipboard.writeText(textToCopy.trim())
                .then(() => {
                    alert('Minuta copiada al portapapeles!');
                })
                .catch(err => {
                    console.error('Error al copiar la minuta: ', err);
                    alert('Error al copiar la minuta. Revisa la consola.');
                });
        } else {
            alert('No hay contenido en la minuta para copiar.');
        }
    }

    // --- FUNCIONES PARA ADECUACIÓN ---
    async function fetchAdecuacionData() {
        if (!PACIENTE_ID) {
            return { data: null, status: 'error', message: "ID de paciente no disponible." };
        }
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "Actualizando datos de adecuación...";
            adecuacionStatusEl.className = 'loading';
            adecuacionStatusEl.style.display = 'block';
        }

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_adecuacion_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                if (result && result.status === "not_found") {
                    return { data: null, status: 'not_found', message: result.mensaje };
                }
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            
            if (result.status === "success" && result.data) {
                return { data: result.data, status: 'success' };
            } else if (result.status === "not_found") { 
                return { data: null, status: 'not_found', message: result.mensaje };
            } else {
                throw new Error(result.mensaje || "Formato de respuesta inesperado para adecuación.");
            }
        } catch (error) {
            console.error("Error al obtener datos de adecuación:", error);
            return { data: null, status: 'error', message: error.message };
        }
    }

    function displayAdecuacionData(apiResponse) {
        if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = '- %';
        if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = '- %';
        if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = '- %';
        if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = '- %';

        if (!adecuacionStatusEl) return;

        if (apiResponse.status === 'success' && apiResponse.data) {
            const data = apiResponse.data;
            if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = `${parseFloat(data.porc_adecuacion_calorico).toFixed(2)} %`;
            if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = `${parseFloat(data.porc_adec_proteinas).toFixed(2)} %`;
            if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = `${parseFloat(data.porc_adec_carbohidratos).toFixed(2)} %`;
            if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = `${parseFloat(data.porc_adec_lipidos).toFixed(2)} %`;
            
            adecuacionStatusEl.textContent = "Datos de adecuación actualizados."; 
            adecuacionStatusEl.className = 'success';
            adecuacionStatusEl.style.display = 'none'; 
        } else if (apiResponse.status === 'not_found') {
            adecuacionStatusEl.textContent = apiResponse.message || "Aún no hay porcentajes de adecuación. ¡Aparecerán una vez que agregues el primer tiempo de comida!";
            adecuacionStatusEl.className = 'info'; 
            adecuacionStatusEl.style.display = 'block';
        } else { 
            adecuacionStatusEl.textContent = `Error al cargar adecuación: ${apiResponse.message || 'Desconocido.'}`;
            adecuacionStatusEl.className = 'error';
            adecuacionStatusEl.style.display = 'block';
        }
    }
    
    async function loadAndDisplayAdecuacion() {
        const adecuacionApiResponse = await fetchAdecuacionData();
        displayAdecuacionData(adecuacionApiResponse);
    }

    // --- FUNCIONES PARA DATOS BASE Y DETALLES GUARDADOS ---
    async function fetchApiData(url, type) { 
        try {
            const response = await fetch(url);
            if (!response.ok) {
                 const errorData = await response.text();
                throw new Error(`Error HTTP ${response.status} al obtener ${type}: ${errorData}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Error en fetchApiData para ${type}:`, error);
            if(generalStatusDiv) {
                generalStatusDiv.textContent = `Error al cargar ${type}. ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            throw error; 
        }
    }

    async function fetchSavedMinutaDetails() {
        if (!PACIENTE_ID) {
             return null;
        }
        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_detalle_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();
            if (!response.ok) {
                if (response.status === 404 || (result && result.status === 'not_found')) return []; 
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            if (result.status === 'success' && result.data && Array.isArray(result.data.detalles_minuta)) return result.data.detalles_minuta; 
            else if (result.status === 'not_found') return [];
            else { console.warn("fetchSavedMinutaDetails: Formato inesperado", result); return []; }
        } catch (error) {
            console.error("Error en fetchSavedMinutaDetails:", error);
            if(generalStatusDiv && generalStatusDiv.textContent.indexOf('Error al cargar detalles guardados') === -1) {
                generalStatusDiv.textContent += ` | Error al cargar detalles guardados: ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            return null; 
        }
    }

    // --- FUNCIONES DE MANEJO DEL DOM Y ESTADO ---
    function updateAddMealButtonState() {
        if (!addMealTimeBtn) return;
        const availableTimes = getAvailableMealTimes();
        if (availableTimes.length > 0) {
            addMealTimeBtn.style.display = 'inline-block';
            addMealTimeBtn.disabled = false;
        } else {
            addMealTimeBtn.style.display = 'none';
            addMealTimeBtn.disabled = true;
        }
    }

    function getSelectedMealTimeIds() {
        const selected = [];
        if(mealTimesContainer) {
            mealTimesContainer.querySelectorAll('.meal-time-select').forEach(select => {
                if (select.value) selected.push(parseInt(select.value));
            });
        }
        return selected;
    }

    function getAvailableMealTimes() {
        const selectedIds = getSelectedMealTimeIds();
        return ALL_MEAL_TIMES_DATA.filter(time => !selectedIds.includes(time.id_tiempo_comida));
    }
    
    function populateSelectWithOptions(selectElement, availableTimes, currentValue) {
        selectElement.innerHTML = ''; 
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "-- Seleccione Tiempo --";
        selectElement.appendChild(placeholder);

        if (currentValue) {
            const currentOptionData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === currentValue);
            if (currentOptionData) {
                const opt = document.createElement('option');
                opt.value = currentOptionData.id_tiempo_comida;
                opt.textContent = currentOptionData.descripcion;
                selectElement.appendChild(opt);
                opt.selected = true; 
            } else { 
                 placeholder.selected = true;
            }
        } else {
            placeholder.selected = true;
        }
        availableTimes.forEach(time => {
            if (time.id_tiempo_comida !== currentValue) {
                const option = document.createElement('option');
                option.value = time.id_tiempo_comida;
                option.textContent = time.descripcion;
                selectElement.appendChild(option);
            }
        });
        if (!selectElement.value && selectElement.options.length > 0) {
            placeholder.selected = true;
        }
    }

    function updateAllSelects() {
        if(!mealTimesContainer) return;
        const allSelects = mealTimesContainer.querySelectorAll('.meal-time-select');
        const selectedIdsOverall = getSelectedMealTimeIds();
        allSelects.forEach(currentSelect => {
            const currentValueForThisSelect = currentSelect.value ? parseInt(currentSelect.value) : null;
            const availableForThisSelect = ALL_MEAL_TIMES_DATA.filter(time => {
                return time.id_tiempo_comida === currentValueForThisSelect || !selectedIdsOverall.includes(time.id_tiempo_comida);
            });
            populateSelectWithOptions(currentSelect, availableForThisSelect, currentValueForThisSelect);
        });
        updateAddMealButtonState(); 
    }
    
    function convertTo24HourFormat(timeString) {
        if (!timeString || typeof timeString !== 'string') return '';
        const timeStringLower = timeString.toLowerCase().trim();
        const match = timeStringLower.match(/^(\d{1,2}):(\d{2})\s*(am|pm)?$/);
        if (!match) {
            if (/^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString.trim())) return timeString.trim();
            return ''; 
        }
        let hours = parseInt(match[1], 10);
        const minutes = parseInt(match[2], 10);
        const period = match[3];
        if (period === 'am' && hours === 12) hours = 0;
        else if (period === 'pm' && hours !== 12) hours += 12;
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return '';
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    function createAndPopulateMealTimeEntry(tiempoComidaId, hora, portionsMap) {
        if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0 || !mealTimesContainer) return;
        const entryIdSuffix = mealTimeEntryCounter;
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('meal-time-entry');
        entryDiv.id = `meal-entry-${entryIdSuffix}`;
        entryDiv.dataset.entryId = entryIdSuffix;

        const selectorDiv = document.createElement('div');
        selectorDiv.classList.add('meal-time-selector');
        const selectLabel = document.createElement('label');
        selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
        selectLabel.textContent = `Tiempo de Comida:`;
        const selectElement = document.createElement('select');
        selectElement.id = `meal-time-select-${entryIdSuffix}`;
        selectElement.classList.add('meal-time-select');
        selectElement.required = true;
        
        const availableNow = getAvailableMealTimes(); 
        const allOptionsForThis = [...availableNow];
        const currentTimeData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === tiempoComidaId);
        if (currentTimeData && !allOptionsForThis.some(t => t.id_tiempo_comida === tiempoComidaId)) {
            allOptionsForThis.push(currentTimeData); 
            allOptionsForThis.sort((a, b) => a.id_tiempo_comida - b.id_tiempo_comida); 
        }
        populateSelectWithOptions(selectElement, allOptionsForThis, tiempoComidaId); 
        
        selectorDiv.appendChild(selectLabel);
        selectorDiv.appendChild(selectElement);

        const timeInputDiv = document.createElement('div');
        timeInputDiv.classList.add('time-input-container');
        const timeLabel = document.createElement('label');
        timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
        timeLabel.textContent = 'Hora:';
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.id = `meal-hour-input-${entryIdSuffix}`;
        timeInput.classList.add('meal-hour-input'); 
        timeInput.required = true;
        timeInput.value = convertTo24HourFormat(hora);
        timeInputDiv.appendChild(timeLabel);
        timeInputDiv.appendChild(timeInput);
        selectorDiv.appendChild(timeInputDiv); 
        entryDiv.appendChild(selectorDiv);

        const tableDiv = document.createElement('div');
        tableDiv.classList.add('food-portions-table');
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        foodGroupsData.forEach(group => {
            const th = document.createElement('th');
            th.textContent = group.descripcion;
            th.dataset.grupoId = group.id_grupo_alimenticio; 
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const inputRow = document.createElement('tr');
        foodGroupsData.forEach(group => {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '0.1'; 
            input.placeholder = '0';
            input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
            input.dataset.grupoId = group.id_grupo_alimenticio; 
            const savedPortion = portionsMap[group.id_grupo_alimenticio];
            if (savedPortion !== undefined && savedPortion !== null) input.value = savedPortion;
            td.appendChild(input);
            inputRow.appendChild(td);
        });
        tbody.appendChild(inputRow);
        table.appendChild(tbody);
        tableDiv.appendChild(table);
        entryDiv.appendChild(tableDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('meal-entry-actions');
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Guardar Cambios'; 
        saveButton.classList.add('save-single-meal-btn');
        saveButton.type = 'button';
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Eliminar Tiempo de Comida';
        deleteButton.classList.add('delete-single-meal-btn');
        deleteButton.type = 'button';
        const statusDiv = document.createElement('div');
        statusDiv.classList.add('single-save-status');
        saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv)); 
        deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
        actionsDiv.appendChild(saveButton);
        actionsDiv.appendChild(deleteButton);
        actionsDiv.appendChild(statusDiv);
        entryDiv.appendChild(actionsDiv);
        
        mealTimesContainer.appendChild(entryDiv);
        selectElement.addEventListener('change', updateAllSelects);
        mealTimeEntryCounter++;
    }
    
    function processAndDisplaySavedDetails(savedDetailsArray) {
        if (!Array.isArray(savedDetailsArray) || savedDetailsArray.length === 0) return;
        const groupedDetails = savedDetailsArray.reduce((acc, detail) => {
            const tiempoId = detail.id_tiempo_comida;
            if (!acc[tiempoId]) {
                acc[tiempoId] = { hora: detail.hora_tiempo_comida, portions: {} };
            }
            acc[tiempoId].portions[detail.id_grupo_alimenticio] = detail.numero_porciones_grupo;
            return acc;
        }, {});
        const sortedTiempoIds = Object.keys(groupedDetails).sort((a, b) => parseInt(a) - parseInt(b));
        sortedTiempoIds.forEach(tiempoIdStr => {
             const tiempoId = parseInt(tiempoIdStr, 10);
             const details = groupedDetails[tiempoId];
             createAndPopulateMealTimeEntry(tiempoId, details.hora, details.portions);
        });
    }

    function addMealTimeEntry() {
         if (!mealTimesContainer || !addMealTimeBtn) return; 
         if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0) {
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Datos base no cargados.";
                 generalStatusDiv.className = 'warning';
             }
             return;
         }
         const entryIdSuffix = mealTimeEntryCounter;
         const entryDiv = document.createElement('div');
         entryDiv.classList.add('meal-time-entry');
         entryDiv.id = `meal-entry-${entryIdSuffix}`;
         entryDiv.dataset.entryId = entryIdSuffix;

         const selectorDiv = document.createElement('div');
         selectorDiv.classList.add('meal-time-selector');
         const selectLabel = document.createElement('label');
         selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
         selectLabel.textContent = `Nuevo Tiempo de Comida:`;
         const selectElement = document.createElement('select');
         selectElement.id = `meal-time-select-${entryIdSuffix}`;
         selectElement.classList.add('meal-time-select');
         selectElement.required = true;
         const availableTimes = getAvailableMealTimes();
         populateSelectWithOptions(selectElement, availableTimes, null); 
         selectorDiv.appendChild(selectLabel);
         selectorDiv.appendChild(selectElement);

         const timeInputDiv = document.createElement('div');
         timeInputDiv.classList.add('time-input-container');
         const timeLabel = document.createElement('label');
         timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
         timeLabel.textContent = 'Hora:';
         const timeInput = document.createElement('input');
         timeInput.type = 'time';
         timeInput.id = `meal-hour-input-${entryIdSuffix}`;
         timeInput.classList.add('meal-hour-input');
         timeInput.required = true;
         timeInputDiv.appendChild(timeLabel);
         timeInputDiv.appendChild(timeInput);
         selectorDiv.appendChild(timeInputDiv);
         entryDiv.appendChild(selectorDiv);

         const tableDiv = document.createElement('div');
         tableDiv.classList.add('food-portions-table');
         const table = document.createElement('table');
         const thead = document.createElement('thead');
         const headerRow = document.createElement('tr');
         foodGroupsData.forEach(group => {
             const th = document.createElement('th');
             th.textContent = group.descripcion;
             th.dataset.grupoId = group.id_grupo_alimenticio;
             headerRow.appendChild(th);
         });
         thead.appendChild(headerRow);
         table.appendChild(thead);
         const tbody = document.createElement('tbody');
         const inputRow = document.createElement('tr');
         foodGroupsData.forEach(group => {
             const td = document.createElement('td');
             const input = document.createElement('input');
             input.type = 'number';
             input.min = '0';
             input.step = '0.1';
             input.placeholder = '0';
             input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
             input.dataset.grupoId = group.id_grupo_alimenticio;
             td.appendChild(input);
             inputRow.appendChild(td);
         });
         tbody.appendChild(inputRow);
         table.appendChild(tbody);
         tableDiv.appendChild(table);
         entryDiv.appendChild(tableDiv);

         const actionsDiv = document.createElement('div');
         actionsDiv.classList.add('meal-entry-actions');
         const saveButton = document.createElement('button');
         saveButton.textContent = 'Guardar Tiempo de Comida';
         saveButton.classList.add('save-single-meal-btn');
         saveButton.type = 'button';
         const deleteButton = document.createElement('button'); 
         deleteButton.textContent = 'Eliminar Tiempo de Comida';
         deleteButton.classList.add('delete-single-meal-btn');
         deleteButton.type = 'button';
         const statusDiv = document.createElement('div');
         statusDiv.classList.add('single-save-status');
         saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         actionsDiv.appendChild(saveButton);
         actionsDiv.appendChild(deleteButton);
         actionsDiv.appendChild(statusDiv);
         entryDiv.appendChild(actionsDiv);

         mealTimesContainer.appendChild(entryDiv);
         selectElement.addEventListener('change', updateAllSelects);
         mealTimeEntryCounter++;
         updateAllSelects(); 
    }

    // --- FUNCIÓN DE GUARDADO INDIVIDUAL ---
    async function handleSaveSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) {
        saveBtn.disabled = true;
        if (deleteBtn) deleteBtn.disabled = true;
        statusEl.textContent = 'Guardando...';
        statusEl.className = 'single-save-status info';

        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const horaTiempoComidaInput = entryElement.querySelector('.meal-hour-input');
        const tiempoComidaId = tiempoComidaSelect.value;
        const horaTiempoComida = horaTiempoComidaInput.value; 
        let hasValidationError = false;

        if (!tiempoComidaId) { tiempoComidaSelect.style.borderColor = 'red'; hasValidationError = true; } 
        else { tiempoComidaSelect.style.borderColor = ''; }
        if (!horaTiempoComida) { horaTiempoComidaInput.style.borderColor = 'red'; hasValidationError = true; } 
        else { horaTiempoComidaInput.style.borderColor = ''; }

        if (hasValidationError) {
            statusEl.textContent = 'Complete tiempo y hora.';
            statusEl.className = 'single-save-status error';
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
            return;
        }

        const detallePromises = [];
        const porcionesInputs = entryElement.querySelectorAll('.food-portions-table input[type="number"]');
        porcionesInputs.forEach(input => {
            const numeroPorciones = parseFloat(input.value);
            if (!isNaN(numeroPorciones) && numeroPorciones >= 0) { 
                const grupoAlimenticioId = input.dataset.grupoId;
                const payload = {
                    pacienteId: PACIENTE_ID,
                    numeroPorcionesGrupo: numeroPorciones, 
                    grupoAlimenticioId: parseInt(grupoAlimenticioId),
                    tiempoComidaId: parseInt(tiempoComidaId),
                    horaTiempoComida: horaTiempoComida
                };
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
                detallePromises.push(
                    fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_detalle_minuta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payload)
                    }).then(response => {
                        if (!response.ok) {
                             return response.json().then(err => { throw new Error(`Error detalle ${response.status}: ${err.detail || JSON.stringify(err)}`); });
                        }
                        return response.json();
                    })
                );
            } else if (input.value.trim() !== '') { 
                 input.style.borderColor = 'orange'; 
            } else {
                input.style.borderColor = ''; 
            }
        });

        try {
            if (detallePromises.length > 0) {
                await Promise.all(detallePromises);
                statusEl.textContent = 'Porciones guardadas. Actualizando adecuación...';
            } else {
                 statusEl.textContent = 'No hay porciones (>=0) especificadas. Actualizando adecuación...';
            }
            statusEl.className = 'single-save-status info';

            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
            const adecuacionPayload = { pacienteId: PACIENTE_ID };
            const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(adecuacionPayload)
            });

            if (!adecuacionResponse.ok) {
                const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación."}));
                throw new Error(`Error al guardar adecuación ${adecuacionResponse.status}: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
            }

            // AHORA, después de que guardar_adecuacion_minuta fue exitoso, obtenemos la nueva adecuación
            await loadAndDisplayAdecuacion(); 
            
            statusEl.textContent = 'Guardado exitosamente.';
            statusEl.className = 'single-save-status success';
            setTimeout(() => { 
                 if (statusEl.className === 'single-save-status success') statusEl.textContent = '';
            }, 3000);

        } catch (error) {
            console.error("Error en guardado individual:", error);
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'single-save-status error';
        } finally {
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false; 
            updateAddMealButtonState(); 
        }
    }

    // --- FUNCIÓN PARA ELIMINAR ---
    async function handleDeleteSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) {
        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const tiempoComidaId = tiempoComidaSelect.value;

        if (!tiempoComidaId) {
            statusEl.textContent = 'Seleccione un tiempo de comida para eliminar.';
            statusEl.className = 'single-save-status error';
            setTimeout(() => { if (statusEl.className === 'single-save-status error') statusEl.textContent = ''; }, 3000);
            return;
        }

        if (!confirm(`¿Está seguro de que desea eliminar todos los datos para el tiempo de comida "${tiempoComidaSelect.options[tiempoComidaSelect.selectedIndex].text}"? Esta acción no se puede deshacer.`)) {
            return;
        }

        saveBtn.disabled = true;
        deleteBtn.disabled = true;
        statusEl.textContent = 'Eliminando...';
        statusEl.className = 'single-save-status info';

        try {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
            const url = new URL('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/eliminar_detalle_ultima_minuta');
            url.searchParams.append('pacienteId', PACIENTE_ID);
            url.searchParams.append('tiempoComidaId', tiempoComidaId);

            const deleteResponse = await fetch(url.toString(), {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });

            const result = await deleteResponse.json();

            if (!deleteResponse.ok) {
                throw new Error(result.mensaje || `Error al eliminar ${deleteResponse.status}`);
            }

            statusEl.textContent = result.mensaje || 'Eliminado exitosamente.';
            statusEl.className = 'single-save-status success';
            
            entryElement.remove(); 
            updateAllSelects();    
            
            // AHORA, después de que la eliminación fue exitosa, actualizamos la adecuación.
            // Primero, llamamos a guardar_adecuacion_minuta para que el backend recalcule
            // (asumiendo que la eliminación de detalles requiere un recálculo de adecuación guardada)
            const adecuacionPayload = { pacienteId: PACIENTE_ID };
            const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(adecuacionPayload)
            });
            if (!adecuacionResponse.ok) {
                const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación post-eliminación."}));
                console.warn(`Advertencia al guardar adecuación post-eliminación: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
                // No se considera un error fatal para la operación de eliminación en sí, pero se advierte.
            }
            // Luego, obtenemos y mostramos la adecuación.
            await loadAndDisplayAdecuacion(); 

        } catch (error) {
            console.error("Error al eliminar tiempo de comida:", error);
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'single-save-status error';
            saveBtn.disabled = false; 
            deleteBtn.disabled = false;
        }
        // No se rehabilita deleteBtn aquí si la eliminación fue exitosa, porque la entrada ya no existe.
        // saveBtn tampoco debería rehabilitarse si la entrada se fue.
        // La lógica de `finally` en handleSaveSingleMealEntry se encarga de los botones si la eliminación falla.
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- INICIALIZACIÓN DE LA PÁGINA ---
    async function initializePage() {
        if(addMealTimeBtn) {
            addMealTimeBtn.style.display = 'none'; 
            addMealTimeBtn.disabled = true;
        }
        if(generateMinutaBtn && PACIENTE_ID === null) { 
             generateMinutaBtn.disabled = true;
        }

        if(generalStatusDiv) {
            generalStatusDiv.textContent = "Cargando datos...";
            generalStatusDiv.className = 'info';
        }
        
        if(mealTimesContainer) mealTimesContainer.innerHTML = ''; 
        mealTimeEntryCounter = 0; 

        const [adecuacionResponse, mealTimes, foodGroups, savedDetails] = await Promise.all([
            fetchAdecuacionData(),
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id', 'tiempos de comida').catch(e => {console.error("Error cargando tiempos de comida:", e); return null;}), 
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id', 'grupos alimenticios').catch(e => {console.error("Error cargando grupos alimenticios:", e); return null;}),
            fetchSavedMinutaDetails().catch(e => {console.error("Error cargando detalles guardados:", e); return null;})
        ]).catch(error => {
             console.error("Error en Promise.all de initializePage:", error);
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Error crítico al cargar datos iniciales.";
                 generalStatusDiv.className = 'error';
             }
             return [null, null, null, null]; 
        });

        displayAdecuacionData(adecuacionResponse || { status: 'error', message: 'Fallo carga adecuación.' });

        if (!mealTimes || !foodGroups) { // Si los datos base fallaron
             if(generalStatusDiv && generalStatusDiv.className !== 'error') { // Solo si no hay un error más grave
                 generalStatusDiv.textContent = "Error: No se pudieron cargar los datos base (tiempos/grupos).";
                 generalStatusDiv.className = 'error';
             }
             updateAddMealButtonState(); 
             return; 
        }

        ALL_MEAL_TIMES_DATA = mealTimes; 
        foodGroupsData = foodGroups;     

        if (savedDetails && savedDetails.length > 0) {
            processAndDisplaySavedDetails(savedDetails);
        } else if (savedDetails === null && generalStatusDiv && generalStatusDiv.className !== 'error') {
            generalStatusDiv.textContent = ""; 
        } else if (generalStatusDiv && generalStatusDiv.className === 'info' && (!savedDetails || savedDetails.length === 0)) {
            generalStatusDiv.textContent = "No hay tiempos de comida guardados para este paciente.";
        }

        updateAllSelects(); 
        updateAddMealButtonState();

        if(generalStatusDiv && generalStatusDiv.className !== 'error' && (!adecuacionStatusEl || adecuacionStatusEl.className === 'success')) {
             setTimeout(() => { 
                if(generalStatusDiv && generalStatusDiv.className !== 'error') {
                    generalStatusDiv.style.display = 'none'; 
                }
            }, 2000);
        } else if (generalStatusDiv && generalStatusDiv.className === 'info') {
            generalStatusDiv.textContent = "";
        }
    }
    
    // --- Event Listeners ---
    if(addMealTimeBtn) addMealTimeBtn.addEventListener('click', addMealTimeEntry);
    if(generateMinutaBtn) generateMinutaBtn.addEventListener('click', openGenerateMinutaModal); // NUEVO
    if(closeModalBtn) closeModalBtn.addEventListener('click', closeMinutaModal); // NUEVO
    if(saveGeneratedMinutaBtn) saveGeneratedMinutaBtn.addEventListener('click', handleSaveChangesGeneratedMinuta); // NUEVO
    if(copyMinutaBtn) copyMinutaBtn.addEventListener('click', copyMinutaToClipboard); // NUEVO


    // Cerrar modal si se hace clic fuera del contenido
    window.addEventListener('click', (event) => {
        if (event.target == minutaModal) {
            closeMinutaModal();
        }
    });

    initializePage(); 
});
</script>
{% endblock %}