{% extends 'basePerfil.html' %}
{% load static %}
{% block title %}Minuta{% endblock %}

{% block perfilcontent %}
<!-- Incluir html2pdf.js desde un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<div class="minuta-creation-content patient-content"> 
  <div id="adecuacion-minuta-section" style="margin-bottom: 25px;">
    <h3>Resumen de Adecuación de Minuta Actual</h3>
    <table id="tabla-adecuacion" class="adecuacion-table">
        <thead>
            <tr>
                <th>Componente</th>
                <th>Porcentaje de Adecuación</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Calórico</td>
                <td id="adecuacion-calorico">- %</td>
            </tr>
            <tr>
                <td>Proteínas</td>
                <td id="adecuacion-proteinas">- %</td>
            </tr>
            <tr>
                <td>Carbohidratos</td>
                <td id="adecuacion-carbohidratos">- %</td>
            </tr>
            <tr>
                <td>Lípidos</td>
                <td id="adecuacion-lipidos">- %</td>
            </tr>
        </tbody>
    </table>
    <div id="adecuacion-status" style="font-style: italic; margin-top: 8px; font-size: 0.9em;">Cargando datos de adecuación...</div>
</div>
    <h2>Porciones por tiempo de comida</h2>

    <script type="text/javascript">
      const PACIENTE_ID_FROM_DJANGO = JSON.parse('{{ paciente.id_paciente|escapejs }}');
      const PACIENTE_EMAIL_FROM_DJANGO = JSON.parse('{% if paciente_email %}"{{ paciente_email|escapejs }}"{% else %}null{% endif %}');
    </script>    

    <div id="meal-times-container">
        <!-- Las entradas de tiempo de comida se agregarán aquí dinámicamente -->
    </div>

    <div style="margin-top: 25px; margin-bottom: 15px;">
      <button id="add-meal-time-btn" class="button-secondary" style="display: none;">Agregar Tiempo de Comida</button>
      <button id="generate-minuta-btn" class="button-primary" style="margin-left: 10px;">Generar Minuta</button>
    </div>
    <div id="general-status" style="min-height: 20px; font-weight: bold;"></div>
    <div id="minuta-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="btn-close">×</span>
            <h2>Minuta Generada</h2>
            <h3 style="font-weight: normal; font-style: italic;">Escoja 1 de las opciones por cada grupo de alimentos</h3>
            <div id="minuta-modal-body">
                <!-- El contenido de la minuta se insertará aquí -->
            </div>
            <div class="modal-footer">
                <button id="save-minuta-pdf-btn" class="button-primary">Guardar Minuta en PDF</button>
                <button id="send-minuta-email-btn" class="button-secondary">Enviar Minuta por Correo</button>
            </div>
            <div id="minuta-modal-status" style="margin-top:10px; font-weight:bold;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PACIENTE_ID = typeof PACIENTE_ID_FROM_DJANGO !== 'undefined' ? PACIENTE_ID_FROM_DJANGO : null;
    let PACIENTE_EMAIL = typeof PACIENTE_EMAIL_FROM_DJANGO !== 'undefined' ? PACIENTE_EMAIL_FROM_DJANGO : null;

    const mealTimesContainer = document.getElementById('meal-times-container');
    const addMealTimeBtn = document.getElementById('add-meal-time-btn');
    const generalStatusDiv = document.getElementById('general-status'); 
    const generateMinutaBtn = document.getElementById('generate-minuta-btn');
    const minutaModal = document.getElementById('minuta-modal');
    const closeModalBtn = document.querySelector('.btn-close');
    const minutaModalBody = document.getElementById('minuta-modal-body');
    const minutaModalStatus = document.getElementById('minuta-modal-status'); 
    const saveMinutaPdfBtn = document.getElementById('save-minuta-pdf-btn');
    const sendMinutaEmailBtn = document.getElementById('send-minuta-email-btn');
    const adecuacionCaloricoEl = document.getElementById('adecuacion-calorico');
    const adecuacionProteinasEl = document.getElementById('adecuacion-proteinas');
    const adecuacionCarbohidratosEl = document.getElementById('adecuacion-carbohidratos');
    const adecuacionLipidosEl = document.getElementById('adecuacion-lipidos');
    const adecuacionStatusEl = document.getElementById('adecuacion-status');

    let ALL_MEAL_TIMES_DATA = []; 
    let foodGroupsData = [];      
    let mealTimeEntryCounter = 0; 
    let currentGeneratedMinutaData = null;

    if (PACIENTE_ID === null) {
        console.error("PACIENTE_ID no está definido o es null.");
        if(generalStatusDiv) generalStatusDiv.textContent = "Error crítico: No se pudo identificar al paciente.";
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "No se puede cargar la adecuación sin ID de paciente.";
            adecuacionStatusEl.className = 'error';
        }
        if(addMealTimeBtn) addMealTimeBtn.disabled = true;
        if(generateMinutaBtn) generateMinutaBtn.disabled = true; 
        return; 
    }
    // --- FUNCIONES PARA MODAL DE MINUTA GENERADA ---
    async function openGenerateMinutaModal() {
        if (!PACIENTE_ID) {
            alert("No se puede generar la minuta sin un ID de paciente.");
            return;
        }
        minutaModalBody.innerHTML = '<p>Cargando minuta...</p>';
        if (minutaModalStatus) minutaModalStatus.textContent = '';
        minutaModal.style.display = 'block';

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.mensaje || `Error HTTP ${response.status}`);
            }

            if (result.status === 'success' && result.data) {
                currentGeneratedMinutaData = result.data; 
                renderGeneratedMinuta(result.data);
            } else {
                throw new Error(result.mensaje || "No se pudo obtener la minuta generada.");
            }
        } catch (error) {
            console.error("Error al obtener minuta generada:", error);
            minutaModalBody.innerHTML = `<p style="color:red;">Error al cargar la minuta: ${error.message}</p>`;
        }
    }

    function renderGeneratedMinuta(data) {
        minutaModalBody.innerHTML = ''; // Limpiar contenido anterior

        if (!data.tiempos_de_comida || data.tiempos_de_comida.length === 0) {
            minutaModalBody.innerHTML = '<p>No hay tiempos de comida definidos en la minuta generada.</p>';
            return;
        }
        const minutaTitle = document.createElement('h3');
        minutaTitle.textContent = `Plan de Alimentación para Paciente ID: ${PACIENTE_ID}`; // Puedes mejorarlo con el nombre del paciente si lo tienes disponible
        minutaTitle.style.textAlign = 'center';
        minutaTitle.style.marginBottom = '20px';
        minutaModalBody.appendChild(minutaTitle);

        data.tiempos_de_comida.forEach(tiempo => {
            const tiempoDiv = document.createElement('div');
            tiempoDiv.classList.add('minuta-tiempo-comida');
            tiempoDiv.style.marginBottom = '15px'; 
            
            const tiempoHeader = document.createElement('h4');
            tiempoHeader.textContent = `${tiempo.tiempo_comida}`;
            tiempoHeader.style.borderBottom = "1px solid #eee"; // Estilo
            tiempoHeader.style.paddingBottom = "5px"; // Estilo
            tiempoDiv.appendChild(tiempoHeader);

            if (tiempo.hora_sugerida) {
                const horaP = document.createElement('p');
                horaP.classList.add('hora-sugerida');
                horaP.style.fontStyle = 'italic'; // Estilo
                horaP.style.fontSize = '0.9em'; // Estilo
                horaP.textContent = `Hora Sugerida: ${tiempo.hora_sugerida}`;
                tiempoDiv.appendChild(horaP);
            }

            if (tiempo.grupos && tiempo.grupos.length > 0) {
                tiempo.grupos.forEach(grupo => {
                    const grupoDiv = document.createElement('div');
                    grupoDiv.classList.add('minuta-grupo-alimento');
                    grupoDiv.style.marginLeft = "10px"; // Estilo

                    const grupoHeader = document.createElement('h5');
                    grupoHeader.textContent = grupo.grupo_descripcion;
                    grupoDiv.appendChild(grupoHeader);

                    // En lugar de textarea, para PDF/Email, podemos usar un div con el texto
                    // O mantener el textarea si se quiere que el usuario pueda copiar de ahí fácilmente aún.
                    // Por ahora mantenemos textarea para la interactividad de la "elección" mencionada.
                    const opcionesTextarea = document.createElement('textarea');
                    opcionesTextarea.rows = Math.max(4, grupo.opciones.length + 1);
                    opcionesTextarea.readOnly = false; // Permitir edición para "elegir"
                    opcionesTextarea.style.width = "95%";
                    opcionesTextarea.style.padding = "5px";
                    opcionesTextarea.style.border = "1px solid #ccc";
                    opcionesTextarea.dataset.tiempoId = tiempo.id_tiempo_comida;
                    opcionesTextarea.dataset.grupoDesc = grupo.grupo_descripcion;

                    let opcionesTexto = '';
                    grupo.opciones.forEach(opcion => {
                        opcionesTexto += `- ${opcion.cantidad} ${opcion.medida} de ${opcion.alimento}\n`;
                    });
                    opcionesTextarea.value = opcionesTexto.trim();

                    grupoDiv.appendChild(opcionesTextarea);
                    tiempoDiv.appendChild(grupoDiv);
                });
            }
            minutaModalBody.appendChild(tiempoDiv);
        });
        // Div de indicaciones generales
        const indicacionesGeneralesDiv = document.createElement('div');
        indicacionesGeneralesDiv.id = 'minuta-indicaciones-generales-container'; // ID para fácil acceso
        indicacionesGeneralesDiv.style.marginTop = '25px'; // Espacio después de los tiempos de comida
        indicacionesGeneralesDiv.style.paddingTop = '15px';
        indicacionesGeneralesDiv.style.borderTop = '1px solid #eee';

        const indicacionesLabel = document.createElement('h4'); // Usar un encabezado para destacarlo
        indicacionesLabel.textContent = 'Indicaciones Adicionales:';
        indicacionesLabel.style.marginBottom = '8px';

        const indicacionesTextarea = document.createElement('textarea');
        indicacionesTextarea.id = 'minuta-indicaciones-generales-textarea'; // ID para fácil acceso
        indicacionesTextarea.rows = 4; // Puedes ajustar esto
        indicacionesTextarea.placeholder = 'Ej: Mantener una buena hidratación, realizar actividad física regularmente...';
        indicacionesTextarea.style.width = '100%';
        indicacionesTextarea.style.minHeight = '80px';
        indicacionesTextarea.style.padding = '8px';
        indicacionesTextarea.style.border = '1px solid #ccc';
        indicacionesTextarea.style.borderRadius = '4px';
        indicacionesTextarea.style.boxSizing = 'border-box';

        // PRE-POBLAR SI YA EXISTEN INDICACIONES GENERALES GUARDADAS
        // Necesitarás tener esta información en `currentGeneratedMinutaData` o `data`
        // Por ejemplo, si `data.indicaciones_generales_minuta` existe:
        if (data.indicaciones_generales_minuta) { 
            indicacionesTextarea.value = data.indicaciones_generales_minuta;
        }

        indicacionesGeneralesDiv.appendChild(indicacionesLabel);
        indicacionesGeneralesDiv.appendChild(indicacionesTextarea);
        minutaModalBody.appendChild(indicacionesGeneralesDiv);
    }

    function closeMinutaModal() {
        minutaModal.style.display = 'none';
        minutaModalBody.innerHTML = '';
        currentGeneratedMinutaData = null;
        if (minutaModalStatus) minutaModalStatus.textContent = '';
    }

    // --- NUEVAS FUNCIONES PARA LOS BOTONES DEL MODAL ---

    function getMinutaHtmlForExport() {
        // Clonamos el nodo para no afectar el original con manipulaciones de estilo
        const contentToExport = minutaModalBody.cloneNode(true);

        // Sincronizar el valor actual del textarea antes de exportar ---
        const originalTextarea = document.getElementById('minuta-indicaciones-generales-textarea');
        const clonedTextarea = contentToExport.querySelector('#minuta-indicaciones-generales-textarea');
        if (originalTextarea && clonedTextarea) {
            clonedTextarea.value = originalTextarea.value;
        }
        
        // Convertir textareas a divs con <pre> para preservar saltos de línea
        // y hacerlos no editables para la exportación.
        const textareas = contentToExport.querySelectorAll('textarea');
        textareas.forEach(ta => {
            const pre = document.createElement('pre');
            pre.textContent = ta.value;
            pre.style.fontFamily = 'inherit'; // Mantener la fuente
            pre.style.whiteSpace = 'pre-wrap'; // Asegurar que el texto se ajuste
            pre.style.margin = '0';
            pre.style.padding = '5px';
            pre.style.border = '1px solid #ddd'; // Un borde ligero para visualización
            pre.style.backgroundColor = '#f9f9f9';
            ta.parentNode.replaceChild(pre, ta);
        });
        const indicacionesGeneralesContainerCloned = contentToExport.querySelector('#minuta-indicaciones-generales-container');
        if (indicacionesGeneralesContainerCloned) {
            const textareaIndicaciones = indicacionesGeneralesContainerCloned.querySelector('#minuta-indicaciones-generales-textarea');
            if (textareaIndicaciones && textareaIndicaciones.value.trim() !== "") {
                // Reemplazar el textarea con un div/p para el formato de exportación
                const divParaExportar = document.createElement('div');
                // Copia los estilos relevantes o aplica nuevos para la exportación
                divParaExportar.style.marginTop = '25px';
                divParaExportar.style.paddingTop = '15px';
                divParaExportar.style.borderTop = '1px solid #eee';

                const labelExportar = document.createElement('h4');
                labelExportar.textContent = 'Indicaciones Adicionales Generales:';
                labelExportar.style.marginBottom = '8px';
                
                const pExportar = document.createElement('p');
                pExportar.textContent = textareaIndicaciones.value;
                pExportar.style.whiteSpace = 'pre-wrap'; // Para mantener saltos de línea
                pExportar.style.padding = '8px';
                pExportar.style.border = '1px dashed #eee';
                pExportar.style.backgroundColor = '#fdfdfd';


                divParaExportar.appendChild(labelExportar);
                divParaExportar.appendChild(pExportar);

                // Reemplazar el contenedor original del textarea con el formateado para exportar
                indicacionesGeneralesContainerCloned.innerHTML = ''; // Limpiar el contenido del contenedor
                indicacionesGeneralesContainerCloned.appendChild(divParaExportar); // Añadir el nuevo contenido formateado
            } else if (textareaIndicaciones) {
                // Si el textarea está vacío, eliminar todo el contenedor de indicaciones generales de la exportación
                indicacionesGeneralesContainerCloned.parentNode.removeChild(indicacionesGeneralesContainerCloned);
            }
        }
        return contentToExport.innerHTML;
    }


    async function handleSaveMinutaPdf() {
        if (!minutaModalBody || !minutaModalBody.innerHTML.trim()) {
            alert("No hay contenido en la minuta para generar el PDF.");
            return;
        }
        if (minutaModalStatus) {
            minutaModalStatus.textContent = 'Generando PDF...';
            minutaModalStatus.className = 'info';
        }
        saveMinutaPdfBtn.disabled = true;
        sendMinutaEmailBtn.disabled = true;


        // Usar una copia del contenido para no modificar el modal original si hacemos cambios
        const contentForPdf = minutaModalBody.cloneNode(true);

        // Opcional: Estilos adicionales específicos para el PDF
        // Por ejemplo, asegurar que los textareas se vean bien como texto.
        // Se puede convertir textareas a divs con su contenido si es necesario.
        const textareasInPdf = contentForPdf.querySelectorAll('textarea');
        textareasInPdf.forEach(ta => {
            // Crear un div que reemplace el textarea para el PDF
            const div = document.createElement('div');
            div.style.border = "1px solid #ccc";
            div.style.padding = "5px";
            div.style.whiteSpace = "pre-wrap"; // para mantener los saltos de línea
            div.style.fontFamily = "inherit"; // para mantener la fuente del textarea
            div.style.minHeight = ta.rows > 1 ? `${ta.rows * 1.2}em` : 'auto'; // Aproximar altura
            div.textContent = ta.value;
            ta.parentNode.replaceChild(div, ta);
        });
        
        const opt = {
            margin:       [10, 10, 15, 10], // top, left, bottom, right en mm
            filename:     `minuta_paciente_${PACIENTE_ID}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, logging: false }, // Aumentar escala para mejor calidad
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            await html2pdf().from(contentForPdf).set(opt).save();
            if (minutaModalStatus) {
                minutaModalStatus.textContent = 'PDF generado y descargado.';
                minutaModalStatus.className = 'success';
            }
        } catch (error) {
            console.error("Error generando PDF:", error);
            if (minutaModalStatus) {
                minutaModalStatus.textContent = 'Error al generar PDF.';
                minutaModalStatus.className = 'error';
            }
        } finally {
            saveMinutaPdfBtn.disabled = false;
            sendMinutaEmailBtn.disabled = false;
             setTimeout(() => {
                if (minutaModalStatus && (minutaModalStatus.className === 'success' || minutaModalStatus.className === 'error' )) {
                    minutaModalStatus.textContent = '';
                }
            }, 3000);
        }
    }

    async function handleSendMinutaEmail() {
        if (!minutaModalBody || !minutaModalBody.innerHTML.trim()) {
            alert("No hay contenido en la minuta para enviar por correo.");
            return;
        }
        if (minutaModalStatus) {
            minutaModalStatus.textContent = 'Enviando correo...';
            minutaModalStatus.className = 'info';
        }
        saveMinutaPdfBtn.disabled = true;
        sendMinutaEmailBtn.disabled = true;

        // Obtener el contenido HTML de la minuta, con textareas convertidos
        const minutaHtmlContent = getMinutaHtmlForExport();

        try {
            const csrfToken = getCookie('csrftoken');
            // La URL debe coincidir con la que definas en urls.py
            const response = await fetch(`/patients/${PACIENTE_ID}/enviar_minuta_por_correo/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ minuta_html: minutaHtmlContent })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                if (minutaModalStatus) {
                    minutaModalStatus.textContent = result.message || 'Correo enviado exitosamente.';
                    minutaModalStatus.className = 'success';
                }
            } else {
                throw new Error(result.message || 'Error al enviar el correo.');
            }
        } catch (error) {
            console.error("Error enviando correo:", error);
            if (minutaModalStatus) {
                minutaModalStatus.textContent = `Error: ${error.message}`;
                minutaModalStatus.className = 'error';
            }
        } finally {
            saveMinutaPdfBtn.disabled = false;
            sendMinutaEmailBtn.disabled = false;
            setTimeout(() => {
                if (minutaModalStatus && (minutaModalStatus.className === 'success' || minutaModalStatus.className === 'error' )) {
                    minutaModalStatus.textContent = '';
                }
            }, 4000);
        }
    }


    // --- El resto de tu JavaScript existente ---
    // (fetchAdecuacionData, displayAdecuacionData, loadAndDisplayAdecuacion, fetchApiData, etc.)
    // ... (Tu código JS extenso aquí, no lo repetiré todo por brevedad)

    // --- FUNCIONES PARA ADECUACIÓN ---
    async function fetchAdecuacionData() {
        if (!PACIENTE_ID) {
            return { data: null, status: 'error', message: "ID de paciente no disponible." };
        }
        if(adecuacionStatusEl) {
            adecuacionStatusEl.textContent = "Actualizando datos de adecuación...";
            adecuacionStatusEl.className = 'loading';
            adecuacionStatusEl.style.display = 'block';
        }

        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_adecuacion_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();

            if (!response.ok) {
                if (result && result.status === "not_found") {
                    return { data: null, status: 'not_found', message: result.mensaje };
                }
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            
            if (result.status === "success" && result.data) {
                return { data: result.data, status: 'success' };
            } else if (result.status === "not_found") { 
                return { data: null, status: 'not_found', message: result.mensaje };
            } else {
                throw new Error(result.mensaje || "Formato de respuesta inesperado para adecuación.");
            }
        } catch (error) {
            console.error("Error al obtener datos de adecuación:", error);
            return { data: null, status: 'error', message: error.message };
        }
    }

    function displayAdecuacionData(apiResponse) {
        if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = '- %';
        if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = '- %';
        if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = '- %';
        if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = '- %';

        if (!adecuacionStatusEl) return;

        if (apiResponse.status === 'success' && apiResponse.data) {
            const data = apiResponse.data;
            if(adecuacionCaloricoEl) adecuacionCaloricoEl.textContent = `${parseFloat(data.porc_adecuacion_calorico).toFixed(2)} %`;
            if(adecuacionProteinasEl) adecuacionProteinasEl.textContent = `${parseFloat(data.porc_adec_proteinas).toFixed(2)} %`;
            if(adecuacionCarbohidratosEl) adecuacionCarbohidratosEl.textContent = `${parseFloat(data.porc_adec_carbohidratos).toFixed(2)} %`;
            if(adecuacionLipidosEl) adecuacionLipidosEl.textContent = `${parseFloat(data.porc_adec_lipidos).toFixed(2)} %`;
            
            adecuacionStatusEl.textContent = "Datos de adecuación actualizados."; 
            adecuacionStatusEl.className = 'success';
            adecuacionStatusEl.style.display = 'none'; 
        } else if (apiResponse.status === 'not_found') {
            adecuacionStatusEl.textContent = apiResponse.message || "Aún no hay porcentajes de adecuación. ¡Aparecerán una vez que agregues el primer tiempo de comida!";
            adecuacionStatusEl.className = 'info'; 
            adecuacionStatusEl.style.display = 'block';
        } else { 
            adecuacionStatusEl.textContent = `Error al cargar adecuación: ${apiResponse.message || 'Desconocido.'}`;
            adecuacionStatusEl.className = 'error';
            adecuacionStatusEl.style.display = 'block';
        }
    }
    
    async function loadAndDisplayAdecuacion() {
        const adecuacionApiResponse = await fetchAdecuacionData();
        displayAdecuacionData(adecuacionApiResponse);
    }

    // --- FUNCIONES PARA DATOS BASE Y DETALLES GUARDADOS ---
    async function fetchApiData(url, type) { 
        try {
            const response = await fetch(url);
            if (!response.ok) {
                 const errorData = await response.text();
                throw new Error(`Error HTTP ${response.status} al obtener ${type}: ${errorData}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Error en fetchApiData para ${type}:`, error);
            if(generalStatusDiv) {
                generalStatusDiv.textContent = `Error al cargar ${type}. ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            throw error; 
        }
    }

    async function fetchSavedMinutaDetails() {
        if (!PACIENTE_ID) {
             return null;
        }
        try {
            const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_detalle_minuta?pacienteId=${PACIENTE_ID}`);
            const result = await response.json();
            if (!response.ok) {
                if (response.status === 404 || (result && result.status === 'not_found')) return []; 
                throw new Error(result.mensaje || result.detail || `Error HTTP ${response.status}`);
            }
            if (result.status === 'success' && result.data && Array.isArray(result.data.detalles_minuta)) return result.data.detalles_minuta; 
            else if (result.status === 'not_found') return [];
            else { console.warn("fetchSavedMinutaDetails: Formato inesperado", result); return []; }
        } catch (error) {
            console.error("Error en fetchSavedMinutaDetails:", error);
            if(generalStatusDiv && generalStatusDiv.textContent.indexOf('Error al cargar detalles guardados') === -1) {
                generalStatusDiv.textContent += ` | Error al cargar detalles guardados: ${error.message}`;
                generalStatusDiv.className = 'error';
            }
            return null; 
        }
    }

    // --- FUNCIONES DE MANEJO DEL DOM Y ESTADO ---
    function updateAddMealButtonState() {
        if (!addMealTimeBtn) return;
        const availableTimes = getAvailableMealTimes();
        if (availableTimes.length > 0) {
            addMealTimeBtn.style.display = 'inline-block';
            addMealTimeBtn.disabled = false;
        } else {
            addMealTimeBtn.style.display = 'none';
            addMealTimeBtn.disabled = true;
        }
    }

    function getSelectedMealTimeIds() {
        const selected = [];
        if(mealTimesContainer) {
            mealTimesContainer.querySelectorAll('.meal-time-select').forEach(select => {
                if (select.value) selected.push(parseInt(select.value));
            });
        }
        return selected;
    }

    function getAvailableMealTimes() {
        const selectedIds = getSelectedMealTimeIds();
        return ALL_MEAL_TIMES_DATA.filter(time => !selectedIds.includes(time.id_tiempo_comida));
    }
    
    function populateSelectWithOptions(selectElement, availableTimes, currentValue) {
        selectElement.innerHTML = ''; 
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "-- Seleccione Tiempo --";
        selectElement.appendChild(placeholder);

        if (currentValue) {
            const currentOptionData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === currentValue);
            if (currentOptionData) {
                const opt = document.createElement('option');
                opt.value = currentOptionData.id_tiempo_comida;
                opt.textContent = currentOptionData.descripcion;
                selectElement.appendChild(opt);
                opt.selected = true; 
            } else { 
                 placeholder.selected = true;
            }
        } else {
            placeholder.selected = true;
        }
        availableTimes.forEach(time => {
            if (time.id_tiempo_comida !== currentValue) {
                const option = document.createElement('option');
                option.value = time.id_tiempo_comida;
                option.textContent = time.descripcion;
                selectElement.appendChild(option);
            }
        });
        if (!selectElement.value && selectElement.options.length > 0) {
            placeholder.selected = true;
        }
    }

    function updateAllSelects() {
        if(!mealTimesContainer) return;
        const allSelects = mealTimesContainer.querySelectorAll('.meal-time-select');
        const selectedIdsOverall = getSelectedMealTimeIds();
        allSelects.forEach(currentSelect => {
            const currentValueForThisSelect = currentSelect.value ? parseInt(currentSelect.value) : null;
            const availableForThisSelect = ALL_MEAL_TIMES_DATA.filter(time => {
                return time.id_tiempo_comida === currentValueForThisSelect || !selectedIdsOverall.includes(time.id_tiempo_comida);
            });
            populateSelectWithOptions(currentSelect, availableForThisSelect, currentValueForThisSelect);
        });
        updateAddMealButtonState(); 
    }
    
    function convertTo24HourFormat(timeString) {
        if (!timeString || typeof timeString !== 'string') return '';
        const timeStringLower = timeString.toLowerCase().trim();
        const match = timeStringLower.match(/^(\d{1,2}):(\d{2})\s*(am|pm)?$/);
        if (!match) {
            if (/^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString.trim())) return timeString.trim();
            return ''; 
        }
        let hours = parseInt(match[1], 10);
        const minutes = parseInt(match[2], 10);
        const period = match[3];
        if (period === 'am' && hours === 12) hours = 0;
        else if (period === 'pm' && hours !== 12) hours += 12;
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return '';
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    function createAndPopulateMealTimeEntry(tiempoComidaId, hora, portionsMap) {
        if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0 || !mealTimesContainer) return;
        const entryIdSuffix = mealTimeEntryCounter;
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('meal-time-entry');
        entryDiv.id = `meal-entry-${entryIdSuffix}`;
        entryDiv.dataset.entryId = entryIdSuffix;

        const selectorDiv = document.createElement('div');
        selectorDiv.classList.add('meal-time-selector');
        const selectLabel = document.createElement('label');
        selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
        selectLabel.textContent = `Tiempo de Comida:`;
        const selectElement = document.createElement('select');
        selectElement.id = `meal-time-select-${entryIdSuffix}`;
        selectElement.classList.add('meal-time-select');
        selectElement.required = true;
        
        const availableNow = getAvailableMealTimes(); 
        const allOptionsForThis = [...availableNow];
        const currentTimeData = ALL_MEAL_TIMES_DATA.find(t => t.id_tiempo_comida === tiempoComidaId);
        if (currentTimeData && !allOptionsForThis.some(t => t.id_tiempo_comida === tiempoComidaId)) {
            allOptionsForThis.push(currentTimeData); 
            allOptionsForThis.sort((a, b) => a.id_tiempo_comida - b.id_tiempo_comida); 
        }
        populateSelectWithOptions(selectElement, allOptionsForThis, tiempoComidaId); 
        
        selectorDiv.appendChild(selectLabel);
        selectorDiv.appendChild(selectElement);

        const timeInputDiv = document.createElement('div');
        timeInputDiv.classList.add('time-input-container');
        const timeLabel = document.createElement('label');
        timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
        timeLabel.textContent = 'Hora:';
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.id = `meal-hour-input-${entryIdSuffix}`;
        timeInput.classList.add('meal-hour-input'); 
        timeInput.required = true;
        timeInput.value = convertTo24HourFormat(hora);
        timeInputDiv.appendChild(timeLabel);
        timeInputDiv.appendChild(timeInput);
        selectorDiv.appendChild(timeInputDiv); 
        entryDiv.appendChild(selectorDiv);

        const tableDiv = document.createElement('div');
        tableDiv.classList.add('food-portions-table');
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        foodGroupsData.forEach(group => {
            const th = document.createElement('th');
            th.textContent = group.descripcion;
            th.dataset.grupoId = group.id_grupo_alimenticio; 
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const inputRow = document.createElement('tr');
        foodGroupsData.forEach(group => {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '0.1'; 
            input.placeholder = '0';
            input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
            input.dataset.grupoId = group.id_grupo_alimenticio; 
            const savedPortion = portionsMap[group.id_grupo_alimenticio];
            if (savedPortion !== undefined && savedPortion !== null) input.value = savedPortion;
            td.appendChild(input);
            inputRow.appendChild(td);
        });
        tbody.appendChild(inputRow);
        table.appendChild(tbody);
        tableDiv.appendChild(table);
        entryDiv.appendChild(tableDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('meal-entry-actions');
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Guardar Cambios'; 
        saveButton.classList.add('save-single-meal-btn');
        saveButton.type = 'button';
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Eliminar Tiempo de Comida';
        deleteButton.classList.add('delete-single-meal-btn');
        deleteButton.type = 'button';
        const statusDiv = document.createElement('div');
        statusDiv.classList.add('single-save-status');
        saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv)); 
        deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
        actionsDiv.appendChild(saveButton);
        actionsDiv.appendChild(deleteButton);
        actionsDiv.appendChild(statusDiv);
        entryDiv.appendChild(actionsDiv);
        
        mealTimesContainer.appendChild(entryDiv);
        selectElement.addEventListener('change', updateAllSelects);
        mealTimeEntryCounter++;
    }
    
    function processAndDisplaySavedDetails(savedDetailsArray) {
        if (!Array.isArray(savedDetailsArray) || savedDetailsArray.length === 0) return;
        const groupedDetails = savedDetailsArray.reduce((acc, detail) => {
            const tiempoId = detail.id_tiempo_comida;
            if (!acc[tiempoId]) {
                acc[tiempoId] = { hora: detail.hora_tiempo_comida, portions: {} };
            }
            acc[tiempoId].portions[detail.id_grupo_alimenticio] = detail.numero_porciones_grupo;
            return acc;
        }, {});
        const sortedTiempoIds = Object.keys(groupedDetails).sort((a, b) => parseInt(a) - parseInt(b));
        sortedTiempoIds.forEach(tiempoIdStr => {
             const tiempoId = parseInt(tiempoIdStr, 10);
             const details = groupedDetails[tiempoId];
             createAndPopulateMealTimeEntry(tiempoId, details.hora, details.portions);
        });
    }

    function addMealTimeEntry() {
         if (!mealTimesContainer || !addMealTimeBtn) return; 
         if (foodGroupsData.length === 0 || ALL_MEAL_TIMES_DATA.length === 0) {
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Datos base no cargados.";
                 generalStatusDiv.className = 'warning';
             }
             return;
         }
         const entryIdSuffix = mealTimeEntryCounter;
         const entryDiv = document.createElement('div');
         entryDiv.classList.add('meal-time-entry');
         entryDiv.id = `meal-entry-${entryIdSuffix}`;
         entryDiv.dataset.entryId = entryIdSuffix;

         const selectorDiv = document.createElement('div');
         selectorDiv.classList.add('meal-time-selector');
         const selectLabel = document.createElement('label');
         selectLabel.htmlFor = `meal-time-select-${entryIdSuffix}`;
         selectLabel.textContent = `Nuevo Tiempo de Comida:`;
         const selectElement = document.createElement('select');
         selectElement.id = `meal-time-select-${entryIdSuffix}`;
         selectElement.classList.add('meal-time-select');
         selectElement.required = true;
         const availableTimes = getAvailableMealTimes();
         populateSelectWithOptions(selectElement, availableTimes, null); 
         selectorDiv.appendChild(selectLabel);
         selectorDiv.appendChild(selectElement);

         const timeInputDiv = document.createElement('div');
         timeInputDiv.classList.add('time-input-container');
         const timeLabel = document.createElement('label');
         timeLabel.htmlFor = `meal-hour-input-${entryIdSuffix}`;
         timeLabel.textContent = 'Hora:';
         const timeInput = document.createElement('input');
         timeInput.type = 'time';
         timeInput.id = `meal-hour-input-${entryIdSuffix}`;
         timeInput.classList.add('meal-hour-input');
         timeInput.required = true;
         timeInputDiv.appendChild(timeLabel);
         timeInputDiv.appendChild(timeInput);
         selectorDiv.appendChild(timeInputDiv);
         entryDiv.appendChild(selectorDiv);

         const tableDiv = document.createElement('div');
         tableDiv.classList.add('food-portions-table');
         const table = document.createElement('table');
         const thead = document.createElement('thead');
         const headerRow = document.createElement('tr');
         foodGroupsData.forEach(group => {
             const th = document.createElement('th');
             th.textContent = group.descripcion;
             th.dataset.grupoId = group.id_grupo_alimenticio;
             headerRow.appendChild(th);
         });
         thead.appendChild(headerRow);
         table.appendChild(thead);
         const tbody = document.createElement('tbody');
         const inputRow = document.createElement('tr');
         foodGroupsData.forEach(group => {
             const td = document.createElement('td');
             const input = document.createElement('input');
             input.type = 'number';
             input.min = '0';
             input.step = '0.1';
             input.placeholder = '0';
             input.name = `minuta[${entryIdSuffix}][porciones][${group.id_grupo_alimenticio}]`;
             input.dataset.grupoId = group.id_grupo_alimenticio;
             td.appendChild(input);
             inputRow.appendChild(td);
         });
         tbody.appendChild(inputRow);
         table.appendChild(tbody);
         tableDiv.appendChild(table);
         entryDiv.appendChild(tableDiv);

         const actionsDiv = document.createElement('div');
         actionsDiv.classList.add('meal-entry-actions');
         const saveButton = document.createElement('button');
         saveButton.textContent = 'Guardar Tiempo de Comida';
         saveButton.classList.add('save-single-meal-btn');
         saveButton.type = 'button';
         const deleteButton = document.createElement('button'); 
         deleteButton.textContent = 'Eliminar Tiempo de Comida';
         deleteButton.classList.add('delete-single-meal-btn');
         deleteButton.type = 'button';
         const statusDiv = document.createElement('div');
         statusDiv.classList.add('single-save-status');
         saveButton.addEventListener('click', () => handleSaveSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         deleteButton.addEventListener('click', () => handleDeleteSingleMealEntry(entryDiv, saveButton, deleteButton, statusDiv));
         actionsDiv.appendChild(saveButton);
         actionsDiv.appendChild(deleteButton);
         actionsDiv.appendChild(statusDiv);
         entryDiv.appendChild(actionsDiv);

         mealTimesContainer.appendChild(entryDiv);
         selectElement.addEventListener('change', updateAllSelects);
         mealTimeEntryCounter++;
         updateAllSelects(); 
    }

    // --- FUNCIÓN DE GUARDADO INDIVIDUAL ---
    async function handleSaveSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) {
        saveBtn.disabled = true;
        if (deleteBtn) deleteBtn.disabled = true;
        statusEl.textContent = 'Guardando...';
        statusEl.className = 'single-save-status info';

        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const horaTiempoComidaInput = entryElement.querySelector('.meal-hour-input');
        const tiempoComidaId = tiempoComidaSelect.value;
        const horaTiempoComida = horaTiempoComidaInput.value; 
        let hasValidationError = false;

        if (!tiempoComidaId) { tiempoComidaSelect.style.borderColor = 'red'; hasValidationError = true; } 
        else { tiempoComidaSelect.style.borderColor = ''; }
        if (!horaTiempoComida) { horaTiempoComidaInput.style.borderColor = 'red'; hasValidationError = true; } 
        else { horaTiempoComidaInput.style.borderColor = ''; }

        if (hasValidationError) {
            statusEl.textContent = 'Complete tiempo y hora.';
            statusEl.className = 'single-save-status error';
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
            return;
        }

        const detallePromises = [];
        const porcionesInputs = entryElement.querySelectorAll('.food-portions-table input[type="number"]');
        porcionesInputs.forEach(input => {
            const numeroPorciones = parseFloat(input.value);
            if (!isNaN(numeroPorciones) && numeroPorciones >= 0) { 
                const grupoAlimenticioId = input.dataset.grupoId;
                const payload = {
                    pacienteId: PACIENTE_ID,
                    numeroPorcionesGrupo: numeroPorciones, 
                    grupoAlimenticioId: parseInt(grupoAlimenticioId),
                    tiempoComidaId: parseInt(tiempoComidaId),
                    horaTiempoComida: horaTiempoComida
                };
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
                detallePromises.push(
                    fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_detalle_minuta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payload)
                    }).then(response => {
                        if (!response.ok) {
                             return response.json().then(err => { throw new Error(`Error detalle ${response.status}: ${err.detail || JSON.stringify(err)}`); });
                        }
                        return response.json();
                    })
                );
            } else if (input.value.trim() !== '') { 
                 input.style.borderColor = 'orange'; 
            } else {
                input.style.borderColor = ''; 
            }
        });

        try {
            if (detallePromises.length > 0) {
                await Promise.all(detallePromises);
                statusEl.textContent = 'Porciones guardadas. Actualizando adecuación...';
            } else {
                 statusEl.textContent = 'No hay porciones (>=0) especificadas. Actualizando adecuación...';
            }
            statusEl.className = 'single-save-status info';

            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
            const adecuacionPayload = { pacienteId: PACIENTE_ID };
            const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(adecuacionPayload)
            });

            if (!adecuacionResponse.ok) {
                const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación."}));
                throw new Error(`Error al guardar adecuación ${adecuacionResponse.status}: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
            }

            await loadAndDisplayAdecuacion(); 
            
            statusEl.textContent = 'Guardado exitosamente.';
            statusEl.className = 'single-save-status success';
            setTimeout(() => { 
                 if (statusEl.className === 'single-save-status success') statusEl.textContent = '';
            }, 3000);

        } catch (error) {
            console.error("Error en guardado individual:", error);
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'single-save-status error';
        } finally {
            saveBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false; 
            updateAddMealButtonState(); 
        }
    }

    // --- FUNCIÓN PARA ELIMINAR ---
    async function handleDeleteSingleMealEntry(entryElement, saveBtn, deleteBtn, statusEl) {
        const tiempoComidaSelect = entryElement.querySelector('.meal-time-select');
        const tiempoComidaId = tiempoComidaSelect.value;

        if (!tiempoComidaId) {
            statusEl.textContent = 'Seleccione un tiempo de comida para eliminar.';
            statusEl.className = 'single-save-status error';
            setTimeout(() => { if (statusEl.className === 'single-save-status error') statusEl.textContent = ''; }, 3000);
            return;
        }

        if (!confirm(`¿Está seguro de que desea eliminar todos los datos para el tiempo de comida "${tiempoComidaSelect.options[tiempoComidaSelect.selectedIndex].text}"? Esta acción no se puede deshacer.`)) {
            return;
        }

        saveBtn.disabled = true;
        deleteBtn.disabled = true;
        statusEl.textContent = 'Eliminando...';
        statusEl.className = 'single-save-status info';

        try {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
            const url = new URL('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/eliminar_detalle_ultima_minuta');
            url.searchParams.append('pacienteId', PACIENTE_ID);
            url.searchParams.append('tiempoComidaId', tiempoComidaId);

            const deleteResponse = await fetch(url.toString(), {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });

            const result = await deleteResponse.json();

            if (!deleteResponse.ok) {
                throw new Error(result.mensaje || `Error al eliminar ${deleteResponse.status}`);
            }

            statusEl.textContent = result.mensaje || 'Eliminado exitosamente.';
            statusEl.className = 'single-save-status success';
            
            entryElement.remove(); 
            updateAllSelects();    
            
            const adecuacionPayload = { pacienteId: PACIENTE_ID };
            const adecuacionResponse = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/guardar_adecuacion_minuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(adecuacionPayload)
            });
            if (!adecuacionResponse.ok) {
                const errAdecuacion = await adecuacionResponse.json().catch(() => ({detail: "Error al procesar respuesta de guardar adecuación post-eliminación."}));
                console.warn(`Advertencia al guardar adecuación post-eliminación: ${errAdecuacion.detail || errAdecuacion.mensaje || JSON.stringify(errAdecuacion)}`);
            }
            await loadAndDisplayAdecuacion(); 

        } catch (error) {
            console.error("Error al eliminar tiempo de comida:", error);
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'single-save-status error';
            saveBtn.disabled = false; 
            deleteBtn.disabled = false;
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- INICIALIZACIÓN DE LA PÁGINA ---
    async function initializePage() {
        if(addMealTimeBtn) {
            addMealTimeBtn.style.display = 'none'; 
            addMealTimeBtn.disabled = true;
        }
        if(generateMinutaBtn && PACIENTE_ID === null) { 
             generateMinutaBtn.disabled = true;
        }

        if(generalStatusDiv) {
            generalStatusDiv.textContent = "Cargando datos...";
            generalStatusDiv.className = 'info';
        }
        
        if(mealTimesContainer) mealTimesContainer.innerHTML = ''; 
        mealTimeEntryCounter = 0; 

        const [adecuacionResponse, mealTimes, foodGroups, savedDetails] = await Promise.all([
            fetchAdecuacionData(),
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/obtener_tiempos_comida_con_id', 'tiempos de comida').catch(e => {console.error("Error cargando tiempos de comida:", e); return null;}), 
            fetchApiData('https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id', 'grupos alimenticios').catch(e => {console.error("Error cargando grupos alimenticios:", e); return null;}),
            fetchSavedMinutaDetails().catch(e => {console.error("Error cargando detalles guardados:", e); return null;})
        ]).catch(error => {
             console.error("Error en Promise.all de initializePage:", error);
             if(generalStatusDiv) {
                 generalStatusDiv.textContent = "Error crítico al cargar datos iniciales.";
                 generalStatusDiv.className = 'error';
             }
             return [null, null, null, null]; 
        });

        displayAdecuacionData(adecuacionResponse || { status: 'error', message: 'Fallo carga adecuación.' });

        if (!mealTimes || !foodGroups) {
             if(generalStatusDiv && generalStatusDiv.className !== 'error') { 
                 generalStatusDiv.textContent = "Error: No se pudieron cargar los datos base (tiempos/grupos).";
                 generalStatusDiv.className = 'error';
             }
             updateAddMealButtonState(); 
             return; 
        }

        ALL_MEAL_TIMES_DATA = mealTimes; 
        foodGroupsData = foodGroups;     

        if (savedDetails && savedDetails.length > 0) {
            processAndDisplaySavedDetails(savedDetails);
        } else if (savedDetails === null && generalStatusDiv && generalStatusDiv.className !== 'error') {
            generalStatusDiv.textContent = ""; 
        } else if (generalStatusDiv && generalStatusDiv.className === 'info' && (!savedDetails || savedDetails.length === 0)) {
            // generalStatusDiv.textContent = "No hay tiempos de comida guardados para este paciente."; // Comentado para no ser tan verboso
        }

        updateAllSelects(); 
        updateAddMealButtonState();

        if(generalStatusDiv && generalStatusDiv.className !== 'error' && (!adecuacionStatusEl || adecuacionStatusEl.className === 'success' || adecuacionStatusEl.className === 'info')) {
             setTimeout(() => { 
                if(generalStatusDiv && generalStatusDiv.className !== 'error' && generalStatusDiv.className !== 'loading') {
                    generalStatusDiv.style.display = 'none'; 
                }
            }, 2000);
        } else if (generalStatusDiv && generalStatusDiv.className === 'info') {
            generalStatusDiv.textContent = "";
        }
    }
    
    // --- Event Listeners ---
    if(addMealTimeBtn) addMealTimeBtn.addEventListener('click', addMealTimeEntry);
    if(generateMinutaBtn) generateMinutaBtn.addEventListener('click', openGenerateMinutaModal);
    if(closeModalBtn) closeModalBtn.addEventListener('click', closeMinutaModal);
    
    // Event listeners para los NUEVOS botones
    if(saveMinutaPdfBtn) saveMinutaPdfBtn.addEventListener('click', handleSaveMinutaPdf);
    if(sendMinutaEmailBtn) sendMinutaEmailBtn.addEventListener('click', handleSendMinutaEmail);

    window.addEventListener('click', (event) => {
        if (event.target == minutaModal) {
            closeMinutaModal();
        }
    });

    initializePage();
});
</script>
{% endblock %}