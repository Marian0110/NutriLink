{% extends "basePerfil.html" %}
{% load static %}

{% block title %}Antropometria{% endblock %}

{% block perfilcontent %}
<div class="container-a">
  <div class="metrica-card w-100">
    <div class="card-body">
      <h3 class="card-title mb-1 text-center mt-2">Datos Antropom√©tricos</h3>
      <h6 class="text-muted mb-4 text-center">Registra peso, talla, circunferencias, entre otros datos</h6>
      
      <form method="#" action="#" id="form-antropometrico">
        {% csrf_token %}

        
        
        <div class="row">
          <!-- Peso -->
          <div class="col-md-4 mb-3 mt-4">
            <label for="id_peso" class="form-label">Peso</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_peso" name="peso" placeholder="Ej: 65" min="0" step="any">
              <span class="input-group-text">kg</span>
            </div>
          </div>
          <!-- Talla -->
          <div class="col-md-4 mb-3 mt-4">
            <label for="id_talla" class="form-label">Talla</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_talla" name="talla" placeholder="Ej: 170" min="0" step="any">
              <span class="input-group-text">cm</span>
            </div>
          </div>
          <!-- Cintura -->
          <div class="col-md-4 mb-3 mt-4">
            <label for="id_cintura" class="form-label">Cintura</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_cintura" name="cintura" placeholder="Ej: 70" min="0" step="any">
              <span class="input-group-text">cm</span>
            </div>
          </div>
          <!-- Braquial -->
          <div class="col-md-4 mb-3">
            <label for="id_braquial" class="form-label">Per√≠metro braquial</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_braquial" name="braquial" placeholder="Ej: 29" min="0" step="any">
              <span class="input-group-text">cm</span>
            </div>
          </div>
          <!-- Tricipital -->
          <div class="col-md-4 mb-3">
            <label for="id_tricipital" class="form-label">Pliegue tricipital</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_tricipital" name="tricipital" placeholder="Ej: 23" min="0" step="any">
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <!-- Subescapular -->
          <div class="col-md-4 mb-3">
            <label for="id_subescapular" class="form-label">Pliegue subescapular</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_subescapular" name="subescapular" placeholder="Ej: 60" min="0" step="any">
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <!-- Suprailiaco -->
          <div class="col-md-4 mb-3">
            <label for="id_suprailiaco" class="form-label">Pliegue suprail√≠aco</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_suprailiaco" name="suprailiaco" placeholder="Ej: 30" min="0" step="any">
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <!-- Bicipital -->
          <div class="col-md-4 mb-3">
            <label for="id_bicipital" class="form-label">Pliegue bicipital</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_bicipital" name="bicipital" placeholder="Ej: 40" min="0" step="any">
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <!-- Fecha -->
          <div class="col-md-4 mb-3">
            <label for="id_fecha" class="form-label">Fecha</label>
            <input type="date" class="form-control" id="id_fecha" name="fecha">
          </div>

          <!-- Porcentaje de macronutrientes -->
        <h3 class="card-title mb-1 text-center mt-2">Porcentaje de macronutrientes</h3>
        <h6 class="text-muted mb-4 text-center">Elige el porcentaje de macronutrientes para el paciente</h6>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="id_porc_carbohidratos" class="form-label">Porcentaje de carbohidratos</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_porc_carbohidratos" name="porc_carbohidratos" placeholder="Ej: 50" min="0" max="100" step="any">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label for="id_porc_proteinas" class="form-label">Porcentaje de prote√≠nas</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_porc_proteinas" name="porc_proteinas" placeholder="Ej: 20" min="0" max="100" step="any">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label for="id_porc_lipidos" class="form-label">Porcentaje de l√≠pidos</label>
            <div class="input-group">
              <input type="number" class="form-control" id="id_porc_lipidos" name="porc_lipidos" placeholder="Ej: 30" min="0" max="100" step="any">
              <span class="input-group-text">%</span>
            </div>
          </div>
        </div>
        <!-- Fin Secci√≥n Porcentajes -->

        </div>
        <!-- Boton -->
        <div class="d-flex justify-content-center mt-4"> <!-- A√±adido mt-4 para espaciado -->
          <button type="button" class="btn btn-save">Guardar Datos y Calcular Requerimientos</button> <!-- Texto del bot√≥n actualizado -->
        </div>
      </form>
    </div>
  </div>
  <!-- Historial de mediciones ejemplo -->
  <div class="mt-1">
    <div class="historial-card w-100">
      <div class="card-body py-3">
        <h3 class="card-title mb-2">Historial de Mediciones</h3>
        <h6 class="text-muted mb-3">Visualiza los registros antropom√©tricos por fecha</h6>
        <div class="table-responsive">
          <table class="table table-striped table-bordered mt-3" id="tabla_mediciones">
            <thead class="table-dark">
              <tr>
                <th>Fecha</th>
                <th>Peso (kg)</th>
                <th>Talla (cm)</th>
                <th>Cintura (cm)</th>
                <th>Per√≠metro braquial (mm)</th>
                <th>Pliegue tricipital (mm)</th>
                <th>Pliegue subescapular (mm)</th>
                <th>Pliegue suprail√≠aco (mm)</th>
                <th>Pliegue bicipital (mm)</th>
              </tr>
            </thead>
            <tbody id="tabla_body">
              {% if historial_antropometrico %}
                {% for registro in historial_antropometrico %}
                  <tr>
                    <td>{{ registro.fecha }}</td>
                    <td>{{ registro.peso_kg|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.talla_cm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.circunferencia_cintura_cm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.perimetro_braquial_mm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.pliegue_tricipital_mm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.pliegue_subescapular_mm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.pliegue_suprailiaco_mm|floatformat:"-2"|default:"-" }}</td>
                    <td>{{ registro.pliegue_bicipital_mm|floatformat:"-2"|default:"-" }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                  <tr>
                    <td colspan="9" class="text-center text-muted">
                      No se encontraron registros antropom√©tricos
                    </td>
                  </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="container-a">
    <div class="metrica-card w-100 mb-4">
      <div class="card-body">
        <h3 class="card-title mb-2">Buscar diagn√≥sticos</h3>
        <form method="get" action="" id="form-diagnosticos">
          {% csrf_token %}
          <div class="row align-items-end">
            <div class="col-md-8 mb-3">
              <h6 class="text-muted mb-3">Visualiza los diagn√≥sticos antropom√©tricos</h6>
              <select class="form-select" id="id_fecha_select" name="fecha" required>
                <option value="">-- Selecciona una fecha --</option>
                  {% for fecha in fechas_disponibles %}
                    <option value="{{ fecha }}" {% if fecha_seleccionada == fecha %}selected{% endif %}>
                      {{ fecha }}
                    </option>
                  {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <button type="submit" class="btn btn-save w-100">
                  <i class="fas fa-search me-2"></i> Buscar
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="diagnosticos-card w-100 mt-1">
      <div class="card-body">
        <h3 class="mb-4">Diagn√≥sticos</h3>
        <div id="diagnosticos-container">
          {% if diagnosticos_data %}
            <div class="fecha-card">
              <div class="fecha-header">
                <div class="emoji-tag">üìã</div>
                <h5 class="mb-0">{{ diagnosticos_data.fecha }}</h5>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">√çndice masa corporal (IMC)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.imc.calculado|floatformat:2 }}</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.imc.diagnostico|default:"-" }}
                  </span>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">√çndice cintura-talla (ICT)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.indice_cintura_talla.calculado|floatformat:2 }}</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.indice_cintura_talla.diagnostico|default:"-" }}
                </span>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">Per√≠metro muscular braquial (PMB)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.perimetro_muscular_braquial.calculado|floatformat:2 }} mm¬≤</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.perimetro_muscular_braquial.diagnostico|default:"-" }}
                </span>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">√Årea muscular braquial (AMB)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.area_muscular_braquial.calculado|floatformat:2 }} mm¬≤</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.area_muscular_braquial.diagnostico|default:"-" }}
                </span>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">√Årea grasa braquial (AGB)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.area_grasa_braquial.calculado|floatformat:2 }} mm¬≤</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.area_grasa_braquial.diagnostico|default:"-" }}
                </span>
              </div>
              <div class="diagnostico-row">
                <span class="diagnostico-nombre">Grasa corporal (%)</span>
                <span class="diagnostico-valor">{{ diagnosticos_data.porc_grasa.calculado|floatformat:2 }}%</span>
                <span class="diagnostico-comentario">
                  {{ diagnosticos_data.porc_grasa.diagnostico|default:"-" }}
                </span>
              </div>
            </div>
            {% else %}
              <div class="text-center text-muted py-4">
                No se encontraron diagn√≥sticos para la fecha seleccionada.
              </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% if graficos_data %}
      <div class="graficos-card w-100 mt-4">
        <div class="card-body">
          <h3 class="card-title mb-2">Evoluci√≥n de m√©tricas</h3>
          <h6 class="text-muted mb-5">Visualiza el progreso en gr√°ficos</h6>
          <div class="row">
            {% if graficos_data.imc %}
              <div class="col-md-6 mb-4">
                <div class="chart-container">
                  {{ graficos_data.imc|safe }}
                </div>
              </div>
            {% endif %}
            {% if graficos_data.peso %}
              <div class="col-md-6 mb-4">
                <div class="chart-container">
                  {{ graficos_data.peso|safe }}
                </div>
              </div>
            {% endif %}
            {% if graficos_data.grasa %}
              <div class="col-md-6 mb-4">
                <div class="chart-container">
                  {{ graficos_data.grasa|safe }}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
</div>

<!-- Script aqui por el momento -->
<script>

function validarFormulario() {
    const form = document.getElementById('form-antropometrico');
    let isValid = true;
    let sumaPorcentajes = 0;
    const camposPorcentaje = ['id_porc_carbohidratos', 'id_porc_proteinas', 'id_porc_lipidos'];
    
    // Validacion de campos vacios (incluyendo los nuevos de porcentaje)
    form.querySelectorAll('input[type="number"], input[type="date"]').forEach(input => {
        if (!input.value) {
            isValid = false;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
            // Sumar porcentajes si son campos de macronutrientes
            if (camposPorcentaje.includes(input.id) && parseFloat(input.value) >= 0) {
                sumaPorcentajes += parseFloat(input.value);
            }
        }
    });

    // Validacion de valores negativos
    form.querySelectorAll('input[type="number"]').forEach(input => {
        if (parseFloat(input.value) < 0) {
            isValid = false;
            input.classList.add('is-invalid');
             // Si ya es inv√°lido por estar vac√≠o, no mostrar doble alerta
            if (input.value) { 
                Swal.fire({
                    title: 'Datos inv√°lidos',
                    text: `El campo "${input.previousElementSibling.textContent.trim()}" no puede ser negativo.`,
                    icon: 'warning'
                });
            }
        }
    });

    // Validacion de suma de porcentajes (opcional, pero buena pr√°ctica)
    // Permitir un peque√±o margen de error por decimales, ej. 99.9 a 100.1
    if (isValid && (sumaPorcentajes < 99.9 || sumaPorcentajes > 100.1) && (
        document.getElementById('id_porc_carbohidratos').value ||
        document.getElementById('id_porc_proteinas').value ||
        document.getElementById('id_porc_lipidos').value
    )) {
        isValid = false;
        camposPorcentaje.forEach(id => document.getElementById(id).classList.add('is-invalid'));
        Swal.fire({
            title: 'Porcentajes incorrectos',
            text: 'La suma de los porcentajes de macronutrientes debe ser 100%. Actualmente es: ' + sumaPorcentajes.toFixed(1) + '%',
            icon: 'warning'
        });
    }


    if (!isValid && !Swal.isVisible()) { // Evitar m√∫ltiples popups si ya hay uno de valor negativo o suma
        Swal.fire({
            title: 'Datos incompletos o inv√°lidos',
            text: 'Por favor complete todos los campos requeridos con valores v√°lidos.',
            icon: 'warning'
        });
    }
    return isValid;
}

// Func para enviar datos a la API
async function enviarDatosAntropometricosYRequerimientos() {
    const pacienteId = JSON.parse("{{ paciente.id_paciente|escapejs }}");
    const fecha = document.getElementById('id_fecha').value;

    try {
        // 1. Verificar Actividad F√≠sica
        const actividadFisicaResponse = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/paciente/obtener_actividad_fisica/${pacienteId}`);
        if (!actividadFisicaResponse.ok) {
            // Si la API devuelve un error al consultar, es un problema, pero no necesariamente que falte el dato.
            // Podr√≠amos decidir si mostrar un error gen√©rico o intentar continuar. Por ahora, asumimos que si no es OK, es un problema.
            let errorMsg = 'Error al verificar la actividad f√≠sica.';
            try {
                const errorData = await actividadFisicaResponse.json();
                errorMsg = errorData.mensaje || errorMsg;
            } catch (e) { /* No hacer nada si no se puede parsear el JSON del error */ }
            Swal.fire('Atenci√≥n', errorMsg, 'warning');
            return; // Detener la ejecuci√≥n si hay un error al consultar
        }
        const actividadFisicaData = await actividadFisicaResponse.json();
        if (actividadFisicaData.id_actividad_fisica === null || actividadFisicaData.valor_naf === null) {
            Swal.fire(
                'Falta Informaci√≥n',
                'Recuerda agregar el factor de actividad f√≠sica en la secci√≥n de historial cl√≠nico.',
                'warning'
            );
            return; // Detener la ejecuci√≥n
        }

        // 2. Verificar Factor Patol√≥gico
        const factorPatologicoResponse = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/paciente/obtener_factor_patologico/${pacienteId}`);
        if (!factorPatologicoResponse.ok) {
            let errorMsg = 'Error al verificar el factor patol√≥gico.';
            try {
                const errorData = await factorPatologicoResponse.json();
                errorMsg = errorData.mensaje || errorMsg;
            } catch (e) { /* No hacer nada */ }
            Swal.fire('Atenci√≥n', errorMsg, 'warning');
            return;
        }
        const factorPatologicoData = await factorPatologicoResponse.json();
        if (factorPatologicoData.descripcion === null || factorPatologicoData.valor_factor === null) {
            Swal.fire(
                'Falta Informaci√≥n',
                'Recuerda agregar el factor patol√≥gico en la secci√≥n de historial cl√≠nico.',
                'warning'
            );
            return; // Detener la ejecuci√≥n
        }

    } catch (error) {
        console.error('Error en validaciones previas:', error);
        Swal.fire(
            'Error de Conexi√≥n',
            `No se pudieron verificar los datos previos del paciente: ${error.message}. Aseg√∫rate de tener conexi√≥n a internet.`,
            'error'
        );
        return; // Detener la ejecuci√≥n si hay un error de red en las validaciones
    }

    const formData = {
        pacienteId: pacienteId,
        fecha: fecha, // El backend deber√≠a poder manejar YYYY-MM-DD
        pesoKg: parseFloat(document.getElementById('id_peso').value),
        tallaCm: parseFloat(document.getElementById('id_talla').value),
        circCinturaCm: parseFloat(document.getElementById('id_cintura').value),
        perimBraquialMm: parseFloat(document.getElementById('id_braquial').value), 
        pliegueTricipitalMm: parseFloat(document.getElementById('id_tricipital').value),
        pliegueBicipitalMm: parseFloat(document.getElementById('id_bicipital').value),
        pliegueSuprailiacoMm: parseFloat(document.getElementById('id_suprailiaco').value),
        pliegueSubescapularMm: parseFloat(document.getElementById('id_subescapular').value),
        porcentajeCarbohidratos: parseFloat(document.getElementById('id_porc_carbohidratos').value),
        porcentajeProteinas: parseFloat(document.getElementById('id_porc_proteinas').value),
        porcentajeLipidos: parseFloat(document.getElementById('id_porc_lipidos').value)
    };

    // Ajuste para perimBraquialMm si el input est√° en cm y el backend espera mm
    const perimBraquialInput = document.getElementById('id_braquial').value;
    if (perimBraquialInput && !isNaN(parseFloat(perimBraquialInput))) {
        formData.perimBraquialMm = parseFloat(perimBraquialInput) * 10;
    }

    if (isNaN(formData.pesoKg) || isNaN(formData.tallaCm) ||
        isNaN(formData.porcentajeCarbohidratos) || isNaN(formData.porcentajeProteinas) || isNaN(formData.porcentajeLipidos)) {
        Swal.fire('Campos Incompletos', 'Aseg√∫rate de llenar Peso, Talla y los porcentajes de macronutrientes.', 'warning');
        return;
    }

    // --- ENV√çO DE DATOS A LA API ---
    try {
        // Mostrar un loader mientras se procesa
        Swal.fire({
            title: 'Guardando datos...',
            text: 'Por favor, espera.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch('https://nutrilinkapi-production.up.railway.app/api_nutrilink/requerimientos/guardar_antropometria_y_requerimientos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Aseg√∫rate que este token se renderice correctamente
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json(); // Intentar parsear JSON siempre

        if (response.ok && data.status === 'success') { // HTTP 2xx y status 'success'
            Swal.fire({
                title: '¬°√âxito!',
                text: data.mensaje,
                icon: 'success',
                timer: 2500,
                showConfirmButton: false
            }).then(() => {
                window.location.href = `?fecha=${encodeURIComponent(fecha)}`;
            });
        } else {
            // Si la respuesta no fue OK (ej. 400, 404, 500) o si fue OK pero data.status es 'error'
            let errorMessage = data.mensaje || 'Error desconocido al guardar los datos.';
            if (data.detalle_db) {
                errorMessage += ` (Detalle: ${data.detalle_db})`;
            }
            // Si el status es 400, es probable que sea un error de validaci√≥n de los datos enviados
            if (response.status === 400) {
                 Swal.fire('Error de Validaci√≥n', errorMessage, 'error');
            } else if (response.status === 404) {
                 Swal.fire('No Encontrado', errorMessage, 'error');
            } else {
                 Swal.fire('Error del Servidor', errorMessage, 'error');
            }
        }
    } catch (error) { // Errores de red o al parsear JSON (si la respuesta no es JSON v√°lido)
        console.error('Error en fetch o procesamiento:', error);
        Swal.fire(
            'Error de Comunicaci√≥n',
            `Ocurri√≥ un problema al intentar guardar los datos: ${error.message}. Verifica tu conexi√≥n o int√©ntalo m√°s tarde.`,
            'error'
        );
    }
}

// Evento del btn guardar
document.querySelector('.btn-save').addEventListener('click', function(e) {
    e.preventDefault();
    
    if (!validarFormulario()) {
        return;
    }

    Swal.fire({
        title: '¬øConfirmar datos?',
        text: 'Se guardar√°n las mediciones y se calcular√°n los requerimientos.', // Mensaje de confirmaci√≥n actualizado
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, registrar y calcular', // Texto del bot√≥n de confirmaci√≥n actualizado
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            enviarDatosAntropometricosYRequerimientos(); // Llamar a la funci√≥n actualizada
        }
    });
});

// Funci√≥n para formatear fecha (sin cambios)
function formatearFecha(fechaStr) {
    const opciones = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(fechaStr).toLocaleDateString('es-ES', opciones);
}
</script>
{% endblock %}