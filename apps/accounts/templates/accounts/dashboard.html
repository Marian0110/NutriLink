{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-dash">
    <!-- Fila principal que contiene encabezado y citas -->
    <div class="row mb-4">
        <!-- Encabezado (70%) -->
        <div class="col-lg-7 mt-3" >
            <div class="encabezado-dash">
                <div class="card-body" style="padding: 15px;">
                    <div>
                        <h4 id="saludo-nutricionista" class="mb-1"><i class="fas fa-heartbeat me-2"></i>Bienvenido/a, <span id="nombre-nutricionista" class="me-3">Cargando...</span></h4>
                        <p class="mb-0">NutriLink - Tu sistema de gestión nutricional</p>
                    </div>
                </div>
            </div>
            <h4 class="mt-4">Resumen pacientes</h4>
            <!-- Datos principales -->
            <div class="row mt-4">
                <div class="col-md-6 mb-4">
                    <div class="graph-placeholder" id="total-pacientes" >
                        <!-- Card para total de pacientes -->
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="graph-placeholder" id="total-minutas" >
                        <!-- Card para total de minutas -->
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6 mb-4">
                    <div class="graph-placeholder" id="grafico-genero" >
                        <!-- Gráfico de género dinámico -->
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="graph-placeholder" id="grafico-edad">
                        <!-- Gráfico de edad dinámico-->
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="graph-placeholder" style="min-height: 400px;">
                        <div class="text-center">
                            <h5>Gráficos mas detallados</h5>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Columna derecha (30% - Citas) -->
        <div class="col-lg-5 mt-3">
            <div class="card-citas-del-dia">
                <div class="card-header-citas">
                    <h5 class="mb-0"><i class="far fa-calendar-alt me-2"></i>Tus citas de hoy</h5>
                </div>
                <div class="card-body mt-2">
                    <!-- Cita 1 -->
                    <div class="cita-card">
                        <div class="py-3">
                            <div class="row align-items-center p-2">
                                <div class="col-3 text-center">
                                    <img src="https://ui-avatars.com/api/?name=Maria+Garcia&background=4e73df&color=fff" alt="Paciente" class="patient-avatar rounded-circle">
                                </div>
                                <div class="col-5">
                                    <h6 class="mb-1">María García</h6>
                                    <p class="text-muted small mb-1"><i class="far fa-clock me-1"></i>09:00 - 10:00 AM</p>
                                    <p class="text-muted small mb-0"><i class="fas fa-notes-medical me-1"></i>Control de peso</p>
                                </div>
                                <div class="col-4">
                                    <a href="/paciente/1" class="btn btn-primary btn-sm btn-consult">
                                        <i class="fas fa-play me-1"></i> Iniciar
                                    </a>
                                    <button class="btn btn-success btn-sm btn-consult" disabled>
                                        <i class="fas fa-check me-1"></i> Terminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cita 2 -->
                    <div class="cita-card">
                        <div class="card-body py-3">
                            <div class="row align-items-center p-2">
                                <div class="col-3 text-center">
                                    <img src="https://ui-avatars.com/api/?name=Juan+Perez&background=1cc88a&color=fff" alt="Paciente" class="patient-avatar rounded-circle">
                                </div>
                                <div class="col-5">
                                    <h6 class="mb-1">Juan Pérez</h6>
                                    <p class="text-muted small mb-1"><i class="far fa-clock me-1"></i>11:30 - 12:30 PM</p>
                                    <p class="text-muted small mb-0"><i class="fas fa-notes-medical me-1"></i>Plan diabético</p>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-secondary btn-sm btn-consult" disabled>
                                        <i class="fas fa-play me-1"></i> Iniciar
                                    </button>
                                    <button class="btn btn-success btn-sm btn-consult">
                                        <i class="fas fa-check me-1"></i> Terminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Citas ocultas -->
                    <div class="cita-card hidden-citas">
                        <div class="card-body py-3">
                            <div class="row align-items-center p-2">
                                <div class="col-3 text-center">
                                    <img src="https://ui-avatars.com/api/?name=Ana+Lopez&background=f6c23e&color=000" alt="Paciente" class="patient-avatar rounded-circle">
                                </div>
                                <div class="col-5">
                                    <h6 class="mb-1">Ana López</h6>
                                    <p class="text-muted small mb-1"><i class="far fa-clock me-1"></i>04:00 - 05:00 PM</p>
                                    <p class="text-muted small mb-0"><i class="fas fa-notes-medical me-1"></i>Primera consulta</p>
                                </div>
                                <div class="col-4">
                                    <a href="/paciente/3" class="btn btn-primary btn-sm btn-consult">
                                        <i class="fas fa-play me-1"></i> Iniciar
                                    </a>
                                    <button class="btn btn-success btn-sm btn-consult" disabled>
                                        <i class="fas fa-check me-1"></i> Terminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button id="toggleCitas" class="btn btn-link expand-btn">
                            <i class="fas fa-chevron-down me-1"></i> Ver todas las citas de hoy (3)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

<script>
async function getPacientes() {
    try {
        const idNutricionista = sessionStorage.getItem('id_nutricionista');
        
        if (!idNutricionista) {
            console.error('No se encontró el ID del nutricionista en sessionStorage');
            return null;
        }

        const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/nutricionista/obtener_pacientes_nutricionista/${idNutricionista}`);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.status === 'error') {
            console.error('Error al obtener pacientes:', data.mensaje);
            return null;
        }

        return data.data;
        
    } catch (error) {
        console.error('Error al obtener pacientes del nutricionista:', error);
        return null;
    }
}

async function crearGraficos() {
    try {
        const pacientes = await getPacientes();
        
        if (!pacientes || pacientes.length === 0) {
            console.log('No hay datos de pacientes para mostrar');
            return;
        }

        // Card total pacientes
        const totalPacientes = pacientes.length;
        totalPacientesCard(totalPacientes);

        
        // Card total minutas 
        const totalMinutas = await obtenerTotalMinutas(63); // Ejemplo con pacidente 63
        crearCardTotalMinutas(totalMinutas);

        // 1. Gráfico de género
        const graficoGenero = graficoGeneroTorta(pacientes);
        
        if (graficoGenero.data[0].values.some(count => count > 0)) {
            Plotly.newPlot('grafico-genero', graficoGenero.data, graficoGenero.layout);
        } else {
            document.getElementById('grafico-genero').innerHTML = 
                '<div class="alert alert-info">No hay datos de género disponibles</div>';
        }

        // 2. Gráfico de edad
        const edades = pacientes.map(paciente => {
            if (paciente.fecha_nacimiento) {
                const birthDate = new Date(paciente.fecha_nacimiento);
                const ageDifMs = Date.now() - birthDate.getTime();
                const ageDate = new Date(ageDifMs);
                return Math.abs(ageDate.getUTCFullYear() - 1970);
            }
            return null;
        }).filter(age => age !== null);

        const graficoEdad = graficoEdadBarras(edades);

        if (edades.length > 0) {
            Plotly.newPlot('grafico-edad', graficoEdad.data, graficoEdad.layout);
        } else {
            document.getElementById('grafico-edad').innerHTML = 
                '<div class="alert alert-info">No hay datos de edad disponibles</div>';
        }

    } catch (error) {
        console.error('Error al crear gráficos:', error);
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // 1. Configurar evento del botón de citas
        const toggleButton = document.getElementById('toggleCitas');
        if (toggleButton) {
            toggleButton.addEventListener('click', function() {
                const hiddenCitas = document.querySelectorAll('.hidden-citas');
                const icon = this.querySelector('i');
                        
                hiddenCitas.forEach(cita => {
                    if (cita.style.display === 'none' || !cita.style.display) {
                        cita.style.display = 'block';
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                        this.innerHTML = '<i class="fas fa-chevron-up me-1"></i> Ocultar citas';
                    } else {
                        cita.style.display = 'none';
                        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                        this.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Ver todas las citas de hoy (3)';
                    }
                });
            });
        } else {
        }

        
        // 3. Debug de pacientes
        const pacientes = await getPacientes();
        if (pacientes) {
            console.log('✅ Pacientes obtenidos:', pacientes.length, 'pacientes');
        } else {
            console.log('❌ No se obtuvieron pacientes');
        }
        
        // 4. Crear gráficos
        await crearGraficos();

    } catch (error) {
        console.error('Error durante la inicialización:', error);
    }


        const idNutricionista = sessionStorage.getItem('id_nutricionista');
        
        if (!idNutricionista) {
            throw new Error('ID no disponible');
        }
        const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/nutricionista/obtener_nutricionista_id/${idNutricionista}`);
        
        if (!response.ok) {
            throw new Error('Error en la respuesta');
        }
        const data = await response.json();
        const nutricionista = data[0]; 
        const nombreMostrar = `${nutricionista.primer_nombre} ${nutricionista.apellido_paterno}`;

        document.getElementById('nombre-nutricionista').textContent = nombreMostrar;
});

// Funciones para gráficos
function graficoGeneroTorta(pacientes) {
    const generoData = {
        'Femenino': 0,
        'Masculino': 0
    };

    pacientes.forEach(paciente => {
        if (paciente.sexo === 'F') {
            generoData['Femenino']++;
        } else if (paciente.sexo === 'M') {
            generoData['Masculino']++;
        }
    });

    const filteredGeneroData = Object.fromEntries(
        Object.entries(generoData).filter(([_, count]) => count > 0)
    );

    const graficoGenero = {
        data: [{
            values: Object.values(filteredGeneroData),
            labels: Object.keys(filteredGeneroData),
            type: 'pie',
            marker: {
                colors: ['#e83e8c', '#36b9cc']
            },
            textinfo: 'percent+label+value',
            hoverinfo: 'label+percent+value',
            textposition: 'inside',
            insidetextorientation: 'radial',
            hovertemplate: '<b>Género:</b> %{label}<br>' +
                          '<b>Cantidad:</b> %{value} pacientes<br>' +
                          '<b>Porcentaje:</b> %{percent}<br>' +
                          '<extra></extra>'
        }],
        layout: {
            title: {
                text: 'Distribución por Género',
                font: {
                    size: 16,
                    family: 'Arial',
                    color: '#2c3e50'
                }
            },
            height: 200,
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.2
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            margin: {
                l: 20,
                r: 20,
                b: 20,
                t: 40,
                pad: 4
            }
        }
    };

    return graficoGenero;
}

function graficoEdadBarras(edades) {
    const gruposEdad = {
        '18-25': 0,
        '26-35': 0,
        '36-45': 0,
        '46-55': 0,
        '56-65': 0,
        '65+': 0
    };

    edades.forEach(edad => {
        if (edad >= 18 && edad <= 25) gruposEdad['18-25']++;
        else if (edad >= 26 && edad <= 35) gruposEdad['26-35']++;
        else if (edad >= 36 && edad <= 45) gruposEdad['36-45']++;
        else if (edad >= 46 && edad <= 55) gruposEdad['46-55']++;
        else if (edad >= 56 && edad <= 65) gruposEdad['56-65']++;
        else if (edad > 65) gruposEdad['65+']++;
    });

    const graficoEdad = {
        data: [{
            x: Object.keys(gruposEdad),
            y: Object.values(gruposEdad),
            type: 'bar',
            marker: {
                color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'],
                line: {
                    color: 'rgba(255,255,255,0.8)',
                    width: 2
                }
            },
            text: Object.values(gruposEdad).map(val => val > 0 ? val : ''),
            textposition: 'auto',
            hovertemplate: '<b>Grupo de edad:</b> %{x}<br>' +
                          '<b>Cantidad:</b> %{y} pacientes<br>' +
                          '<extra></extra>'
        }],
        layout: {
            title: {
                text: 'Distribución por grupos de edad',
                font: {
                    size: 16,
                    family: 'Arial',
                    color: '#2c3e50'
                }
            },
            xaxis: {
                title: 'Grupos de Edad',
                tickangle: -45,
                showgrid: false
            },
            yaxis: {
                title: 'Cantidad de Pacientes',
                showgrid: true,
                gridcolor: 'rgba(0,0,0,0.1)'
            },
            height: 200,
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            margin: {
                l: 50,
                r: 30,
                b: 80,
                t: 50,
                pad: 4
            }
        }
    };

    return graficoEdad;
}

function totalPacientesCard(totalPacientes) {
    const cardHTML = `
        <div style="text-align: start; padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <div style="font-size: 3rem; font-weight: bold; color: #333;" 
                     class="counter" data-target="${totalPacientes}">0</div>
                <div style="
                    background-color: #62f485; 
                    border-radius: 30%; 
                    width: 60px; 
                    height: 60px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                    margin-left: 200px;">
                    <i class="bi bi-people-fill" style="color: white; font-size: 1.5rem;"></i>
                </div>
            </div>
            <div style="font-size: 1.2rem; color: #666;">
                Total Pacientes
            </div>
        </div>
    `;
    
    document.getElementById('total-pacientes').innerHTML = cardHTML;
    
    animarContador();
}

function crearCardTotalMinutas(totalMinutas) {
    const cardHTML = `
        <div style="text-align: start; padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <div style="font-size: 3rem; font-weight: bold; color: #333;" 
                     class="counter-minutas" data-target="${totalMinutas}">0</div>
                <div style="
                    background-color: #4e73df; 
                    border-radius: 30%; 
                    width: 60px; 
                    height: 60px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    box-shadow: 0 2px 8px rgba(78, 115, 223, 0.3);
                    margin-left: 200px;">
                    <i class="bi bi-file-text-fill" style="color: white; font-size: 1.5rem;"></i>
                </div>
            </div>
            <div style="font-size: 1.2rem; color: #666;">
                Total Minutas
            </div>
        </div>
    `;
    
    document.getElementById('total-minutas').innerHTML = cardHTML;
    animarContador('.counter-minutas'); // Extender función animarContador
}

async function obtenerTotalMinutas(pacienteId) {
    try {
        const response = await fetch(`https://nutrilinkapi-production.up.railway.app/api_nutrilink/minuta/minutas_por_fecha/?pacienteId=${pacienteId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            return data.data.length;
        } else {
            console.error('Error al obtener minutas:', data.mensaje);
            return 0; 
        }
    } catch (error) {
        console.error('Error en obtenerTotalMinutas:', error);
        return 0;
    }
}

// animación del contador para multiples cards
function animarContador(selector = '.counter') {
    const counters = document.querySelectorAll(selector);
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        let current = 0;
        const duration = 500;
        const increment = target / (duration / 16);
        
        const timer = setInterval(() => {
            current += increment;
            counter.textContent = Math.floor(current);
            
            if (current >= target) {
                counter.textContent = target;
                clearInterval(timer);
            }
        }, 16);
    });
}
</script>
{% endblock %}
