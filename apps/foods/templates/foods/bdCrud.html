{% extends 'base.html' %}
{% load static %}
{% block title %}Alimentos{% endblock %}

{% block content %}
<div class="info-card">
    <div class="info">
        <div class="card-icon">游늵</div>
        <div class="text-content">
            <h1>Base de Datos Nutricional:</h1>
            <p>Consulta, busca o crea informaci칩n nutricional. Esta informaci칩n ser치 cargada para armar tus planes nutricionales personalizados.</p>
        </div>
    </div>
</div>

<div class="contenedor-alimentos">
    <div class="encabezado">
        <h1>Alimentos</h1>
        <button class="btn-agregar" type="button" data-bs-toggle="modal" data-bs-target="#agregarAlimentoModal">
            <i class="fas fa-plus me-2"></i>Agregar
        </button>
    </div>
    <div class="filtros">
        <form id="filtrosForm" class="d-flex flex-wrap justify-content-between w-100 gap-3">
            <div class="input-group" style="max-width: 500px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar alimento...">
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>

            <div class="ms-auto">
                <select id="grupoSelect" class="form-select">
                    <option value="">Todos los grupos</option>
                </select>
            </div>
        </form>
    </div>
    <!-- Contenedor donde se cargar치n los alimentos -->
    <div id="alimentosContainer">
        <div class="text-center mt-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Cargando alimentos...</p>
        </div>
    </div>
    <!-- Modal para agregar alimento -->
    <div class="modal fade" id="agregarAlimentoModal" tabindex="-1" aria-labelledby="agregarAlimentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header background">
                    <h5 class="modal-title" id="agregarAlimentoModalLabel">
                        <i class="fas fa-plus-circle me-2"></i>
                        Agregar Nuevo Alimento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevoAlimentoForm">
                        {% csrf_token %}
                        <fieldset class="info-basica-section mb-4">
                            <legend class="section-title">Informaci칩n B치sica</legend>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre del alimento: <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="nombre_alimento" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Grupo alimenticio: <span class="text-danger">*</span></label>
                                    <select class="form-select" name="id_grupo_alimenticio" required>
                                        <option value="">Seleccionar grupo</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Origen (ej: USDA, Envase):</label>
                                    <input type="text" class="form-control" name="origen" value="Personalizado">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Medida (ej: tazas): <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="medida" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">N춿 medidas por porci칩n: <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0" class="form-control" name="numero_medida" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Masa (total por porci칩n): <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="cantidad_porcion" required>
                                        <span class="input-group-text">gr/ml</span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="macronutrientes-section mb-4">
                            <legend class="section-title">Macronutrientes (total por porci칩n indicada)</legend>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Energ칤a (kcal): <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" step="0.1" min="0" class="form-control" name="kcal" required>
                                        <span class="input-group-text">kcal</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Prote칤nas (g): <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="proteinas_gr" required>
                                        <span class="input-group-text">g</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">L칤pidos (g): <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="lipidos_gr" required>
                                        <span class="input-group-text">g</span>
                                    </div>
                                </div>
                                <div class="col-md-3"><label class="form-label">Carbohidratos (g): <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="carbohidratos_gr" required>
                                        <span class="input-group-text">g</span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="micronutrientes-section mb-4">
                            <legend class="section-title">Micronutrientes (opcionales, total por porci칩n indicada)</legend>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Omega 3 (g):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="omega_gr">
                                        <span class="input-group-text">g</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Vitamina A (췃g RE):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="vitamina_a_mcg">
                                        <span class="input-group-text">췃g RE</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Vitamina B12 (췃g):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="vitamina_b12_mcg">
                                        <span class="input-group-text">췃g</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Calcio (mg):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="calcio_mg">
                                        <span class="input-group-text">mg</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Hierro (mg):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="hierro_mg">
                                        <span class="input-group-text">mg</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Selenio (췃g):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="selenio_mcg">
                                        <span class="input-group-text">췃g</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Zinc (mg):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="zinc_mg">
                                        <span class="input-group-text">mg</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Potasio (mg):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="potasio_mg">
                                        <span class="input-group-text">mg</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sodio (mg):</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control" name="sodio_mg">
                                        <span class="input-group-text">mg</span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar Alimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const API_GRUPOS_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id';
    const API_CREAR_ALIMENTO_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/guardar_alimento';
    const API_ACTUALIZAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/actualizar_alimento/';
    const API_ELIMINAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/eliminar_alimento/';
    
    let todosLosAlimentos = [];
    let alimentosFiltrados = [];
    let todosLosGrupos = [];
    let paginaActual = 1;
    const alimentosPorPagina = 5;
    
    // Variables de filtros
    let filtroTexto = '';
    let filtroGrupo = '';

    // Obtener ID del nutricionista
    const idNutricionista = sessionStorage.getItem('id_nutricionista');
    
    if (!idNutricionista) {
        document.getElementById('alimentosContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No se pudo identificar al nutricionista. Por favor, inicie sesi칩n nuevamente.
            </div>
        `;
        return;
    }

    const API_ALIMENTOS_URL = `https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/alimentos/nutricionista/${idNutricionista}`;

    // Cargar datos iniciales
    async function inicializar() {
        try {
            // Primero cargar grupos, luego alimentos (el orden importa para el mapeo)
            await cargarGrupos();
            await cargarAlimentos();
            aplicarFiltros();
            renderizarAlimentos();
        } catch (error) {
            console.error('Error al inicializar:', error);
            mostrarError('Error al cargar los datos iniciales.');
        }
    }

    // Cargar grupos alimenticios
    async function cargarGrupos() {
        try {
            const response = await fetch(API_GRUPOS_URL);
            if (!response.ok) throw new Error(`Error ${response.status}`);
            
            todosLosGrupos = await response.json();
            console.log('Grupos cargados:', todosLosGrupos.length, todosLosGrupos);
            
            // Poblar select de grupos en filtros
            const grupoSelect = document.getElementById('grupoSelect');
            grupoSelect.innerHTML = '<option value="">Todos los grupos</option>';
            
            // Poblar select de grupos en modal de nuevo alimento
            const nuevoGrupoSelect = document.querySelector('#agregarAlimentoModal select[name="id_grupo_alimenticio"]');
            nuevoGrupoSelect.innerHTML = '<option value="">Seleccionar grupo</option>';
            
            todosLosGrupos
                .sort((a, b) => a.descripcion.localeCompare(b.descripcion))
                .forEach(grupo => {
                    // Para filtros
                    const option1 = document.createElement('option');
                    option1.value = grupo.descripcion;
                    option1.textContent = grupo.descripcion;
                    grupoSelect.appendChild(option1);
                    
                    // Para modal nuevo alimento
                    const option2 = document.createElement('option');
                    option2.value = grupo.id_grupo_alimenticio;
                    option2.textContent = grupo.descripcion;
                    nuevoGrupoSelect.appendChild(option2);
                });

            console.log('Grupos populados en selects');

        } catch (error) {
            console.error('Error cargando grupos:', error);
        }
    }

    // Cargar alimentos
    async function cargarAlimentos() {
        try {
            const response = await fetch(API_ALIMENTOS_URL);
            if (!response.ok) throw new Error(`Error ${response.status}`);
            
            const data = await response.json();
            
            if (data.status === 'success' && data.data) {
                todosLosAlimentos = data.data;
                
                // Mapear id_grupo_alimenticio si es necesario y asegurar nombre_grupo_alimenticio
                todosLosAlimentos.forEach(alimento => {
                    if (!alimento.id_grupo_alimenticio && alimento.nombre_grupo_alimenticio) {
                        const grupo = todosLosGrupos.find(g => g.descripcion === alimento.nombre_grupo_alimenticio);
                        if (grupo) {
                            alimento.id_grupo_alimenticio = grupo.id_grupo_alimenticio;
                        }
                    }
                    
                    // Si tiene id_grupo_alimenticio pero no nombre_grupo_alimenticio, agregarlo
                    if (alimento.id_grupo_alimenticio && !alimento.nombre_grupo_alimenticio) {
                        const grupo = todosLosGrupos.find(g => g.id_grupo_alimenticio === alimento.id_grupo_alimenticio);
                        if (grupo) {
                            alimento.nombre_grupo_alimenticio = grupo.descripcion;
                        }
                    }
                });
                
                console.log(`Cargados ${todosLosAlimentos.length} alimentos`);
                console.log('Primer alimento:', todosLosAlimentos[0]); // Debug
            } else {
                throw new Error(data.mensaje || 'Error en la respuesta de la API');
            }
        } catch (error) {
            console.error('Error cargando alimentos:', error);
            throw error;
        }
    }

    // Aplicar filtros
    function aplicarFiltros() {
        console.log('Aplicando filtros:', { filtroTexto, filtroGrupo });
        console.log('Total alimentos antes de filtrar:', todosLosAlimentos.length);
        
        alimentosFiltrados = todosLosAlimentos.filter(alimento => {
            // Filtro por texto (nombre del alimento)
            const coincideTexto = !filtroTexto || 
                (alimento.nombre_alimento && alimento.nombre_alimento.toLowerCase().includes(filtroTexto.toLowerCase()));
            
            // Filtro por grupo
            const coincideGrupo = !filtroGrupo || 
                (alimento.nombre_grupo_alimenticio && alimento.nombre_grupo_alimenticio === filtroGrupo);
            
            console.log(`Alimento: ${alimento.nombre_alimento}, Grupo: ${alimento.nombre_grupo_alimenticio}, Coincide texto: ${coincideTexto}, Coincide grupo: ${coincideGrupo}`);
            
            return coincideTexto && coincideGrupo;
        });
        
        paginaActual = 1; // Resetear a primera p치gina al filtrar
        console.log(`Filtros aplicados: ${alimentosFiltrados.length} alimentos de ${todosLosAlimentos.length} totales`);
    }

    // Renderizar alimentos con paginaci칩n
    function renderizarAlimentos() {
        const container = document.getElementById('alimentosContainer');
        
        if (alimentosFiltrados.length === 0) {
            container.innerHTML = `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-search me-2"></i>
                    No se encontraron alimentos que coincidan con los filtros aplicados.
                </div>
            `;
            return;
        }

        // Calcular paginaci칩n
        const totalPaginas = Math.ceil(alimentosFiltrados.length / alimentosPorPagina);
        const inicio = (paginaActual - 1) * alimentosPorPagina;
        const fin = inicio + alimentosPorPagina;
        const alimentosPagina = alimentosFiltrados.slice(inicio, fin);

        // Generar HTML de alimentos
        let alimentosHtml = '';
        alimentosPagina.forEach(alimento => {
            alimentosHtml += generarHtmlAlimento(alimento);
        });

        // Generar HTML de paginaci칩n
        const paginacionHtml = generarHtmlPaginacion(totalPaginas);

        container.innerHTML = alimentosHtml + paginacionHtml;
        
        // Agregar event listeners
        agregarEventListenersPaginacion();
        agregarEventListenersModales();
    }

    // Generar HTML de un alimento
    function generarHtmlAlimento(alimento) {
        return `
            <div class="alimento-card">
                <div class="alimento-info">
                    <div class="alimento-nombre">${alimento.nombre_alimento}</div>
                    <div class="alimento-origen">${alimento.origen || ''}</div>
                </div>
                <div class="alimento-derecha">
                    <div class="alimento-valores">
                        <div class="valor">
                            <span>${alimento.lipidos_gr || '0'}g</span>
                            L칤pidos
                        </div>
                        <div class="valor">
                            <span>${alimento.kcal || '0'} kcal</span>
                            Calor칤as
                        </div>
                        <div class="valor">
                            <span>${alimento.proteinas_gr || '0'}g</span>
                            Prote칤nas
                        </div>
                        <div class="valor">
                            <span>${alimento.carbohidratos_gr || '0'}g</span>
                            CarboH
                        </div>
                    </div>
                    <div class="expansor">
                        <button class="btn" type="button" data-bs-toggle="modal" data-bs-target="#detalleModal${alimento.id_alimento}">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
            </div>
            ${generarModalDetalle(alimento)}
        `;
    }

    // Generar modal de detalle completo
    function generarModalDetalle(alimento) {
        const isUSDA = alimento.origen && alimento.origen.toLowerCase().includes('usda');
        const readonlyAttr = isUSDA ? 'readonly' : '';
        const disabledAttr = isUSDA ? 'disabled' : '';
        const buttonsStyle = isUSDA ? 'style="display: none;"' : '';
        
        // Crear opciones de grupos para el select
        let grupoOptions = '<option value="">Seleccione un grupo...</option>';
        todosLosGrupos.forEach(grupo => {
            const selected = alimento.id_grupo_alimenticio == grupo.id_grupo_alimenticio ? 'selected' : '';
            grupoOptions += `<option value="${grupo.id_grupo_alimenticio}" ${selected}>${grupo.descripcion}</option>`;
        });

        return `
            <div class="modal fade" id="detalleModal${alimento.id_alimento}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header background">
                            <h5 class="modal-title">
                                <i class="fas fa-utensils me-2"></i>
                                Detalle nutricional de ${alimento.nombre_alimento}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form class="editable-form" data-alimento-id="${alimento.id_alimento}">
                                <input type="hidden" name="id_alimento" value="${alimento.id_alimento}">
                                
                                <fieldset class="info-basica-section mb-4">
                                    <legend class="section-title">Informaci칩n del Alimento</legend>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre:</label>
                                            <input type="text" class="form-control" name="nombre_alimento" value="${alimento.nombre_alimento}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Origen:</label>
                                            <input type="text" class="form-control" name="origen" value="${alimento.origen || 'Personalizado'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Grupo:</label>
                                            <select class="form-select" name="id_grupo_alimenticio" ${disabledAttr}>
                                                ${grupoOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Medida:</label>
                                            <input type="text" class="form-control" name="medida" value="${alimento.medida || 'taza'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">N춿 medidas:</label>
                                            <input type="number" step="0.01" class="form-control" name="numero_medida" value="${alimento.numero_medida || '1'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Masa (gr/ml):</label>
                                            <input type="number" step="0.01" class="form-control" name="masa" value="${alimento.masa || '100'}" ${readonlyAttr}>
                                        </div>
                                    </div>
                                </fieldset>
                                
                                <fieldset class="macronutrientes-section mb-4">
                                    <legend class="section-title">Macronutrientes (porci칩n)</legend>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">L칤pidos (g):</label>
                                            <input type="number" step="0.01" class="form-control" name="lipidos_gr" value="${alimento.lipidos_gr || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Prote칤nas (g):</label>
                                            <input type="number" step="0.01" class="form-control" name="proteinas_gr" value="${alimento.proteinas_gr || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Carbohidratos (g):</label>
                                            <input type="number" step="0.01" class="form-control" name="carbohidratos_gr" value="${alimento.carbohidratos_gr || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Calor칤as (kcal):</label>
                                            <input type="number" step="0.01" class="form-control" name="kcal" value="${alimento.kcal || '0'}" ${readonlyAttr}>
                                        </div>
                                    </div>
                                </fieldset>
                                
                                <fieldset class="micronutrientes-section mb-4">
                                    <legend class="section-title">Micronutrientes (porci칩n)</legend>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Omega 3 (g):</label>
                                            <input type="number" step="0.01" class="form-control" name="n3_gr" value="${alimento.n3_gr || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Vitamina A (췃g):</label>
                                            <input type="number" step="0.01" class="form-control" name="vit_a_mcg" value="${alimento.vit_a_mcg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Vitamina B12 (췃g):</label>
                                            <input type="number" step="0.01" class="form-control" name="vit_b12_mcg" value="${alimento.vit_b12_mcg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Calcio (mg):</label>
                                            <input type="number" step="0.01" class="form-control" name="calcio_mg" value="${alimento.calcio_mg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Hierro (mg):</label>
                                            <input type="number" step="0.01" class="form-control" name="hierro_mg" value="${alimento.hierro_mg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Selenio (췃g):</label>
                                            <input type="number" step="0.01" class="form-control" name="selenio_mcg" value="${alimento.selenio_mcg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Zinc (mg):</label>
                                            <input type="number" step="0.01" class="form-control" name="zinc_mg" value="${alimento.zinc_mg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Potasio (mg):</label>
                                            <input type="number" step="0.01" class="form-control" name="potasio_mg" value="${alimento.potasio_mg || '0'}" ${readonlyAttr}>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Sodio (mg):</label>
                                            <input type="number" step="0.01" class="form-control" name="sodio_mg" value="${alimento.sodio_mg || '0'}" ${readonlyAttr}>
                                        </div>
                                    </div>
                                </fieldset>
                                
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <button type="button" class="btn btn-danger btn-eliminar-alimento" data-alimento-id="${alimento.id_alimento}" ${buttonsStyle}>
                                        <i class="fas fa-trash-alt me-2"></i>Eliminar
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-guardar" ${buttonsStyle}>
                                        <i class="fas fa-save me-2"></i>Guardar
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-2"></i>Cerrar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Generar HTML de paginaci칩n
    function generarHtmlPaginacion(totalPaginas) {
        if (totalPaginas <= 1) return '';

        let paginacionHtml = '<div class="pagination-container mt-4"><nav><ul class="pagination justify-content-center">';
        
        // Bot칩n anterior
        if (paginaActual > 1) {
            paginacionHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="1">춺춺</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${paginaActual - 1}">춺</a>
                </li>
            `;
        }

        // N칰meros de p치gina
        for (let i = Math.max(1, paginaActual - 2); i <= Math.min(totalPaginas, paginaActual + 2); i++) {
            const activeClass = i === paginaActual ? 'active' : '';
            paginacionHtml += `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }

        // Bot칩n siguiente
        if (paginaActual < totalPaginas) {
            paginacionHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${paginaActual + 1}">췉</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${totalPaginas}">췉췉</a>
                </li>
            `;
        }

        paginacionHtml += '</ul></nav></div>';
        return paginacionHtml;
    }

    // Event listeners para paginaci칩n
    function agregarEventListenersPaginacion() {
        document.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const nuevaPagina = parseInt(this.dataset.page);
                if (nuevaPagina && nuevaPagina !== paginaActual) {
                    paginaActual = nuevaPagina;
                    renderizarAlimentos();
                }
            });
        });
    }

    // Event listeners para modales
    function agregarEventListenersModales() {
        // Event listeners para formularios de edici칩n
        document.querySelectorAll('.editable-form').forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await actualizarAlimento(this);
            });
        });

        // Event listeners para botones de eliminar
        document.querySelectorAll('.btn-eliminar-alimento').forEach(button => {
            button.addEventListener('click', async function() {
                const alimentoId = this.dataset.alimentoId;
                await eliminarAlimento(alimentoId);
            });
        });
    }

    // Funci칩n para actualizar alimento
    async function actualizarAlimento(form) {
        const alimentoId = form.querySelector('input[name="id_alimento"]').value;
        const urlActualizar = API_ACTUALIZAR_ALIMENTO_URL_BASE + alimentoId;

        const submitButton = form.querySelector('.btn-guardar');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

        const formData = new FormData(form);

        const parseFloatOrNull = (value) => {
            if (value === null || String(value).trim() === '') return null;
            const num = parseFloat(value);
            return isNaN(num) ? null : num;
        };
        
        const parseIntOrNull = (value) => {
            if (value === null || String(value).trim() === '') return null;
            const num = parseInt(value, 10);
            return isNaN(num) ? null : num;
        };

        const data = {
            nombre_alimento: formData.get('nombre_alimento'),
            origen: formData.get('origen'),
            id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
            medida: formData.get('medida'),
            numero_medida: parseFloatOrNull(formData.get('numero_medida')),
            masa: parseFloatOrNull(formData.get('masa')),
            kcal: parseFloatOrNull(formData.get('kcal')),
            proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
            carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
            lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
            n3_gr: parseFloatOrNull(formData.get('n3_gr')),
            vit_a_mcg: parseFloatOrNull(formData.get('vit_a_mcg')),
            vit_b12_mcg: parseFloatOrNull(formData.get('vit_b12_mcg')),
            calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
            hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
            selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
            zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
            potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
            sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
            id_nutricionista: idNutricionista
        };

        try {
            const response = await fetch(urlActualizar, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.status === "success") {
                Swal.fire({
                    icon: 'success',
                    title: '춰Actualizado!',
                    text: 'Alimento actualizado correctamente.',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Cerrar modal
                const modalElement = form.closest('.modal');
                if (modalElement) {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                
                // Recargar datos
                await cargarAlimentos();
                aplicarFiltros();
                renderizarAlimentos();

            } else {
                let errorMessage = 'Error al actualizar el alimento.';
                if (result && result.mensaje) {
                    errorMessage = result.mensaje;
                } else if (result && result.errors) {
                    errorMessage += '<br>' + Object.values(result.errors).join('<br>');
                }
                Swal.fire('Error', errorMessage, 'error');
            }
        } catch (error) {
            console.error('Error al actualizar:', error);
            Swal.fire('Error de Conexi칩n', 'No se pudo conectar con el servidor.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }

    // Funci칩n para eliminar alimento
    async function eliminarAlimento(alimentoId) {
        const urlEliminar = API_ELIMINAR_ALIMENTO_URL_BASE + alimentoId;

        const result = await Swal.fire({
            title: '쮼st치s seguro?',
            text: "춰No podr치s revertir esto!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'S칤, eliminarlo!',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(urlEliminar, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                });

                const resultData = await response.json();

                if (response.ok && resultData.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: '춰Eliminado!',
                        text: 'Alimento eliminado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Cerrar modal si est치 abierto
                    const modalElement = document.querySelector(`#detalleModal${alimentoId}`);
                    if (modalElement) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    
                    // Recargar datos
                    await cargarAlimentos();
                    aplicarFiltros();
                    renderizarAlimentos();

                } else {
                    Swal.fire('Error', resultData.mensaje || 'No se pudo eliminar el alimento.', 'error');
                }
            } catch (error) {
                console.error('Error al eliminar:', error);
                Swal.fire('Error de Conexi칩n', 'No se pudo conectar con el servidor.', 'error');
            }
        }
    }

    // Event listeners para filtros
    document.getElementById('filtrosForm').addEventListener('submit', function(e) {
        e.preventDefault();
        filtroTexto = document.getElementById('searchInput').value.trim();
        console.log('Filtro de b칰squeda aplicado:', filtroTexto);
        aplicarFiltros();
        renderizarAlimentos();
    });

    // Filtrar en tiempo real al escribir
    document.getElementById('searchInput').addEventListener('input', function() {
        filtroTexto = this.value.trim();
        console.log('Filtro de b칰squeda en tiempo real:', filtroTexto);
        aplicarFiltros();
        renderizarAlimentos();
    });

    document.getElementById('grupoSelect').addEventListener('change', function() {
        filtroGrupo = this.value;
        console.log('Filtro de grupo aplicado:', filtroGrupo);
        aplicarFiltros();
        renderizarAlimentos();
    });

    // Event listener para formulario de nuevo alimento
    document.getElementById('nuevoAlimentoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await crearNuevoAlimento(this);
    });

    // Funci칩n para crear nuevo alimento
    async function crearNuevoAlimento(form) {
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

        const formData = new FormData(form);

        const parseFloatOrNull = (value) => {
            if (value === null || String(value).trim() === '') return null;
            const num = parseFloat(value);
            return isNaN(num) ? null : num;
        };
        
        const parseIntOrNull = (value) => {
            if (value === null || String(value).trim() === '') return null;
            const num = parseInt(value, 10);
            return isNaN(num) ? null : num;
        };

        const data = {
            nombre_alimento: formData.get('nombre_alimento'),
            origen: formData.get('origen') || 'Personalizado',
            id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
            medida: formData.get('medida'),
            numero_medida: parseFloatOrNull(formData.get('numero_medida')),
            masa: parseFloatOrNull(formData.get('cantidad_porcion')),
            kcal: parseFloatOrNull(formData.get('kcal')),
            proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
            carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
            lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
            n3_gr: parseFloatOrNull(formData.get('omega_gr')),
            vit_a_mcg: parseFloatOrNull(formData.get('vitamina_a_mcg')),
            vit_b12_mcg: parseFloatOrNull(formData.get('vitamina_b12_mcg')),
            calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
            hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
            selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
            zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
            potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
            sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
            id_nutricionista: idNutricionista
        };

        try {
            const response = await fetch(API_CREAR_ALIMENTO_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.status === "success") {
                Swal.fire({
                    icon: 'success',
                    title: '춰Creado!',
                    text: result.mensaje || 'Alimento agregado correctamente.',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Cerrar modal
                const modalElement = form.closest('.modal');
                if (modalElement) {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                
                // Limpiar formulario
                form.reset();
                
                // Recargar datos
                await cargarAlimentos();
                aplicarFiltros();
                renderizarAlimentos();

            } else {
                let errorMessage = 'Error al agregar el alimento.';
                if (result && result.mensaje) {
                    errorMessage = result.mensaje;
                } else if (result && result.errors) {
                    errorMessage += '<br>' + Object.values(result.errors).join('<br>');
                }
                Swal.fire('Error', errorMessage, 'error');
            }
        } catch (error) {
            console.error('Error al crear alimento:', error);
            Swal.fire('Error de Conexi칩n', 'No se pudo conectar con el servidor.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }

    // Funci칩n para mostrar errores
    function mostrarError(mensaje) {
        document.getElementById('alimentosContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensaje}
            </div>
        `;
    }

    // Funci칩n para prevenir valores negativos en inputs num칠ricos
    function configurarValidacionInputsNumericos() {
        // Select a todos los inputs de macronutrientes y micronutrientes
        const inputsNumericos = document.querySelectorAll('input[type="number"][min="0"]');
        
        inputsNumericos.forEach(input => {
            // Prevenir que se escriban valores negativos
            input.addEventListener('input', function() {
                if (this.value < 0) {
                    this.value = 0;
                }
            });
            
            // Validar al perder el foco
            input.addEventListener('blur', function() {
                if (this.value < 0 || this.value === '') {
                    this.value = 0;
                }
            });
            
            // Prevenir el ingreso de caracteres que podr칤an resultar en n칰meros negativos
            input.addEventListener('keydown', function(e) {
                // Prevenir el signo menos (c칩digo 189 o 109)
                if (e.keyCode === 189 || e.keyCode === 109) {
                    e.preventDefault();
                }
            });
        });
    }

  // Llamar la funci칩n cuando se carga la p치gina
  configurarValidacionInputsNumericos();

  // Configurar validaciones cuando se abran los modales de edici칩n
  document.addEventListener('shown.bs.modal', function(e) {
      if (e.target.classList.contains('modal')) {
          configurarValidacionInputsNumericos();
      }
    });
    // Inicializar la aplicaci칩n
    inicializar();
});
</script>
{% endblock %}