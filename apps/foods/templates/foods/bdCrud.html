{% extends 'base.html' %}
{% load static %}
{% block title %}Alimentos{% endblock %}

{% block content %}
<div class="info-card">
    <div class="info">
        <div class="card-icon">游늵</div>
        <div class="text-content">
            <h1>Base de Datos Nutricional:</h1>
            <p>Consulta, busca o crea informaci칩n nutricional. Esta informaci칩n ser치 cargada para armar tus planes nutricionales personalizados.</p>
        </div>
    </div>
</div>

<div class="contenedor-alimentos">
  <div class="encabezado">
    <h1>Alimentos</h1>
    <button class="btn-agregar" type="button" data-bs-toggle="modal" data-bs-target="#agregarAlimentoModal">
        <i class="fas fa-plus me-2"></i>Agregar
    </button>
  </div>
  <div class="filtros">
    <form method="get" class="d-flex flex-wrap justify-content-between w-100 gap-3">
        <div class="input-group" style="max-width: 500px;">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" name="q" class="form-control" placeholder="Buscar alimento..." value="{{ request_get_q }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </div>

        <div class="ms-auto">
            <select name="grupo" class="form-select" onchange="this.form.submit()">
                <option value="">Todos los grupos</option>
                {% for grupo_nombre in grupos_filtro %} {# Usar grupos_filtro aqu칤 #}
                    <option value="{{ grupo_nombre }}" {% if request_get_grupo == grupo_nombre %}selected{% endif %}>
                        {{ grupo_nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
  </div>

  {% if page_obj %}
    {% for alimento in page_obj %}
    <div class="alimento-card">
      <div class="alimento-info">
        <div class="alimento-nombre">{{ alimento.nombre_alimento }}</div>
        <div class="alimento-origen">{{ alimento.origen|default:"" }}</div>
      </div>
      <div class="alimento-derecha">
        <div class="alimento-valores">
          <div class="valor">
              <span>{{ alimento.lipidos_gr|default_if_none:"0" }}g</span>
              L칤pidos
          </div>
          <div class="valor">
              <span>{{ alimento.kcal|default_if_none:"0" }} kcal</span>
              Calor칤as
          </div>
          <div class="valor">
              <span>{{ alimento.proteinas_gr|default_if_none:"0" }}g</span>
              Prote칤nas
          </div>
          <div class="valor">
              <span>{{ alimento.carbohidratos_gr|default_if_none:"0" }}g</span>
              CarboH
          </div>
        </div>
        <div class="expansor">
          <button class="btn" type="button" data-bs-toggle="modal" data-bs-target="#detalleModal{{ alimento.id_alimento }}"> {# Usar alimento.id_alimento para un ID 칰nico #}
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- Modal de detalles del alimento -->
    <div class="modal fade" id="detalleModal{{ alimento.id_alimento }}" tabindex="-1" aria-labelledby="detalleModalLabel{{ alimento.id_alimento }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header background">
            <h5 class="modal-title" id="detalleModalLabel{{ alimento.id_alimento }}">
              <i class="fas fa-utensils me-2"></i>
              Detalle nutricional de {{ alimento.nombre_alimento }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="alimentoForm{{ alimento.id_alimento }}" class="editable-form">
               <input type="hidden" id="alimentoId{{ alimento.id_alimento }}" name="id_alimento" value="{{ alimento.id_alimento }}" >
              {% csrf_token %}
              
              <fieldset class="info-basica-section mb-4">
                <legend class="section-title">Informaci칩n del Alimento</legend>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nombre:</label>
                    <input type="text" class="form-control colorBg " name="nombre_alimento" value="{{ alimento.nombre_alimento }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Origen (ej: USDA, Envase):</label>
                    <input type="text" class="form-control" name="origen" value="{{ alimento.origen|default:'USDA' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Grupo:</label>
                          
                    <select class="form-select select-grupo-alimento-modal" name="id_grupo_alimenticio">
                        <option value="">Seleccione un grupo...</option>

                        {% for grupo_obj in grupos_modal %}
                            <option value="{{ grupo_obj.id_grupo_alimenticio }}"
                                    {% comment %}
                                    Ahora alimento.id_grupo_alimenticio existe y es un n칰mero (o None).
                                    grupo_obj.id_grupo_alimenticio tambi칠n es un n칰mero.
                                    La comparaci칩n directa es m치s limpia si los tipos son consistentes.
                                    Si hay duda, stringformat es m치s seguro.
                                    {% endcomment %}
                                    {% if alimento.id_grupo_alimenticio is not None and grupo_obj.id_grupo_alimenticio == alimento.id_grupo_alimenticio %}
                                        selected
                                    {% endif %}>
                                {{ grupo_obj.descripcion }}
                            </option>
                        {% endfor %}

                        {% comment %}
                        Este bloque ahora solo se activar치 si alimento.id_grupo_alimenticio es None
                        Y alimento.nombre_grupo_alimenticio existe. Esto significa que el alimento
                        tiene un nombre de grupo que NO PUDO SER MAPEADO a un ID (un grupo "hu칠rfano" o incorrecto).
                        {% endcomment %}
                        {% if alimento.id_grupo_alimenticio is None and alimento.nombre_grupo_alimenticio %}
                            <option value="" disabled selected style="font-style: italic;">
                                Grupo actual: {{ alimento.nombre_grupo_alimenticio }} (ID no encontrado o grupo no v치lido)
                            </option>
                        {% endif %}
                    </select>
    
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Medida (ej: tazas):</label>
                    <input type="text" class="form-control" name="medida" value="{{ alimento.medida|default:'taza' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">N춿 medidas por porci칩n:</label>
                    <input type="number" step="0.01" class="form-control" name="numero_medida" value="{{ alimento.numero_medida|default:'1' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Masa (porci칩n):</label>
                    <div class="input-group">
                      <input type="number" step="0.01" class="form-control" name="masa" value="{{ alimento.masa|default:'100' }}">
                      <span class="input-group-text">gr/ml</span>
                    </div>
                  </div>
                </div>
              </fieldset>
              
              <fieldset class="macronutrientes-section mb-4">
                <legend class="section-title">Macronutrientes (porci칩n)</legend> 
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">L칤pidos (g):</label>
                    <input type="number" step="0.01" class="form-control" name="lipidos_gr" value="{{ alimento.lipidos_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Prote칤nas (g):</label>
                    <input type="number" step="0.01" class="form-control" name="proteinas_gr" value="{{ alimento.proteinas_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Carbohidratos (g):</label>
                    <input type="number" step="0.01" class="form-control" name="carbohidratos_gr" value="{{ alimento.carbohidratos_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Calor칤as (kcal):</label>
                    <input type="number" step="0.01" class="form-control" name="kcal" value="{{ alimento.kcal|default_if_none:'0' }}">
                  </div>
                </div>
              </fieldset>
              
              <fieldset class="micronutrientes-section mb-4">
                <legend class="section-title">Micronutrientes (porci칩n)</legend>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Omega 3 (g):</label>
                    <input type="number" step="0.01" class="form-control" name="n3_gr" value="{{ alimento.n3_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Vitamina A (췃g):</label>
                    <input type="number" step="0.01" class="form-control" name="vit_a_mcg" value="{{ alimento.vit_a_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Vitamina B12 (췃g):</label>
                    <input type="number" step="0.01" class="form-control" name="vit_b12_mcg" value="{{ alimento.vit_b12_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Calcio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="calcio_mg" value="{{ alimento.calcio_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Hierro (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="hierro_mg" value="{{ alimento.hierro_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Selenio (췃g):</label>
                    <input type="number" step="0.01" class="form-control" name="selenio_mcg" value="{{ alimento.selenio_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Zinc (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="zinc_mg" value="{{ alimento.zinc_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Potasio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="potasio_mg" value="{{ alimento.potasio_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Sodio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="sodio_mg" value="{{ alimento.sodio_mg|default_if_none:'0' }}">
                  </div>
                </div>
              </fieldset>
                    
              <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-danger btn-eliminar-alimento" data-alimento-id="{{ alimento.id_alimento }}">
                  <i class="fas fa-trash-alt me-2"></i>Eliminar
                </button>
                <button type="submit" class="btn btn-primary btn-guardar">
                  <i class="fas fa-save me-2"></i>Guardar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="fas fa-times me-2"></i>Cerrar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Paginaci칩n -->
    <div class="pagination-container mt-4">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="First">
                        <span aria-hidden="true">춺춺</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Previous">
                        <span aria-hidden="true">춺</span>
                    </a>
                </li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}">{{ num }}</a></li>
                {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Next">
                        <span aria-hidden="true">췉</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Last">
                        <span aria-hidden="true">췉췉</span>
                    </a>
                </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% else %}
    <div class="alert alert-warning mt-3">No se pudieron cargar los alimentos o no se encontraron resultados. Por favor, intente m치s tarde o ajuste su b칰squeda.</div>
  {% endif %}

  <!-- Modal para agregar nuevo alimento -->
  <div class="modal fade" id="agregarAlimentoModal" tabindex="-1" aria-labelledby="agregarAlimentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header background">
          <h5 class="modal-title" id="agregarAlimentoModalLabel">
            <i class="fas fa-plus-circle me-2"></i>
            Agregar Nuevo Alimento
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="nuevoAlimentoForm">
            {% csrf_token %}
            
            <fieldset class="info-basica-section mb-4">
              <legend class="section-title">Informaci칩n B치sica</legend>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">
                    Nombre del alimento: <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" name="nombre_alimento" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">
                    Grupo alimenticio: <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" name="id_grupo_alimenticio" required>
                    <option value="">Seleccionar grupo</option>
                    {% for grupo_obj in grupos_modal %} 
                      <option value="{{ grupo_obj.id_grupo_alimenticio }}">{{ grupo_obj.descripcion }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Origen (ej: USDA, Envase):</label>
                  <input type="text" class="form-control" name="origen" value="Personalizado">
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Medida (ej: tazas): <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" name="medida" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    N춿 medidas por porci칩n: <span class="text-danger">*</span>
                  </label>
                  <input type="number" step="0.01" min="0" class="form-control" name="numero_medida" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">
                    Masa (total por porci칩n): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="cantidad_porcion" required>
                    <span class="input-group-text">gr/ml</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <fieldset class="macronutrientes-section mb-4">
              <legend class="section-title">Macronutrientes (total por porci칩n indicada)</legend>
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">
                    Energ칤a (kcal): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.1" min="0" class="form-control" name="kcal" required>
                    <span class="input-group-text">kcal</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    Prote칤nas (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="proteinas_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    L칤pidos (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="lipidos_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    Carbohidratos (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="carbohidratos_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <fieldset class="micronutrientes-section mb-4">
              <legend class="section-title">Micronutrientes (opcionales, total por porci칩n indicada)</legend>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Omega 3 (g):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="omega_gr">
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Vitamina A (췃g RE):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="vitamina_a_mcg">
                    <span class="input-group-text">췃g RE</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Vitamina B12 (췃g):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="vitamina_b12_mcg">
                    <span class="input-group-text">췃g</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Calcio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="calcio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hierro (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="hierro_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Selenio (췃g):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="selenio_mcg">
                    <span class="input-group-text">췃g</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Zinc (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="zinc_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Potasio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="potasio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Sodio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="sodio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Guardar Alimento
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div> <!-- Cierre de .contenedor-alimentos -->

<script>
document.addEventListener('DOMContentLoaded', function () {
    const API_GRUPOS_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id';
    // URL para CREAR nuevos alimentos (POST)
    const API_CREAR_ALIMENTO_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/guardar_alimento';
    // URL BASE para ACTUALIZAR alimentos existentes (PUT)
    const API_ACTUALIZAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/actualizar_alimento/';
    // URL BASE para ELIMINAR alimentos existentes (DELETE)
    const API_ELIMINAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/eliminar_alimento/';
    
    let todosLosGruposAlimenticiosAPI = [];

    async function cargarGruposDesdeAPI() {
        try {
            const response = await fetch(API_GRUPOS_URL);
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status} al cargar grupos.`);
            }
            todosLosGruposAlimenticiosAPI = await response.json();

            if (!todosLosGruposAlimenticiosAPI || todosLosGruposAlimenticiosAPI.length === 0) {
                console.warn('No se recibieron grupos alimenticios de la API o la lista est치 vac칤a.');
                return;
            }
            
            // Poblar select en el modal de "Nuevo Alimento" (ya se hace con Django, pero esto es un ejemplo si fuera din치mico)
            // const nuevoGrupoSelect = document.querySelector('#agregarAlimentoModal select[name="id_grupo_alimenticio"]');
            // if (nuevoGrupoSelect && nuevoGrupoSelect.options.length <=1) { // Solo si no est치 ya poblado por Django
            //     // L칩gica para poblarlo...
            // }

        } catch (error) {
            console.error('Error al cargar grupos alimenticios desde API:', error);
        }
    }


    // --- MANEJAR EL GUARDADO (ACTUALIZACI칍N) DE ALIMENTOS EDITADOS ---
    document.querySelectorAll('.editable-form').forEach(form => {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const alimentoIdInput = form.querySelector('input[name="id_alimento"]');
            if (!alimentoIdInput || !alimentoIdInput.value) {
                console.error("No se encontr칩 el ID del alimento en el formulario.");
                Swal.fire('Error Interno', 'No se pudo identificar el alimento a guardar.', 'error');
                return;
            }
            const alimentoId = alimentoIdInput.value;

            // Construir la URL completa para la actualizaci칩n
            const urlActualizar = API_ACTUALIZAR_ALIMENTO_URL_BASE + alimentoId;

            const submitButton = form.querySelector('.btn-guardar');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

            const formData = new FormData(form);
            const csrfToken = formData.get('csrfmiddlewaretoken');

            const parseFloatOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseFloat(value);
                return isNaN(num) ? null : num;
            };
            
            const parseIntOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseInt(value, 10);
                return isNaN(num) ? null : num;
            };

            const data = {
                // id_alimento no es estrictamente necesario en el cuerpo para PUT si ya est치 en la URL,
                // pero algunas APIs lo aceptan o incluso lo usan para validaci칩n.
                // Lo incluimos por si tu API lo espera, pero puedes probar quit치ndolo si no es necesario.
                // id_alimento: parseInt(alimentoId),
                nombre_alimento: formData.get('nombre_alimento'),
                origen: formData.get('origen'),
                id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
                medida: formData.get('medida'),
                numero_medida: parseFloatOrNull(formData.get('numero_medida')),
                masa: parseFloatOrNull(formData.get('masa')),
                kcal: parseFloatOrNull(formData.get('kcal')),
                proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
                carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
                lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
                n3_gr: parseFloatOrNull(formData.get('n3_gr')),
                vit_a_mcg: parseFloatOrNull(formData.get('vit_a_mcg')),
                vit_b12_mcg: parseFloatOrNull(formData.get('vit_b12_mcg')),
                calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
                hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
                selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
                zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
                potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
                sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
            };

            console.log("Enviando datos para actualizar a:", urlActualizar, " Payload:", data);

            try {
                const response = await fetch(urlActualizar, { // Usar la nueva URL
                    method: 'PUT', // M칠todo PUT para actualizar el recurso completo
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: '춰Actualizado!',
                        text: result.mensaje || 'Alimento actualizado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    const modalElement = form.closest('.modal');
                    if (modalElement) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    
                    setTimeout(() => {
                        location.reload(); 
                    }, 1500);

                } else {
                    let errorMessage = 'Error al actualizar el alimento.';
                    if (result && result.mensaje) {
                        errorMessage = result.mensaje;
                    } else if (result && result.errors) { 
                        errorMessage = Object.entries(result.errors).map(([key, val]) => `${key}: ${val.join ? val.join(', ') : val}`).join('<br>');
                    } else if (result && result.detail) { // A veces DRF usa 'detail' para errores
                        errorMessage = result.detail;
                    } else if (response.statusText) {
                        errorMessage = `Error ${response.status}: ${response.statusText}`;
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al Guardar',
                        html: errorMessage
                    });
                }
            } catch (error) {
                console.error('Error en la petici칩n fetch:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexi칩n',
                    text: 'No se pudo conectar con el servidor. Int칠ntalo m치s tarde.'
                });
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
    });

    // --- MANEJAR LA CREACI칍N DE NUEVOS ALIMENTOS ---
    const nuevoAlimentoForm = document.getElementById('nuevoAlimentoForm');
    if (nuevoAlimentoForm) {
        nuevoAlimentoForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!this.checkValidity()) {
                event.stopPropagation();
                // Bootstrap se encargar치 de mostrar los mensajes de validaci칩n nativos
                // Puedes a침adir una alerta de Swal si quieres.
                Swal.fire('Campos incompletos', 'Por favor, rellena todos los campos obligatorios.', 'warning');
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

            const formData = new FormData(this);
            const csrfToken = formData.get('csrfmiddlewaretoken');

            const parseFloatOrNull = (value) => (value === null || String(value).trim() === '') ? null : (isNaN(parseFloat(value)) ? null : parseFloat(value));
            const parseIntOrNull = (value) => (value === null || String(value).trim() === '') ? null : (isNaN(parseInt(value, 10)) ? null : parseInt(value, 10));

            const data = {
                nombre_alimento: formData.get('nombre_alimento'),
                id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
                origen: formData.get('origen'),
                medida: formData.get('medida'),
                numero_medida: parseFloatOrNull(formData.get('numero_medida')),
                masa: parseFloatOrNull(formData.get('cantidad_porcion')), // 'cantidad_porcion' es el name en el form
                kcal: parseFloatOrNull(formData.get('kcal')),
                proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
                carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
                lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
                n3_gr: parseFloatOrNull(formData.get('omega_gr')), // 'omega_gr' es el name en el form
                vit_a_mcg: parseFloatOrNull(formData.get('vitamina_a_mcg')),
                vit_b12_mcg: parseFloatOrNull(formData.get('vitamina_b12_mcg')),
                calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
                hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
                selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
                zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
                potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
                sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
            };

            console.log("Enviando datos para crear nuevo alimento:", data, "a:", API_CREAR_ALIMENTO_URL);

            try {
                const response = await fetch(API_CREAR_ALIMENTO_URL, { // Usar API_CREAR_ALIMENTO_URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok && result.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: '춰Alimento Agregado!',
                        text: result.mensaje || 'El nuevo alimento ha sido guardado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    const modalElement = this.closest('.modal');
                    if (modalElement) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) modalInstance.hide();
                        modalElement.querySelector('form').reset(); // Limpiar formulario
                    }
                    setTimeout(() => location.reload(), 1500);
                } else {
                    let errorMessage = 'Error al agregar el alimento.';
                    if (result && result.mensaje) errorMessage = result.mensaje;
                    else if (result && result.errors) errorMessage = Object.entries(result.errors).map(([k, v]) => `${k}: ${v.join ? v.join(', ') : v}`).join('<br>');
                    else if (result && result.detail) errorMessage = result.detail;
                    else if (response.statusText) errorMessage = `Error ${response.status}: ${response.statusText}`;
                    Swal.fire({ icon: 'error', title: 'Error al Guardar', html: errorMessage });
                }
            } catch (error) {
                console.error('Error en la petici칩n fetch para crear:', error);
                Swal.fire({ icon: 'error', title: 'Error de Conexi칩n', text: 'No se pudo conectar con el servidor.' });
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
    }


    // --- MANEJAR LA ELIMINACI칍N DE ALIMENTOS ---
    document.querySelectorAll('.btn-eliminar-alimento').forEach(button => {
        button.addEventListener('click', async function() {
            const alimentoId = this.dataset.alimentoId;
            if (!alimentoId) {
                Swal.fire('Error Interno', 'No se pudo identificar el alimento a eliminar.', 'error');
                return;
            }

            const modal = this.closest('.modal');
            const form = modal ? modal.querySelector('form') : null;
            const csrfTokenInput = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : document.querySelector('#nuevoAlimentoForm input[name="csrfmiddlewaretoken"]'); // Fallback al token del form de nuevo alimento si no est치 en el de edici칩n
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : (document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '');


            Swal.fire({
                title: '쮼st치s seguro?',
                html: `Vas a eliminar el alimento (ID: <strong>${alimentoId}</strong>).<br>춰Esta acci칩n no se puede revertir!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S칤, 춰eliminar!',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const eliminarUrl = API_ELIMINAR_ALIMENTO_URL_BASE + alimentoId;
                    
                    const swalLoading = Swal.fire({
                        title: 'Eliminando...',
                        text: 'Por favor espera.',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    try {
                        const response = await fetch(eliminarUrl, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json', 
                                'X-CSRFToken': csrfToken 
                            }
                        });

                        swalLoading.close(); 

                        const apiResult = await response.json();

                        if (response.ok && apiResult.status === "success") {
                            Swal.fire({
                                icon: 'success',
                                title: '춰Eliminado!',
                                text: apiResult.mensaje || 'Alimento eliminado correctamente.',
                                timer: 2500,
                                showConfirmButton: false
                            });
                            
                            const modalElement = this.closest('.modal');
                            if (modalElement) {
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) modalInstance.hide();
                            }
                            
                            setTimeout(() => { location.reload(); }, 2000);

                        } else {
                            let errorMessage = 'Error al eliminar el alimento.';
                            if (apiResult && apiResult.mensaje) errorMessage = apiResult.mensaje;
                            else if (apiResult && apiResult.detail) errorMessage = apiResult.detail;
                            else if (response.statusText) errorMessage = `Error ${response.status}: ${response.statusText}`;
                            Swal.fire({ icon: 'error', title: 'Error al Eliminar', html: errorMessage });
                        }
                    } catch (error) {
                        swalLoading.close(); 
                        console.error('Error en la petici칩n fetch de eliminaci칩n:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de Conexi칩n',
                            text: 'No se pudo conectar con el servidor para eliminar. Int칠ntalo m치s tarde.'
                        });
                    }
                }
            });
        });
    });

    // --- INICIALIZACI칍N ---
    // cargarGruposDesdeAPI(); // Descomentar si se necesita para poblar selects din치micamente que no vengan de Django
});
</script>
{% endblock %}