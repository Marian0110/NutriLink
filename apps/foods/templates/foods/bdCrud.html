{% extends 'base.html' %}
{% load static %}
{% block title %}Alimentos{% endblock %}

{% block content %}
<div class="info-card">
    <div class="info">
        <div class="card-icon">📊</div>
        <div class="text-content">
            <h1>Base de Datos Nutricional:</h1>
            <p>Consulta, busca o crea información nutricional. Esta información será cargada para armar tus planes nutricionales personalizados.</p>
        </div>
    </div>
</div>

<div class="contenedor-alimentos">
  <div class="encabezado">
    <h1>Alimentos</h1>
    <button class="btn-agregar" type="button" data-bs-toggle="modal" data-bs-target="#agregarAlimentoModal">
        <i class="fas fa-plus me-2"></i>Agregar
    </button>
  </div>
  <div class="filtros">
    <form method="get" class="d-flex flex-wrap justify-content-between w-100 gap-3">
        <div class="input-group" style="max-width: 500px;">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" name="q" class="form-control" placeholder="Buscar alimento..." value="{{ request_get_q }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </div>

        <div class="ms-auto">
            <select name="grupo" class="form-select" onchange="this.form.submit()">
                <option value="">Todos los grupos</option>
                {% for grupo_nombre in grupos_filtro %} {# Usar grupos_filtro aquí #}
                    <option value="{{ grupo_nombre }}" {% if request_get_grupo == grupo_nombre %}selected{% endif %}>
                        {{ grupo_nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
  </div>

  {% if page_obj %}
    {% for alimento in page_obj %}
    <div class="alimento-card">
      <div class="alimento-info">
        <div class="alimento-nombre">{{ alimento.nombre_alimento }}</div>
        <div class="alimento-origen">{{ alimento.origen|default:"" }}</div>
      </div>
      <div class="alimento-derecha">
        <div class="alimento-valores">
          <div class="valor">
              <span>{{ alimento.lipidos_gr|default_if_none:"0" }}g</span>
              Lípidos
          </div>
          <div class="valor">
              <span>{{ alimento.kcal|default_if_none:"0" }} kcal</span>
              Calorías
          </div>
          <div class="valor">
              <span>{{ alimento.proteinas_gr|default_if_none:"0" }}g</span>
              Proteínas
          </div>
          <div class="valor">
              <span>{{ alimento.carbohidratos_gr|default_if_none:"0" }}g</span>
              CarboH
          </div>
        </div>
        <div class="expansor">
          <button class="btn" type="button" data-bs-toggle="modal" data-bs-target="#detalleModal{{ alimento.id_alimento }}"> {# Usar alimento.id_alimento para un ID único #}
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="modal fade" id="detalleModal{{ alimento.id_alimento }}" tabindex="-1" aria-labelledby="detalleModalLabel{{ alimento.id_alimento }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header background">
            <h5 class="modal-title" id="detalleModalLabel{{ alimento.id_alimento }}">
              <i class="fas fa-utensils me-2"></i>
              Detalle nutricional de {{ alimento.nombre_alimento }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="alimentoForm{{ alimento.id_alimento }}" class="editable-form" data-alimento-origen="{{ alimento.origen|default:'Personalizado' }}">
                <input type="hidden" id="alimentoId{{ alimento.id_alimento }}" name="id_alimento" value="{{ alimento.id_alimento }}" >
              {% csrf_token %}
              
              <fieldset class="info-basica-section mb-4">
                <legend class="section-title">Información del Alimento</legend>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nombre:</label>
                    <input type="text" class="form-control colorBg " name="nombre_alimento" value="{{ alimento.nombre_alimento }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Origen (ej: USDA, Envase):</label>
                    <input type="text" class="form-control" name="origen" value="{{ alimento.origen|default:'Personalizado' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Grupo:</label>
                              
                    <select class="form-select select-grupo-alimento-modal" name="id_grupo_alimenticio">
                        <option value="">Seleccione un grupo...</option>

                        {% for grupo_obj in grupos_modal %}
                            <option value="{{ grupo_obj.id_grupo_alimenticio }}"
                                        {% comment %}
                                        Ahora alimento.id_grupo_alimenticio existe y es un número (o None).
                                        grupo_obj.id_grupo_alimenticio también es un número.
                                        La comparación directa es más limpia si los tipos son consistentes.
                                        Si hay duda, stringformat es más seguro.
                                        {% endcomment %}
                                        {% if alimento.id_grupo_alimenticio is not None and grupo_obj.id_grupo_alimenticio == alimento.id_grupo_alimenticio %}
                                            selected
                                        {% endif %}>
                                {{ grupo_obj.descripcion }}
                            </option>
                        {% endfor %}

                        {% comment %}
                        Este bloque ahora solo se activará si alimento.id_grupo_alimenticio es None
                        Y alimento.nombre_grupo_alimenticio existe. Esto significa que el alimento
                        tiene un nombre de grupo que NO PUDO SER MAPEADO a un ID (un grupo "huérfano" o incorrecto).
                        {% endcomment %}
                        {% if alimento.id_grupo_alimenticio is None and alimento.nombre_grupo_alimenticio %}
                            <option value="" disabled selected style="font-style: italic;">
                                Grupo actual: {{ alimento.nombre_grupo_alimenticio }} (ID no encontrado o grupo no válido)
                            </option>
                        {% endif %}
                    </select>
            
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Medida (ej: tazas):</label>
                    <input type="text" class="form-control" name="medida" value="{{ alimento.medida|default:'taza' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">N° medidas por porción:</label>
                    <input type="number" step="0.01" class="form-control" name="numero_medida" value="{{ alimento.numero_medida|default:'1' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Masa (porción):</label>
                    <div class="input-group">
                      <input type="number" step="0.01" class="form-control" name="masa" value="{{ alimento.masa|default:'100' }}">
                      <span class="input-group-text">gr/ml</span>
                    </div>
                  </div>
                </div>
              </fieldset>
              
              <fieldset class="macronutrientes-section mb-4">
                <legend class="section-title">Macronutrientes (porción)</legend> 
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">Lípidos (g):</label>
                    <input type="number" step="0.01" class="form-control" name="lipidos_gr" value="{{ alimento.lipidos_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Proteínas (g):</label>
                    <input type="number" step="0.01" class="form-control" name="proteinas_gr" value="{{ alimento.proteinas_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Carbohidratos (g):</label>
                    <input type="number" step="0.01" class="form-control" name="carbohidratos_gr" value="{{ alimento.carbohidratos_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Calorías (kcal):</label>
                    <input type="number" step="0.01" class="form-control" name="kcal" value="{{ alimento.kcal|default_if_none:'0' }}">
                  </div>
                </div>
              </fieldset>
              
              <fieldset class="micronutrientes-section mb-4">
                <legend class="section-title">Micronutrientes (porción)</legend>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Omega 3 (g):</label>
                    <input type="number" step="0.01" class="form-control" name="n3_gr" value="{{ alimento.n3_gr|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Vitamina A (µg):</label>
                    <input type="number" step="0.01" class="form-control" name="vit_a_mcg" value="{{ alimento.vit_a_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Vitamina B12 (µg):</label>
                    <input type="number" step="0.01" class="form-control" name="vit_b12_mcg" value="{{ alimento.vit_b12_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Calcio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="calcio_mg" value="{{ alimento.calcio_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Hierro (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="hierro_mg" value="{{ alimento.hierro_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Selenio (µg):</label>
                    <input type="number" step="0.01" class="form-control" name="selenio_mcg" value="{{ alimento.selenio_mcg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Zinc (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="zinc_mg" value="{{ alimento.zinc_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Potasio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="potasio_mg" value="{{ alimento.potasio_mg|default_if_none:'0' }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Sodio (mg):</label>
                    <input type="number" step="0.01" class="form-control" name="sodio_mg" value="{{ alimento.sodio_mg|default_if_none:'0' }}">
                  </div>
                </div>
              </fieldset>
                        
              <div class="d-flex justify-content-end gap-2 mt-4 alimento-actions">
                <button type="button" class="btn btn-danger btn-eliminar-alimento" data-alimento-id="{{ alimento.id_alimento }}">
                  <i class="fas fa-trash-alt me-2"></i>Eliminar
                </button>
                <button type="submit" class="btn btn-primary btn-guardar">
                  <i class="fas fa-save me-2"></i>Guardar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="fas fa-times me-2"></i>Cerrar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <div class="pagination-container mt-4">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="First">
                        <span aria-hidden="true">««</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Previous">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}">{{ num }}</a></li>
                {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Next">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request_get_q %}&q={{ request_get_q }}{% endif %}{% if request_get_grupo %}&grupo={{ request_get_grupo }}{% endif %}" aria-label="Last">
                        <span aria-hidden="true">»»</span>
                    </a>
                </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% else %}
    <div class="alert alert-warning mt-3">No se pudieron cargar los alimentos o no se encontraron resultados. Por favor, intente más tarde o ajuste su búsqueda.</div>
  {% endif %}

  <div class="modal fade" id="agregarAlimentoModal" tabindex="-1" aria-labelledby="agregarAlimentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header background">
          <h5 class="modal-title" id="agregarAlimentoModalLabel">
            <i class="fas fa-plus-circle me-2"></i>
            Agregar Nuevo Alimento
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="nuevoAlimentoForm">
            {% csrf_token %}
            
            <fieldset class="info-basica-section mb-4">
              <legend class="section-title">Información Básica</legend>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">
                    Nombre del alimento: <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" name="nombre_alimento" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">
                    Grupo alimenticio: <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" name="id_grupo_alimenticio" required>
                    <option value="">Seleccionar grupo</option>
                    {% for grupo_obj in grupos_modal %} 
                      <option value="{{ grupo_obj.id_grupo_alimenticio }}">{{ grupo_obj.descripcion }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Origen (ej: USDA, Envase):</label>
                  <input type="text" class="form-control" name="origen" value="Personalizado">
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Medida (ej: tazas): <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" name="medida" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    N° medidas por porción: <span class="text-danger">*</span>
                  </label>
                  <input type="number" step="0.01" min="0" class="form-control" name="numero_medida" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">
                    Masa (total por porción): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="cantidad_porcion" required>
                    <span class="input-group-text">gr/ml</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <fieldset class="macronutrientes-section mb-4">
              <legend class="section-title">Macronutrientes (total por porción indicada)</legend>
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">
                    Energía (kcal): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.1" min="0" class="form-control" name="kcal" required>
                    <span class="input-group-text">kcal</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    Proteínas (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="proteinas_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    Lípidos (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="lipidos_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    Carbohidratos (g): <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="carbohidratos_gr" required>
                    <span class="input-group-text">g</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <fieldset class="micronutrientes-section mb-4">
              <legend class="section-title">Micronutrientes (opcionales, total por porción indicada)</legend>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Omega 3 (g):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="omega_gr">
                    <span class="input-group-text">g</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Vitamina A (µg RE):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="vitamina_a_mcg">
                    <span class="input-group-text">µg RE</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Vitamina B12 (µg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="vitamina_b12_mcg">
                    <span class="input-group-text">µg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Calcio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="calcio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hierro (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="hierro_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Selenio (µg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="selenio_mcg">
                    <span class="input-group-text">µg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Zinc (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="zinc_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Potasio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="potasio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Sodio (mg):</label>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" class="form-control" name="sodio_mg">
                    <span class="input-group-text">mg</span>
                  </div>
                </div>
              </div>
            </fieldset>
            
            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Guardar Alimento
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div> <script>
document.addEventListener('DOMContentLoaded', function () {
    const API_GRUPOS_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/obtener_grupos_alimenticios_con_id';
    // URL para CREAR nuevos alimentos (POST)
    const API_CREAR_ALIMENTO_URL = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/guardar_alimento';
    // URL BASE para ACTUALIZAR alimentos existentes (PUT)
    const API_ACTUALIZAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/actualizar_alimento/';
    // URL BASE para ELIMINAR alimentos existentes (DELETE)
    const API_ELIMINAR_ALIMENTO_URL_BASE = 'https://nutrilinkapi-production.up.railway.app/api_nutrilink/alimento/eliminar_alimento/';
    
    let todosLosGruposAlimenticiosAPI = [];

    async function cargarGruposDesdeAPI() {
        try {
            const response = await fetch(API_GRUPOS_URL);
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status} al cargar grupos.`);
            }
            todosLosGruposAlimenticiosAPI = await response.json();

            if (!todosLosGruposAlimenticiosAPI || todosLosGruposAlimenticiosAPI.length === 0) {
                console.warn('No se recibieron grupos alimenticios de la API o la lista está vacía.');
                return;
            }
            
            // Poblar select en el modal de "Nuevo Alimento" (ya se hace con Django, pero esto es un ejemplo si fuera dinámico)
            // const nuevoGrupoSelect = document.querySelector('#agregarAlimentoModal select[name="id_grupo_alimenticio"]');
            // if (nuevoGrupoSelect && nuevoGrupoSelect.options.length <=1) { // Solo si no está ya poblado por Django
            //     // Lógica para poblarlo...
            // }

        } catch (error) {
            console.error('Error al cargar grupos alimenticios desde API:', error);
        }
    }


    // --- MANEJAR EL GUARDADO (ACTUALIZACIÓN) DE ALIMENTOS EDITADOS ---
    document.querySelectorAll('.editable-form').forEach(form => {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const alimentoIdInput = form.querySelector('input[name="id_alimento"]');
            if (!alimentoIdInput || !alimentoIdInput.value) {
                console.error("No se encontró el ID del alimento en el formulario.");
                Swal.fire('Error Interno', 'No se pudo identificar el alimento a guardar.', 'error');
                return;
            }
            const alimentoId = alimentoIdInput.value;

            // Obtener el ID del nutricionista
            let id_nutricionista = sessionStorage.getItem('id_nutricionista');
            if (!id_nutricionista) {
                Swal.fire('Error', 'No se pudo identificar al nutricionista. Por favor, inicie sesión nuevamente.', 'error');
                return;
            }

            // Construir la URL completa para la actualización
            const urlActualizar = API_ACTUALIZAR_ALIMENTO_URL_BASE + alimentoId;

            const submitButton = form.querySelector('.btn-guardar');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

            const formData = new FormData(form);
            const csrfToken = formData.get('csrfmiddlewaretoken');

            const parseFloatOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseFloat(value);
                return isNaN(num) ? null : num;
            };
            
            const parseIntOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseInt(value, 10);
                return isNaN(num) ? null : num;
            };

            const data = {
                nombre_alimento: formData.get('nombre_alimento'),
                origen: formData.get('origen'),
                id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
                medida: formData.get('medida'),
                numero_medida: parseFloatOrNull(formData.get('numero_medida')),
                masa: parseFloatOrNull(formData.get('masa')),
                kcal: parseFloatOrNull(formData.get('kcal')),
                proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
                carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
                lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
                n3_gr: parseFloatOrNull(formData.get('n3_gr')),
                vit_a_mcg: parseFloatOrNull(formData.get('vit_a_mcg')),
                vit_b12_mcg: parseFloatOrNull(formData.get('vit_b12_mcg')),
                calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
                hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
                selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
                zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
                potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
                sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
                id_nutricionista: id_nutricionista // Añadimos el ID del nutricionista
            };

            console.log("Enviando datos para actualizar a:", urlActualizar, " Payload:", data);

            try {
                const response = await fetch(urlActualizar, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Actualizado!',
                        text: 'Alimento actualizado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    const modalElement = form.closest('.modal');
                    if (modalElement) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    
                    setTimeout(() => {
                        location.reload(); 
                    }, 1500);

                } else {
                    let errorMessage = 'Error al actualizar el alimento.';
                    if (result && result.mensaje) {
                        errorMessage = result.mensaje;
                    } else if (result && result.errors) {
                        errorMessage += '<br>' + Object.values(result.errors).join('<br>');
                    }
                    Swal.fire('Error', errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error al enviar la solicitud de actualización:', error);
                Swal.fire('Error de Conexión', 'No se pudo conectar con el servidor para actualizar el alimento.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
    });

    // --- MANEJAR EL AGREGADO DE NUEVOS ALIMENTOS ---
    const nuevoAlimentoForm = document.getElementById('nuevoAlimentoForm');
    if (nuevoAlimentoForm) {
        nuevoAlimentoForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Obtener el ID del nutricionista
           let id_nutricionista = sessionStorage.getItem('id_nutricionista');
            if (!id_nutricionista) {
                Swal.fire('Error', 'No se pudo identificar al nutricionista. Por favor, inicie sesión nuevamente.', 'error');
                return;
            }

            const submitButton = nuevoAlimentoForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';

            const formData = new FormData(nuevoAlimentoForm);
            const csrfToken = formData.get('csrfmiddlewaretoken');

            const parseFloatOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseFloat(value);
                return isNaN(num) ? null : num;
            };
            
            const parseIntOrNull = (value) => {
                if (value === null || String(value).trim() === '') return null;
                const num = parseInt(value, 10);
                return isNaN(num) ? null : num;
            };

            const data = {
                nombre_alimento: formData.get('nombre_alimento'),
                origen: formData.get('origen') || 'Personalizado',
                id_grupo_alimenticio: parseIntOrNull(formData.get('id_grupo_alimenticio')),
                medida: formData.get('medida'),
                numero_medida: parseFloatOrNull(formData.get('numero_medida')),
                masa: parseFloatOrNull(formData.get('cantidad_porcion')), // 'cantidad_porcion' en el form de nuevo alimento
                kcal: parseFloatOrNull(formData.get('kcal')),
                proteinas_gr: parseFloatOrNull(formData.get('proteinas_gr')),
                carbohidratos_gr: parseFloatOrNull(formData.get('carbohidratos_gr')),
                lipidos_gr: parseFloatOrNull(formData.get('lipidos_gr')),
                n3_gr: parseFloatOrNull(formData.get('omega_gr')), // 'omega_gr' en el form de nuevo alimento
                vit_a_mcg: parseFloatOrNull(formData.get('vitamina_a_mcg')), // 'vitamina_a_mcg' en el form de nuevo alimento
                vit_b12_mcg: parseFloatOrNull(formData.get('vitamina_b12_mcg')), // 'vitamina_b12_mcg' en el form de nuevo alimento
                calcio_mg: parseFloatOrNull(formData.get('calcio_mg')),
                hierro_mg: parseFloatOrNull(formData.get('hierro_mg')),
                selenio_mcg: parseFloatOrNull(formData.get('selenio_mcg')),
                zinc_mg: parseFloatOrNull(formData.get('zinc_mg')),
                potasio_mg: parseFloatOrNull(formData.get('potasio_mg')),
                sodio_mg: parseFloatOrNull(formData.get('sodio_mg')),
                id_nutricionista: id_nutricionista // Añadimos el ID del nutricionista
            };

            console.log("Enviando datos para crear nuevo alimento:", API_CREAR_ALIMENTO_URL, " Payload:", data);

            try {
                const response = await fetch(API_CREAR_ALIMENTO_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Creado!',
                        text: result.mensaje || 'Alimento agregado correctamente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    const modalElement = nuevoAlimentoForm.closest('.modal');
                    if (modalElement) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    
                    setTimeout(() => {
                        location.reload(); 
                    }, 1500);

                } else {
                    let errorMessage = 'Error al agregar el alimento.';
                    if (result && result.mensaje) {
                        errorMessage = result.mensaje;
                    } else if (result && result.errors) {
                        errorMessage += '<br>' + Object.values(result.errors).join('<br>');
                    }
                    Swal.fire('Error', errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error al enviar la solicitud de creación:', error);
                Swal.fire('Error de Conexión', 'No se pudo conectar con el servidor para agregar el alimento.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
      }

    // --- MANEJAR LA ELIMINACIÓN DE ALIMENTOS ---
    document.querySelectorAll('.btn-eliminar-alimento').forEach(button => {
        button.addEventListener('click', async function() {
            const alimentoId = this.dataset.alimentoId;
            const urlEliminar = API_ELIMINAR_ALIMENTO_URL_BASE + alimentoId;
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo!',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(urlEliminar, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            }
                        });

                        const resultData = await response.json();

                        if (response.ok && resultData.status === "success") {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Eliminado!',
                                text: 'Alimento eliminado correctamente.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            
                            const modalElement = this.closest('.modal');
                            if (modalElement) {
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) {
                                    modalInstance.hide();
                                }
                            }
                            
                            setTimeout(() => {
                                location.reload(); 
                            }, 1500);

                        } else {
                            Swal.fire('Error', resultData.mensaje || 'No se pudo eliminar el alimento.', 'error');
                        }
                    } catch (error) {
                        console.error('Error al enviar la solicitud de eliminación:', error);
                        Swal.fire('Error de Conexión', 'No se pudo conectar con el servidor para eliminar el alimento.', 'error');
                    }
                }
            });
        });
    });

    // --- LÓGICA PARA HACER READONLY Y OCULTAR BOTONES PARA ALIMENTOS USDA ---
  document.querySelectorAll('.modal').forEach(modalElement => {
      modalElement.addEventListener('show.bs.modal', function (event) {
          const form = modalElement.querySelector('.editable-form');
          if (!form) return;

          const alimentoOrigen = form.dataset.alimentoOrigen;
          const isUSDA = alimentoOrigen && alimentoOrigen.toLowerCase().includes('usda');

          const formControls = form.querySelectorAll('input, select');
          
          // Si es un alimento USDA, hacer los campos readonly/disabled
          if (isUSDA) {
              formControls.forEach(control => {
                  control.setAttribute('readonly', 'readonly');
                  if (control.tagName === 'SELECT') {
                      control.setAttribute('disabled', 'disabled');
                  }
                  control.classList.remove('colorBg'); 
              });

              // Ocultar los botones de Guardar y Eliminar
              const saveButton = form.querySelector('.btn-guardar');
              const deleteButton = form.querySelector('.btn-eliminar-alimento');
              
              if (saveButton) saveButton.style.display = 'none';
              if (deleteButton) deleteButton.style.display = 'none';
          } else {
              // Si no es USDA (es personalizado), asegurarse de que los campos sean editables
              formControls.forEach(control => {
                  control.removeAttribute('readonly');
                  if (control.tagName === 'SELECT') {
                      control.removeAttribute('disabled');
                  }
                  if (control.getAttribute('name') === 'nombre_alimento') {
                      control.classList.add('colorBg'); 
                  }
              });

              const saveButton = form.querySelector('.btn-guardar');
              const deleteButton = form.querySelector('.btn-eliminar-alimento');
              
              if (saveButton) saveButton.style.display = 'block';
              if (deleteButton) deleteButton.style.display = 'block';
          }
      });
  });

    
});
</script>
{% endblock %}